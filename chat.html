<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Live Chat | Web Tools Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; overflow: hidden; }
        
        /* Chat Background Pattern */
        .chat-bg {
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
            background-color: #0f172a;
            background-blend-mode: overlay;
        }

        /* Message Animations */
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.95) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .msg-bubble { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* Custom Scrollbar for Chat */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        
        .glass-header { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-footer { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden selection:bg-pink-500/30">

    <!-- 1. Name Registration Modal -->
    <div id="join-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md transition-opacity">
        <div class="bg-slate-900 border border-white/10 p-8 rounded-[2rem] w-full max-w-sm shadow-[0_0_50px_rgba(236,72,153,0.15)] text-center transform scale-100 transition-transform">
            <div class="w-20 h-20 bg-gradient-to-tr from-pink-500 to-purple-500 rounded-full flex items-center justify-center mb-6 mx-auto shadow-lg">
                <i class="fa-solid fa-bolt-lightning text-3xl text-white"></i>
            </div>
            <h2 class="text-2xl font-black mb-2 text-white tracking-tight">Global Chat</h2>
            <p class="text-slate-400 text-sm mb-6">Chat-e jog dite apnar nam likhun</p>
            
            <form id="join-form" class="space-y-4">
                <input type="text" id="username-input" required autocomplete="off"
                    class="w-full bg-black/50 border border-white/10 rounded-2xl p-4 text-white text-center focus:outline-none focus:border-pink-500 transition-all font-bold placeholder-slate-600" 
                    placeholder="Apnar Nam...">
                <button type="submit" 
                    class="w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 py-4 rounded-2xl text-white font-black uppercase tracking-widest transition-all shadow-lg shadow-pink-600/20 active:scale-95">
                    Enter Chat
                </button>
            </form>
            <div class="mt-4">
                <a href="index.html" class="text-xs text-slate-500 hover:text-white underline transition-colors">Back to Home</a>
            </div>
        </div>
    </div>

    <!-- 2. Main Chat App Container -->
    <div id="chat-app" class="hidden flex-col h-screen w-full max-w-4xl mx-auto relative bg-slate-950 shadow-2xl border-x border-white/5">
        
        <!-- Chat Header -->
        <header class="glass-header p-4 flex items-center justify-between z-20 shrink-0">
            <div class="flex items-center gap-4">
                <a href="index.html" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/10 transition-colors text-slate-300 border border-white/5">
                    <i class="fa-solid fa-arrow-left"></i>
                </a>
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-10 h-10 bg-gradient-to-r from-pink-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold">
                            <i class="fa-solid fa-globe"></i>
                        </div>
                        <span class="absolute bottom-0 right-0 w-3 h-3 bg-emerald-500 border-2 border-slate-900 rounded-full"></span>
                    </div>
                    <div>
                        <h1 class="font-bold text-white leading-tight">Public Lounge</h1>
                        <p class="text-[10px] text-emerald-400 font-medium">Online & Synced</p>
                    </div>
                </div>
            </div>
            <button onclick="changeName()" class="text-xs text-slate-400 hover:text-white bg-white/5 px-3 py-1.5 rounded-full border border-white/5 transition-colors">
                <i class="fa-solid fa-user-pen mr-1"></i> Edit Name
            </button>
        </header>

        <!-- Chat Messages Area -->
        <main id="chat-box" class="flex-grow chat-bg overflow-y-auto p-4 md:p-6 flex flex-col gap-4 custom-scroll relative z-10">
            
            <div class="text-center my-4">
                <span class="bg-slate-800/80 text-slate-400 text-[10px] px-3 py-1 rounded-full border border-white/5 uppercase tracking-widest font-bold backdrop-blur-sm">
                    Welcome to Global Chat
                </span>
            </div>

            <div id="loading-msgs" class="flex justify-center items-center py-10">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500"></div>
            </div>

            <!-- Messages injected here -->
            
        </main>

        <!-- Chat Input Footer -->
        <footer class="glass-footer p-3 z-20 shrink-0 flex flex-col">
            
            <!-- ðŸ”¥ File Preview Box (Hidden by default) -->
            <div id="file-preview-container" class="hidden w-full max-w-4xl mx-auto px-1 mb-2">
                <div class="bg-slate-800/80 border border-white/10 rounded-xl p-2.5 flex items-center justify-between">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded bg-pink-500/20 text-pink-400 flex items-center justify-center shrink-0 border border-pink-500/30">
                            <i id="preview-icon" class="fa-solid fa-file"></i>
                        </div>
                        <div class="overflow-hidden">
                            <p id="file-preview-name" class="text-xs font-bold text-white truncate w-48 md:w-64">filename.pdf</p>
                            <p id="file-preview-size" class="text-[9px] text-slate-400 uppercase tracking-widest">0 MB</p>
                        </div>
                    </div>
                    <button type="button" onclick="clearFile()" class="text-slate-400 hover:text-red-400 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/5 transition-colors">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
            </div>

            <form id="chat-form" class="flex items-end gap-2 max-w-4xl mx-auto w-full">
                
                <!-- ðŸ”¥ Attachment Button -->
                <button type="button" onclick="document.getElementById('file-input').click()" class="w-12 h-12 shrink-0 text-slate-400 hover:text-pink-400 bg-slate-800/80 rounded-2xl flex items-center justify-center transition-all border border-white/10 hover:border-pink-500/50 self-end mb-0.5">
                    <i class="fa-solid fa-paperclip text-lg"></i>
                </button>
                <input type="file" id="file-input" class="hidden" accept="image/*,.pdf,.txt,.html,.docx,.zip,.rar">

                <div class="flex-grow bg-slate-800/80 border border-white/10 rounded-2xl flex items-center px-2 py-1 transition-all focus-within:border-pink-500/50">
                    <textarea id="msg-input" rows="1" placeholder="Type a message..."
                        class="w-full bg-transparent p-3 text-sm text-white focus:outline-none resize-none max-h-32 custom-scroll" style="min-height: 44px;"></textarea>
                </div>
                
                <button type="submit" id="send-btn" disabled
                    class="w-12 h-12 shrink-0 bg-gradient-to-br from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 rounded-2xl flex items-center justify-center text-white shadow-lg transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed self-end mb-0.5">
                    <i class="fa-solid fa-paper-plane text-lg ml-[-2px]"></i>
                </button>
            </form>
        </footer>
    </div>

    <!-- Firebase & Chat Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // ðŸ”¥ Storage Import for File Upload
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDGd3KAo45UuqmeGFALziz_oKm3htEASHY",
            authDomain: "mywebtools-f8d53.firebaseapp.com",
            projectId: "mywebtools-f8d53",
            storageBucket: "mywebtools-f8d53.firebasestorage.app",
            messagingSenderId: "979594414301",
            appId: "1:979594414301:web:7048c995e56e331a85f334"
        };

        const SYNC_APP_ID = "rasel-mia-universal-sync";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app); // Storage Init

        let myUsername = localStorage.getItem('chat_username') || '';
        let selectedFile = null; // To hold the attached file

        const joinModal = document.getElementById('join-modal');
        const chatApp = document.getElementById('chat-app');
        const joinForm = document.getElementById('join-form');
        const usernameInput = document.getElementById('username-input');
        
        const chatBox = document.getElementById('chat-box');
        const chatForm = document.getElementById('chat-form');
        const msgInput = document.getElementById('msg-input');
        const sendBtn = document.getElementById('send-btn');
        const loadingMsgs = document.getElementById('loading-msgs');
        
        const fileInput = document.getElementById('file-input');
        const previewContainer = document.getElementById('file-preview-container');
        const previewName = document.getElementById('file-preview-name');
        const previewSize = document.getElementById('file-preview-size');
        const previewIcon = document.getElementById('preview-icon');

        if (myUsername) startChatApp();
        else joinModal.classList.remove('hidden');

        joinForm.onsubmit = (e) => {
            e.preventDefault();
            const name = usernameInput.value.trim();
            if (name) {
                myUsername = name;
                localStorage.setItem('chat_username', myUsername);
                joinModal.classList.add('hidden');
                startChatApp();
            }
        };

        window.changeName = () => {
            joinModal.classList.remove('hidden');
            usernameInput.value = myUsername;
        };

        // UI Updates for Input & Send Button
        function updateSendButtonState() {
            sendBtn.disabled = msgInput.value.trim() === '' && !selectedFile;
        }

        msgInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight < 120 ? this.scrollHeight : 120) + 'px';
            updateSendButtonState();
        });
        
        msgInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if(!sendBtn.disabled) chatForm.dispatchEvent(new Event('submit'));
            }
        });

        // ðŸ”¥ File Selection Logic
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // Check Size (Limit to 5MB for fast loading)
                if (file.size > 5 * 1024 * 1024) {
                    alert("Doyakore 5MB er choto file select korun.");
                    fileInput.value = '';
                    return;
                }
                
                selectedFile = file;
                previewName.innerText = file.name;
                previewSize.innerText = (file.size / 1024 / 1024).toFixed(2) + " MB";
                
                // Icon Change based on file type
                previewIcon.className = 'fa-solid ' + getIconClass(file.name, file.type);
                
                previewContainer.classList.remove('hidden');
                updateSendButtonState();
            }
        });

        window.clearFile = () => {
            selectedFile = null;
            fileInput.value = '';
            previewContainer.classList.add('hidden');
            updateSendButtonState();
        }

        // Helper for File Icons
        function getIconClass(name, type) {
            if (type.startsWith('image/')) return 'fa-image text-emerald-400';
            if (name.endsWith('.pdf')) return 'fa-file-pdf text-red-400';
            if (name.endsWith('.html')) return 'fa-file-code text-orange-400';
            if (name.endsWith('.txt')) return 'fa-file-lines text-slate-300';
            if (name.endsWith('.zip') || name.endsWith('.rar')) return 'fa-file-zipper text-yellow-400';
            return 'fa-file text-pink-400';
        }

        async function startChatApp() {
            chatApp.classList.remove('hidden');
            chatApp.classList.add('flex');
            try {
                await signInAnonymously(auth);
                listenForMessages();
            } catch (error) {
                console.error("Auth Error:", error);
                alert("Connection failed.");
            }
        }

        // ðŸ”¥ Send Message with File
        chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const text = msgInput.value.trim();
            
            if (!text && !selectedFile) return;

            // UI Loading State
            const originalInputHeight = msgInput.style.height;
            msgInput.style.height = '44px';
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            const timeNow = Date.now();
            const dateStr = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

            try {
                let fileUrl = null;
                let fileName = null;
                let fileType = null;

                // File thakle aage upload korbe
                if (selectedFile) {
                    // Unique name jate override na hoy
                    const filePath = `artifacts/${SYNC_APP_ID}/public/data/chat_files/${timeNow}_${selectedFile.name}`;
                    const storageRef = ref(storage, filePath);
                    
                    await uploadBytesResumable(storageRef, selectedFile);
                    fileUrl = await getDownloadURL(storageRef);
                    fileName = selectedFile.name;
                    fileType = selectedFile.type;
                }

                // Database e message push kora
                const messagesRef = collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'global_messages');
                await addDoc(messagesRef, {
                    text: text,
                    sender: myUsername,
                    timestamp: timeNow,
                    timeString: dateStr,
                    fileUrl: fileUrl,
                    fileName: fileName,
                    fileType: fileType
                });

                // Reset
                msgInput.value = '';
                clearFile();

            } catch (error) {
                console.error("Error sending message:", error);
                alert("Failed to send message/file.");
                msgInput.style.height = originalInputHeight;
            } finally {
                sendBtn.innerHTML = '<i class="fa-solid fa-paper-plane text-lg ml-[-2px]"></i>';
                updateSendButtonState();
            }
        };

        function listenForMessages() {
            const messagesRef = collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'global_messages');
            const q = query(messagesRef, orderBy('timestamp', 'asc'), limit(100));

            onSnapshot(q, (snapshot) => {
                if (loadingMsgs) loadingMsgs.style.display = 'none';

                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        appendMessageToUI(change.doc.data());
                    }
                });
                scrollToBottom();
            });
        }

        // ðŸ”¥ UI Render Function (Supports Files & Images)
        function appendMessageToUI(data) {
            const isMe = data.sender === myUsername;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg-bubble flex flex-col max-w-[85%] md:max-w-[70%] ${isMe ? 'self-end items-end' : 'self-start items-start'}`;

            const nameHtml = !isMe ? `<span class="text-[10px] text-slate-400 ml-1 mb-1 font-bold tracking-wide">${data.sender}</span>` : '';
            const bubbleClasses = isMe 
                ? 'bg-gradient-to-br from-pink-600 to-purple-600 text-white rounded-2xl rounded-br-sm' 
                : 'bg-slate-800 border border-white/5 text-slate-200 rounded-2xl rounded-bl-sm';

            let contentHtml = '';

            // 1. Jodi File/Image thake
            if (data.fileUrl) {
                if (data.fileType && data.fileType.startsWith('image/')) {
                    // Image Preview
                    contentHtml += `
                        <a href="${data.fileUrl}" target="_blank" class="block mb-2 overflow-hidden rounded-xl border border-white/10 hover:opacity-90 transition-opacity bg-black/20">
                            <img src="${data.fileUrl}" alt="Attached Image" class="max-w-full h-auto max-h-48 object-cover">
                        </a>`;
                } else {
                    // File Box (PDF, TXT, HTML etc)
                    const iconStyle = getIconClass(data.fileName, data.fileType || '');
                    contentHtml += `
                        <a href="${data.fileUrl}" target="_blank" class="flex items-center gap-3 bg-black/30 p-3 rounded-xl mb-2 hover:bg-black/50 transition-colors border border-white/10 group cursor-pointer w-full">
                            <div class="w-10 h-10 rounded bg-white/5 flex items-center justify-center shrink-0 border border-white/5">
                                <i class="fa-solid ${iconStyle} text-2xl"></i>
                            </div>
                            <div class="overflow-hidden flex-grow">
                                <p class="text-xs font-bold truncate text-white group-hover:text-pink-300 transition-colors" title="${data.fileName}">${data.fileName}</p>
                                <p class="text-[9px] text-slate-300 uppercase tracking-widest mt-0.5"><i class="fa-solid fa-download mr-1"></i> Download</p>
                            </div>
                        </a>`;
                }
            }

            // 2. Jodi Text thake
            if (data.text) {
                contentHtml += `<p class="text-sm whitespace-pre-wrap leading-relaxed pb-3 px-1">${escapeHTML(data.text)}</p>`;
            } else if (!data.text && data.fileUrl) {
                // Shudhu file dile bottom space thik rakhar jonno
                contentHtml += `<div class="pb-3"></div>`; 
            }

            msgDiv.innerHTML = `
                ${nameHtml}
                <div class="${bubbleClasses} p-2 md:p-3 shadow-md relative group min-w-[120px]">
                    ${contentHtml}
                    <span class="text-[9px] ${isMe ? 'text-pink-200' : 'text-slate-500'} absolute bottom-1.5 right-3 font-medium bg-black/20 px-1.5 py-0.5 rounded-md backdrop-blur-sm">
                        ${data.timeString || 'Just now'} ${isMe ? '<i class="fa-solid fa-check-double ml-1 opacity-70"></i>' : ''}
                    </span>
                </div>
            `;

            chatBox.appendChild(msgDiv);
        }

        function scrollToBottom() {
            // setTimeout used to let images render layout space before scrolling
            setTimeout(() => { chatBox.scrollTop = chatBox.scrollHeight; }, 100);
        }

        function escapeHTML(str) {
            return str.replace(/[&<>'"]/g, 
                tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag] || tag)
            );
        }
    </script>
</body>
</html>
