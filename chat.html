<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Live Chat | Web Tools Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; overflow: hidden; }
        
        /* Chat Background Pattern */
        .chat-bg {
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
            background-color: #0f172a;
            background-blend-mode: overlay;
        }

        /* Message Animations */
        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.95) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .msg-bubble { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* Custom Scrollbar for Chat */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        
        .glass-header { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-footer { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden selection:bg-pink-500/30">

    <!-- 1. Name Registration Modal (Prothom barer jonno) -->
    <!-- ðŸ”¥ Fix: Modal ekhon default bhabe hidden thakbe jate save thaka user der ke na dekhay -->
    <div id="join-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md transition-opacity">
        <div class="bg-slate-900 border border-white/10 p-8 rounded-[2rem] w-full max-w-sm shadow-[0_0_50px_rgba(236,72,153,0.15)] text-center transform scale-100 transition-transform">
            <div class="w-20 h-20 bg-gradient-to-tr from-pink-500 to-purple-500 rounded-full flex items-center justify-center mb-6 mx-auto shadow-lg">
                <i class="fa-solid fa-bolt-lightning text-3xl text-white"></i>
            </div>
            <h2 class="text-2xl font-black mb-2 text-white tracking-tight">Global Chat</h2>
            <p class="text-slate-400 text-sm mb-6">Chat-e jog dite apnar nam likhun</p>
            
            <form id="join-form" class="space-y-4">
                <input type="text" id="username-input" required autocomplete="off"
                    class="w-full bg-black/50 border border-white/10 rounded-2xl p-4 text-white text-center focus:outline-none focus:border-pink-500 transition-all font-bold placeholder-slate-600" 
                    placeholder="Apnar Nam...">
                <button type="submit" 
                    class="w-full bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 py-4 rounded-2xl text-white font-black uppercase tracking-widest transition-all shadow-lg shadow-pink-600/20 active:scale-95">
                    Enter Chat
                </button>
            </form>
            <div class="mt-4">
                <a href="index.html" class="text-xs text-slate-500 hover:text-white underline transition-colors">Back to Home</a>
            </div>
        </div>
    </div>

    <!-- 2. Main Chat App Container -->
    <div id="chat-app" class="hidden flex-col h-screen w-full max-w-4xl mx-auto relative bg-slate-950 shadow-2xl border-x border-white/5">
        
        <!-- Chat Header -->
        <header class="glass-header p-4 flex items-center justify-between z-20 shrink-0">
            <div class="flex items-center gap-4">
                <a href="index.html" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/10 transition-colors text-slate-300">
                    <i class="fa-solid fa-arrow-left"></i>
                </a>
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-10 h-10 bg-gradient-to-r from-pink-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold">
                            <i class="fa-solid fa-globe"></i>
                        </div>
                        <span class="absolute bottom-0 right-0 w-3 h-3 bg-emerald-500 border-2 border-slate-900 rounded-full"></span>
                    </div>
                    <div>
                        <h1 class="font-bold text-white leading-tight">Public Lounge</h1>
                        <p class="text-[10px] text-emerald-400 font-medium">Online & Synced</p>
                    </div>
                </div>
            </div>
            <button onclick="changeName()" class="text-xs text-slate-400 hover:text-white bg-white/5 px-3 py-1.5 rounded-full border border-white/5 transition-colors">
                <i class="fa-solid fa-user-pen mr-1"></i> Edit Name
            </button>
        </header>

        <!-- Chat Messages Area -->
        <main id="chat-box" class="flex-grow chat-bg overflow-y-auto p-4 md:p-6 flex flex-col gap-4 custom-scroll relative z-10">
            
            <div class="text-center my-4">
                <span class="bg-slate-800/80 text-slate-400 text-[10px] px-3 py-1 rounded-full border border-white/5 uppercase tracking-widest font-bold backdrop-blur-sm">
                    Welcome to Global Chat
                </span>
            </div>

            <div id="loading-msgs" class="flex justify-center items-center py-10">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500"></div>
            </div>

            <!-- Messages will be injected here via JS -->
            
        </main>

        <!-- Chat Input Footer -->
        <footer class="glass-footer p-4 z-20 shrink-0">
            <form id="chat-form" class="flex items-end gap-2 max-w-4xl mx-auto">
                <div class="flex-grow bg-slate-800/80 border border-white/10 rounded-2xl flex items-center px-2 py-1 transition-all focus-within:border-pink-500/50">
                    <textarea id="msg-input" rows="1" required placeholder="Type a message..."
                        class="w-full bg-transparent p-3 text-sm text-white focus:outline-none resize-none max-h-32 custom-scroll" style="min-height: 44px;"></textarea>
                </div>
                
                <button type="submit" id="send-btn" disabled
                    class="w-12 h-12 shrink-0 bg-gradient-to-br from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 rounded-full flex items-center justify-center text-white shadow-lg transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fa-solid fa-paper-plane text-lg ml-[-2px]"></i>
                </button>
            </form>
        </footer>
    </div>

    <!-- Firebase & Chat Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ðŸ”¥ Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDGd3KAo45UuqmeGFALziz_oKm3htEASHY",
            authDomain: "mywebtools-f8d53.firebaseapp.com",
            projectId: "mywebtools-f8d53",
            storageBucket: "mywebtools-f8d53.firebasestorage.app",
            messagingSenderId: "979594414301",
            appId: "1:979594414301:web:7048c995e56e331a85f334"
        };

        const SYNC_APP_ID = "rasel-mia-universal-sync";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Variables
        let myUsername = localStorage.getItem('chat_username') || '';
        const joinModal = document.getElementById('join-modal');
        const chatApp = document.getElementById('chat-app');
        const joinForm = document.getElementById('join-form');
        const usernameInput = document.getElementById('username-input');
        
        const chatBox = document.getElementById('chat-box');
        const chatForm = document.getElementById('chat-form');
        const msgInput = document.getElementById('msg-input');
        const sendBtn = document.getElementById('send-btn');
        const loadingMsgs = document.getElementById('loading-msgs');

        // 1. Initialize App Flow
        if (myUsername) {
            // Jodi nam save thake tahole sorasori chat e dhukbe
            startChatApp();
        } else {
            // Jodi nam save na thake, modal dekhabe
            joinModal.classList.remove('hidden');
        }

        joinForm.onsubmit = (e) => {
            e.preventDefault();
            const name = usernameInput.value.trim();
            if (name) {
                myUsername = name;
                localStorage.setItem('chat_username', myUsername); // Name saved permanently
                joinModal.classList.add('hidden');
                startChatApp();
            }
        };

        window.changeName = () => {
            joinModal.classList.remove('hidden');
            usernameInput.value = myUsername;
        };

        // Auto-resize textarea logic
        msgInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight < 120 ? this.scrollHeight : 120) + 'px';
            sendBtn.disabled = this.value.trim() === '';
        });
        
        // Enter key to send (Shift+Enter for new line)
        msgInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if(msgInput.value.trim() !== '') chatForm.dispatchEvent(new Event('submit'));
            }
        });

        // 2. Main Chat Logic
        async function startChatApp() {
            chatApp.classList.remove('hidden');
            chatApp.classList.add('flex');
            
            try {
                await signInAnonymously(auth);
                listenForMessages();
            } catch (error) {
                console.error("Auth Error:", error);
                alert("Connection failed. Check network.");
            }
        }

        // Send Message
        chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const text = msgInput.value.trim();
            if (!text) return;

            msgInput.value = '';
            msgInput.style.height = '44px';
            sendBtn.disabled = true;

            const timeNow = Date.now();
            const dateStr = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

            try {
                const messagesRef = collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'global_messages');
                await addDoc(messagesRef, {
                    text: text,
                    sender: myUsername,
                    timestamp: timeNow,
                    timeString: dateStr
                });
            } catch (error) {
                console.error("Error sending message:", error);
                alert("Failed to send message.");
            }
        };

        // Real-time Listener using docChanges for smooth UI
        function listenForMessages() {
            const messagesRef = collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'global_messages');
            // Query: order by time, limit to last 100 messages so it doesn't overload
            const q = query(messagesRef, orderBy('timestamp', 'asc'), limit(100));

            onSnapshot(q, (snapshot) => {
                if (loadingMsgs) loadingMsgs.style.display = 'none';

                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        appendMessageToUI(change.doc.data());
                    }
                });
                scrollToBottom();
            });
        }

        // UI Render Function
        function appendMessageToUI(data) {
            const isMe = data.sender === myUsername;
            
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg-bubble flex flex-col max-w-[80%] md:max-w-[70%] ${isMe ? 'self-end items-end' : 'self-start items-start'}`;

            // Name label (only show for others)
            const nameHtml = !isMe ? `<span class="text-[10px] text-slate-400 ml-1 mb-1 font-bold tracking-wide">${data.sender}</span>` : '';

            // Bubble styling
            const bubbleClasses = isMe 
                ? 'bg-gradient-to-br from-pink-600 to-purple-600 text-white rounded-2xl rounded-br-sm' 
                : 'bg-slate-800 border border-white/5 text-slate-200 rounded-2xl rounded-bl-sm';

            msgDiv.innerHTML = `
                ${nameHtml}
                <div class="${bubbleClasses} px-4 py-2.5 shadow-md relative group min-w-[100px]">
                    <p class="text-sm whitespace-pre-wrap leading-relaxed pb-3">${escapeHTML(data.text)}</p>
                    <span class="text-[9px] ${isMe ? 'text-pink-200' : 'text-slate-500'} absolute bottom-1 right-3 font-medium">
                        ${data.timeString || 'Just now'} ${isMe ? '<i class="fa-solid fa-check-double ml-1 opacity-70"></i>' : ''}
                    </span>
                </div>
            `;

            chatBox.appendChild(msgDiv);
        }

        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Security helper
        function escapeHTML(str) {
            return str.replace(/[&<>'"]/g, 
                tag => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    "'": '&#39;',
                    '"': '&quot;'
                }[tag] || tag)
            );
        }

    </script>
</body>
</html>
