<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Global Live Chat | Web Tools Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #020617; 
            color: #f8fafc; 
            overflow: hidden; 
            height: 100dvh; 
            width: 100vw;
            position: fixed; 
        }
        
        .chat-bg {
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
            background-color: #0f172a;
            background-blend-mode: overlay;
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.95) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .msg-bubble { animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 10px; }
        
        .glass-header { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-top: max(1rem, env(safe-area-inset-top)); }
        .glass-footer { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); border-top: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: max(0.75rem, env(safe-area-inset-bottom)); }
        
        textarea { font-size: 16px !important; }
    </style>
</head>
<body class="flex flex-col selection:bg-pink-500/30">

    <!-- 1. Name Registration Modal -->
    <div id="join-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md transition-opacity">
        <div class="bg-slate-900 border border-white/10 p-8 rounded-[2.5rem] w-full max-w-sm shadow-2xl text-center transform scale-100 transition-transform">
            <div class="w-20 h-20 bg-gradient-to-tr from-pink-500 to-purple-500 rounded-full flex items-center justify-center mb-6 mx-auto shadow-lg">
                <i class="fa-solid fa-bolt-lightning text-3xl text-white"></i>
            </div>
            <h2 class="text-2xl font-black mb-2 text-white tracking-tight">Global Chat</h2>
            <p class="text-slate-400 text-sm mb-6">Chat-e jog dite apnar nam likhun</p>
            
            <form id="join-form" class="space-y-4">
                <input type="text" id="username-input" required autocomplete="off" class="w-full bg-black/50 border border-white/10 rounded-2xl p-4 text-white text-center focus:outline-none focus:border-pink-500 transition-all font-bold" placeholder="Apnar Nam...">
                <button type="submit" class="w-full bg-gradient-to-r from-pink-600 to-purple-600 py-4 rounded-2xl text-white font-black uppercase tracking-widest transition-all shadow-lg active:scale-95">Enter Chat</button>
            </form>
            <div class="mt-4">
                <a href="index.html" class="text-xs text-slate-500 hover:text-white underline transition-colors">Back to Home</a>
            </div>
        </div>
    </div>

    <!-- 2. Main Chat App Container -->
    <div id="chat-app" class="hidden flex-col h-full w-full max-w-4xl mx-auto relative bg-slate-950 shadow-2xl md:border-x border-white/5">
        
        <header class="glass-header p-4 flex items-center justify-between z-20 shrink-0">
            <div class="flex items-center gap-4">
                <a href="index.html" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/10 text-slate-300 border border-white/5">
                    <i class="fa-solid fa-arrow-left"></i>
                </a>
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-10 h-10 bg-gradient-to-r from-pink-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold shadow-lg">
                            <i class="fa-solid fa-globe"></i>
                        </div>
                        <span class="absolute bottom-0 right-0 w-3 h-3 bg-emerald-500 border-2 border-slate-900 rounded-full"></span>
                    </div>
                    <div>
                        <h1 class="font-bold text-white leading-tight">Public Lounge</h1>
                        <p class="text-[10px] text-emerald-400 font-medium tracking-widest uppercase">Synced via Cloudinary</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <!-- Test Notification Button (Added for user to test locally) -->
                <button onclick="testLocalNotification()" class="w-8 h-8 rounded-full bg-emerald-500/20 text-emerald-400 hover:bg-emerald-500 hover:text-white transition-colors flex items-center justify-center" title="Test Notification">
                    <i class="fa-solid fa-bell"></i>
                </button>
                <button onclick="changeName()" class="text-xs text-slate-400 hover:text-white bg-white/5 px-3 py-1.5 rounded-full border border-white/5 transition-colors">
                    <i class="fa-solid fa-user-pen mr-1"></i> Edit Name
                </button>
            </div>
        </header>

        <main id="chat-box" class="flex-grow chat-bg overflow-y-auto p-4 md:p-6 flex flex-col gap-4 custom-scroll relative z-10 overscroll-contain">
            <div id="loading-msgs" class="flex justify-center items-center py-10">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-pink-500"></div>
            </div>
        </main>

        <footer class="glass-footer p-3 z-20 shrink-0 flex flex-col">
            
            <div id="file-preview-container" class="hidden w-full max-w-4xl mx-auto px-1 mb-2">
                <div class="bg-slate-800/80 border border-white/10 rounded-xl p-2.5 flex items-center justify-between shadow-xl">
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-8 h-8 rounded bg-pink-500/20 text-pink-400 flex items-center justify-center shrink-0 border border-pink-500/30">
                            <i id="preview-icon" class="fa-solid fa-file"></i>
                        </div>
                        <div class="overflow-hidden">
                            <p id="file-preview-name" class="text-xs font-bold text-white truncate w-48 md:w-64">filename.pdf</p>
                            <p id="file-preview-size" class="text-[9px] text-slate-400 uppercase tracking-widest">0 MB</p>
                        </div>
                    </div>
                    <button type="button" onclick="clearFile()" class="text-slate-400 hover:text-red-400 w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/5 transition-colors">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
            </div>

            <form id="chat-form" class="flex items-end gap-2 max-w-4xl mx-auto w-full">
                <button type="button" onclick="document.getElementById('file-input').click()" class="w-12 h-12 shrink-0 text-slate-400 hover:text-pink-400 bg-slate-800/80 rounded-2xl flex items-center justify-center transition-all border border-white/10 hover:border-pink-500/50 mb-0.5">
                    <i class="fa-solid fa-paperclip text-lg"></i>
                </button>
                <input type="file" id="file-input" class="hidden">

                <div class="flex-grow bg-slate-800/80 border border-white/10 rounded-2xl flex items-center px-2 py-1 transition-all focus-within:border-pink-500/50">
                    <textarea id="msg-input" rows="1" placeholder="Type @all to notify everyone..."
                        class="w-full bg-transparent p-3 text-white focus:outline-none resize-none max-h-28 custom-scroll" style="min-height: 44px;"></textarea>
                </div>
                
                <button type="submit" id="send-btn" disabled
                    class="w-12 h-12 shrink-0 bg-gradient-to-br from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 rounded-2xl flex items-center justify-center text-white shadow-lg transition-all active:scale-95 disabled:opacity-50 mb-0.5">
                    <i class="fa-solid fa-paper-plane text-lg ml-[-2px]"></i>
                </button>
            </form>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDGd3KAo45UuqmeGFALziz_oKm3htEASHY",
            authDomain: "mywebtools-f8d53.firebaseapp.com",
            projectId: "mywebtools-f8d53",
            storageBucket: "mywebtools-f8d53.firebasestorage.app",
            messagingSenderId: "979594414301",
            appId: "1:979594414301:web:7048c995e56e331a85f334"
        };

        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/de2w78yxh/auto/upload"; 
        const CLOUDINARY_UPLOAD_PRESET = "ml_default"; 

        const SYNC_APP_ID = "rasel-mia-universal-sync";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let myUsername = localStorage.getItem('chat_username') || '';
        let selectedFile = null;
        let appStartTime = Date.now(); 

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('firebase-messaging-sw.js')
            .then(reg => console.log('Service worker registered'))
            .catch(err => console.warn('Service worker not registered:', err));
        }

        const joinModal = document.getElementById('join-modal');
        const chatApp = document.getElementById('chat-app');
        const chatBox = document.getElementById('chat-box');
        const chatForm = document.getElementById('chat-form');
        const msgInput = document.getElementById('msg-input');
        const sendBtn = document.getElementById('send-btn');
        const fileInput = document.getElementById('file-input');
        const previewContainer = document.getElementById('file-preview-container');

        msgInput.addEventListener('focus', () => {
            setTimeout(() => {
                chatBox.scrollTop = chatBox.scrollHeight;
                window.scrollTo(0, document.body.scrollHeight);
            }, 300);
        });

        if (myUsername) startChatApp(); else joinModal.classList.remove('hidden');

        document.getElementById('join-form').onsubmit = (e) => {
            e.preventDefault();
            const name = document.getElementById('username-input').value.trim();
            if (name) {
                myUsername = name;
                localStorage.setItem('chat_username', name);
                joinModal.classList.add('hidden');
                startChatApp();
            }
        };

        window.changeName = () => {
            joinModal.classList.remove('hidden');
            document.getElementById('username-input').value = myUsername;
        };

        msgInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight < 112 ? this.scrollHeight : 112) + 'px';
            sendBtn.disabled = this.value.trim() === '' && !selectedFile;
        });
        
        msgInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if(!sendBtn.disabled) chatForm.dispatchEvent(new Event('submit'));
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 30 * 1024 * 1024) { 
                    alert("File size 30 MB-r beshi hote parbe na!");
                    fileInput.value = '';
                    return;
                }
                selectedFile = file;
                document.getElementById('file-preview-name').innerText = file.name;
                document.getElementById('file-preview-size').innerText = (file.size / 1024 / 1024).toFixed(2) + " MB";
                previewContainer.classList.remove('hidden');
                sendBtn.disabled = false;
            }
        });

        window.clearFile = () => {
            selectedFile = null;
            fileInput.value = '';
            previewContainer.classList.add('hidden');
            sendBtn.disabled = msgInput.value.trim() === '';
        };

        async function startChatApp() {
            chatApp.classList.remove('hidden');
            chatApp.classList.add('flex');
            
            // ðŸ”¥ User theke Notification er Onumoti neya
            if ("Notification" in window && Notification.permission !== "granted" && Notification.permission !== "denied") {
                Notification.requestPermission();
            }

            try {
                await signInAnonymously(auth);
                listenForMessages();
            } catch (err) {
                console.error("Connection Error", err);
            }
        }

        // ðŸ”¥ Test Button Logic (Jate apni OS er permission test korte paren)
        window.testLocalNotification = () => {
            if (Notification.permission === "granted") {
                triggerGlobalNotification("System Test", "This is a test notification. It stays in the center!", false);
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if(permission === "granted") triggerGlobalNotification("System Test", "Notification Allowed!", false);
                });
            } else {
                alert("Please enable notifications in your browser settings for this site.");
            }
        };

        chatForm.onsubmit = async (e) => {
            e.preventDefault();
            const text = msgInput.value.trim();
            if (!text && !selectedFile) return;

            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            try {
                let fileUrl = null, fileName = null, fileType = null;
                
                if (selectedFile) {
                    const formData = new FormData();
                    formData.append('file', selectedFile);
                    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    
                    const response = await fetch(CLOUDINARY_URL, { method: 'POST', body: formData });
                    const uploadResult = await response.json();
                    
                    if(uploadResult.secure_url) {
                        fileUrl = uploadResult.secure_url;
                        fileName = selectedFile.name;
                        fileType = selectedFile.type;
                    } else {
                        throw new Error(uploadResult.error?.message || "Cloudinary upload failed");
                    }
                }

                await addDoc(collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'global_messages'), {
                    text,
                    sender: myUsername,
                    timestamp: Date.now(),
                    timeString: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                    fileUrl,
                    fileName,
                    fileType
                });

                msgInput.value = '';
                clearFile();
                msgInput.style.height = '44px';
                
                msgInput.focus();
            } catch (error) {
                console.error(error);
                alert("Upload somoshsha: " + error.message);
            } finally {
                sendBtn.innerHTML = '<i class="fa-solid fa-paper-plane text-lg"></i>';
                sendBtn.disabled = msgInput.value.trim() === '' && !selectedFile;
            }
        };

        // ðŸ”¥ Notification Dekhanor Logic (UPDATED)
        function triggerGlobalNotification(sender, text, isFile) {
            if (Notification.permission === "granted") {
                let cleanText = text ? text.replace(/@all/ig, '').trim() : '';
                if (!cleanText && isFile) cleanText = "Sent a file/image to everyone.";
                if (!cleanText) cleanText = "Has mentioned everyone!";
                
                const title = `ðŸš¨ Global Mention from ${sender}`;
                const options = {
                    body: cleanText,
                    icon: 'developer.jpg', 
                    badge: 'developer.jpg',
                    vibrate: [200, 100, 200],
                    requireInteraction: true // ðŸ”¥ ETA NOTIFICATION CENTER E ATKE RAKHBE!
                };

                if ('serviceWorker' in navigator && navigator.serviceWorker.ready) {
                    navigator.serviceWorker.ready.then(registration => {
                        registration.showNotification(title, options);
                    }).catch(e => new Notification(title, options));
                } else {
                    new Notification(title, options);
                }
            }
        }

        function listenForMessages() {
            const q = query(
                collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'global_messages'), 
                orderBy('timestamp', 'asc'), 
                limit(100)
            );
            
            onSnapshot(q, (snapshot) => {
                document.getElementById('loading-msgs').style.display = 'none';
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        const data = change.doc.data();
                        appendMessageToUI(data);

                        // ðŸ”¥ Jodi notun message hoy, ebong nijer pathano message NA hoy (nijeke notify korbe na)
                        if (data.timestamp > appStartTime && data.sender !== myUsername) {
                            if (data.text && data.text.toLowerCase().includes('@all')) {
                                triggerGlobalNotification(data.sender, data.text, !!data.fileUrl);
                            }
                        }
                    }
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        }

        function getDownloadableUrl(originalUrl) {
            if (originalUrl && originalUrl.includes('/upload/')) {
                return originalUrl.replace('/upload/', '/upload/fl_attachment/');
            }
            return originalUrl;
        }

        function appendMessageToUI(data) {
            const isMe = data.sender === myUsername;
            const bubbleClasses = isMe ? 'bg-gradient-to-br from-pink-600 to-purple-600 self-end items-end' : 'bg-slate-800 self-start items-start';
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg-bubble flex flex-col max-w-[85%] md:max-w-[75%] ${bubbleClasses} p-3 rounded-2xl mb-2 relative shadow-lg`;
            
            let content = '';
            if (data.fileUrl) {
                if (data.fileType && data.fileType.startsWith('image/')) {
                    content = `<img src="${data.fileUrl}" class="rounded-xl mb-2 max-h-64 w-full object-cover cursor-pointer hover:opacity-90 transition-opacity" onclick="window.open('${data.fileUrl}')">`;
                } else {
                    const forcedDownloadUrl = getDownloadableUrl(data.fileUrl);
                    content = `<a href="${forcedDownloadUrl}" download="${data.fileName}" target="_blank" class="bg-black/20 p-3 rounded-xl flex items-center gap-3 text-xs mb-2 border border-white/5 hover:bg-black/40 transition-colors w-full">
                        <i class="fa-solid fa-file-arrow-down text-xl text-pink-400 shrink-0"></i> 
                        <span class="truncate font-bold text-white">${data.fileName}</span>
                    </a>`;
                }
            }
            
            let finalHtmlText = '';
            if (data.text) {
                let safeText = escapeHTML(data.text);
                safeText = safeText.replace(/@all/ig, '<span class="bg-emerald-500/30 text-emerald-400 px-1.5 py-0.5 rounded font-black tracking-widest text-[11px] shadow-inner mx-0.5">@ALL</span>');
                finalHtmlText = `<p class="text-[15px] whitespace-pre-wrap leading-relaxed">${safeText}</p>`;
            }
            
            msgDiv.innerHTML = `
                <span class="text-[10px] text-slate-400 mb-1 font-bold">${data.sender}</span>
                ${content}
                ${finalHtmlText}
                <span class="text-[9px] opacity-60 mt-1 block text-right">${data.timeString}</span>
            `;
            
            chatBox.appendChild(msgDiv);
        }

        function escapeHTML(str) {
            return str.replace(/[&<>'"]/g, 
                tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag] || tag)
            );
        }
    </script>
</body>
</html>
