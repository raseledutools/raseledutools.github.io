<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Exam | Leaderboard & Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #0f172a; color: #f1f5f9; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .option-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .option-btn:hover:not(:disabled) { transform: translateX(10px); background: rgba(236, 72, 153, 0.1); border-color: #ec4899; }
        .correct { background: #059669 !important; border-color: #10b981 !important; color: white; }
        .wrong { background: #dc2626 !important; border-color: #ef4444 !important; color: white; }
        .title-gradient { background: linear-gradient(to right, #ffffff, #f9a8d4, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Table Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        /* Rank Badge */
        .rank-badge { width: 24px; height: 24px; display: flex; items-center; justify-content: center; border-radius: 50%; font-size: 10px; font-weight: 800; }
        .rank-1 { background: #fbbf24; color: #78350f; box-shadow: 0 0 10px rgba(251, 191, 36, 0.4); }
        .rank-2 { background: #cbd5e1; color: #334155; }
        .rank-3 { background: #d97706; color: #fff; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Header Section -->
    <header class="fixed top-0 w-full p-4 flex items-center justify-between glass z-40">
        <div class="flex items-center gap-3">
            <a href="index.html" class="p-2 hover:bg-white/10 rounded-full transition-colors">
                <i class="fa-solid fa-house text-xl"></i>
            </a>
            <button onclick="openLeaderboard()" class="px-4 py-1.5 rounded-full bg-pink-600/20 border border-pink-500/30 text-pink-400 text-xs font-bold hover:bg-pink-600 hover:text-white transition-all">
                <i class="fa-solid fa-ranking-star mr-1"></i> Ranking
            </button>
        </div>
        
        <h1 class="hidden md:block font-bold text-lg tracking-wider text-pink-500">Live Exam Terminal</h1>
        
        <div id="student-badge" class="hidden items-center gap-2 bg-white/5 border border-white/10 px-3 py-1 rounded-full text-xs font-bold text-slate-300">
            <i class="fa-solid fa-user-graduate text-pink-500"></i>
            <span id="header-student-name">Student</span>
        </div>
    </header>

    <!-- Registration Modal -->
    <div id="registration-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl">
        <div class="max-w-md w-full text-center p-8 glass rounded-[2.5rem] shadow-pink-500/20 shadow-2xl">
            <div class="w-20 h-20 bg-pink-500/20 rounded-full flex items-center justify-center mb-6 mx-auto border border-pink-500/30">
                <i class="fa-solid fa-id-card-clip text-4xl text-pink-500"></i>
            </div>
            <h2 class="text-3xl font-black mb-2 tracking-tighter uppercase">Student Login</h2>
            <p class="text-slate-400 mb-8 text-sm">Exam shuru korar age aapnar details din.</p>
            
            <form id="registration-form" class="space-y-4">
                <input type="text" id="student-name" required autocomplete="off"
                    class="w-full bg-slate-800/80 border border-white/10 rounded-2xl p-4 text-white text-center focus:outline-none focus:border-pink-500 transition-all font-bold placeholder-slate-500" 
                    placeholder="Aapnar Nam Likhun">
                <input type="tel" id="student-phone" required autocomplete="off" pattern="[0-9]{11}"
                    class="w-full bg-slate-800/80 border border-white/10 rounded-2xl p-4 text-white text-center focus:outline-none focus:border-pink-500 transition-all font-bold placeholder-slate-500" 
                    placeholder="Phone Number (11 digit)">
                
                <button type="submit" 
                    class="w-full bg-gradient-to-r from-pink-600 to-purple-600 py-4 rounded-2xl text-white font-black uppercase tracking-widest hover:scale-[1.02] active:scale-95 transition-all shadow-lg shadow-pink-600/20 mt-4">
                    Start Exam Now
                </button>
            </form>
        </div>
    </div>

    <!-- Exam Content Area -->
    <div id="exam-main-content" class="hidden w-full max-w-4xl mt-24 mb-20">
        <div class="text-center mb-10 px-4">
            <h1 id="exam-title-header" class="text-xl md:text-3xl font-bold title-gradient leading-tight mb-2">Loading Exam...</h1>
            <p id="exam-subtitle-header" class="text-slate-400 text-sm md:text-base font-medium tracking-wide">Please wait...</p>
        </div>

        <main id="quiz-container" class="glass p-6 md:p-10 rounded-[2rem] shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <div id="score-badge" class="bg-pink-600 px-4 py-1.5 rounded-full text-sm font-bold shadow-lg">Score: 0</div>
                <span id="question-count" class="text-xs text-slate-400 font-bold uppercase tracking-[0.2em]">Q: 1/10</span>
            </div>
            <div class="w-full bg-slate-700 h-1.5 rounded-full mb-8 overflow-hidden">
                <div id="progress" class="bg-gradient-to-r from-pink-500 to-purple-600 h-full transition-all duration-500" style="width: 0%"></div>
            </div>
            <div id="question-area">
                <h2 id="question-text" class="text-xl md:text-2xl font-bold mb-8 leading-relaxed">Questions are loading...</h2>
                <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
            <div class="mt-10">
                <button id="next-btn" disabled class="hidden w-full bg-slate-700 py-4 rounded-2xl font-bold tracking-widest hover:bg-slate-600 transition-all">Next Question</button>
            </div>
        </main>
    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="hidden fixed inset-0 z-[150] flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl">
        <div class="max-w-md w-full text-center p-8 glass rounded-[2.5rem] shadow-2xl">
            <div class="w-20 h-20 bg-emerald-500/20 rounded-full flex items-center justify-center mb-6 mx-auto border border-emerald-500/30">
                <i class="fa-solid fa-trophy text-4xl text-emerald-500"></i>
            </div>
            <h2 class="text-3xl font-black mb-1 tracking-tighter uppercase italic">Exam Finished!</h2>
            <p id="result-student-name" class="text-pink-400 font-bold mb-2 text-lg"></p>
            <p id="sync-status-text" class="text-[10px] text-slate-500 uppercase font-bold mb-6 tracking-widest">Saving result to cloud...</p>
            
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                    <span class="text-xs text-slate-500 block uppercase font-bold">Total Score</span>
                    <span id="final-score" class="text-3xl font-black text-white">0</span>
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                    <span class="text-xs text-slate-500 block uppercase font-bold">Accuracy</span>
                    <span id="accuracy" class="text-3xl font-black text-emerald-500">0%</span>
                </div>
            </div>

            <button onclick="location.reload()" class="w-full bg-pink-600 text-white font-black py-4 rounded-2xl uppercase tracking-widest hover:scale-105 transition-all mb-4">Retake Exam</button>
            <button onclick="openLeaderboard()" class="w-full bg-white/5 border border-white/10 text-white py-3 rounded-xl text-sm font-bold hover:bg-white/10 transition-all mb-4">View Leaderboard</button>
            <a href="index.html" class="block text-slate-400 hover:text-white transition-colors text-sm font-bold underline">Back to Home</a>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboard-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
        <div class="max-w-2xl w-full glass rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-slate-900/50">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-crown text-amber-500"></i> Merit List
                </h3>
                <button onclick="closeLeaderboard()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/10 text-slate-400">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
            
            <div class="flex-grow overflow-y-auto p-4 custom-scroll">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-[10px] text-slate-500 uppercase font-bold tracking-widest border-b border-white/5">
                            <th class="p-4 w-16 text-center">Rank</th>
                            <th class="p-4">Student Name</th>
                            <th class="p-4 text-center">Score</th>
                            <th class="p-4 text-right">Time</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <tr><td colspan="4" class="p-10 text-center text-slate-500 italic">Connecting to merit database...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="p-4 bg-slate-900/80 border-t border-white/5 text-center">
                <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest italic">Sorted by highest marks obtained</p>
            </div>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDGd3KAo45UuqmeGFALziz_oKm3htEASHY",
            authDomain: "mywebtools-f8d53.firebaseapp.com",
            projectId: "mywebtools-f8d53",
            storageBucket: "mywebtools-f8d53.firebasestorage.app",
            messagingSenderId: "979594414301",
            appId: "1:979594414301:web:7048c995e56e331a85f334"
        };

        const appId = "rasel-mia-universal-sync";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let questions = [];
        let currentIndex = 0;
        let score = 0;
        let canAnswer = true;
        let currentStudent = { name: '', phone: '' };
        let currentUser = null;

        const registrationModal = document.getElementById('registration-modal');
        const examMainContent = document.getElementById('exam-main-content');
        const headerStudentName = document.getElementById('header-student-name');
        const studentBadge = document.getElementById('student-badge');
        const examTitleHeader = document.getElementById('exam-title-header');
        const examSubtitleHeader = document.getElementById('exam-subtitle-header');
        const questionText = document.getElementById('question-text');
        const optionsGrid = document.getElementById('options-grid');
        const scoreBadge = document.getElementById('score-badge');
        const nextBtn = document.getElementById('next-btn');
        const resultModal = document.getElementById('result-modal');
        const leaderboardBody = document.getElementById('leaderboard-body');

        // Initial Auth
        signInAnonymously(auth).catch(e => console.error("Auth failed", e));
        onAuthStateChanged(auth, user => { if(user) currentUser = user; });

        // Registration
        document.getElementById('registration-form').onsubmit = (e) => {
            e.preventDefault();
            const name = document.getElementById('student-name').value.trim();
            const phone = document.getElementById('student-phone').value.trim();
            if(name && phone) {
                currentStudent = { name, phone };
                headerStudentName.innerText = name.split(' ')[0];
                studentBadge.classList.remove('hidden');
                studentBadge.classList.add('flex');
                registrationModal.classList.add('hidden');
                examMainContent.classList.remove('hidden');
                loadQuestions();
            }
        };

        // Load Questions
        async function loadQuestions() {
            try {
                const response = await fetch('questions.txt');
                if(!response.ok) throw new Error("Missing File");
                const text = await response.text();
                parseFileContent(text);
            } catch (err) {
                if(window.location.href.includes('preview')) loadSampleData();
                else examTitleHeader.innerText = "Error: questions.txt file load hoyni.";
            }
        }

        function parseFileContent(text) {
            const lines = text.trim().split('\n').filter(l => l.trim() !== '');
            if(lines.length >= 2) {
                examTitleHeader.innerText = lines[0];
                examSubtitleHeader.innerText = lines[1];
                const questionLines = lines.slice(2);
                questions = questionLines.map(line => {
                    const parts = line.split('|');
                    return { question: parts[0], options: [parts[1], parts[2], parts[3], parts[4]], correct: parseInt(parts[5]) };
                });
            }
            if(questions.length > 0) showQuestion();
        }

        function loadSampleData() {
            const sample = `à¦¬à¦¾à¦‚à¦²à¦¾à¦¦à§‡à¦¶ à¦ªà¦¾à¦¨à¦¿ à¦‰à¦¨à§à¦¨à¦¯à¦¼à¦¨ à¦¬à§‹à¦°à§à¦¡ (BWDB)\nà§¨à§¦à§¨à§¬ à¦à¦° MCQ à¦¸à¦®à¦¾à¦§à¦¾à¦¨ | Merit-based Sorting Active\nSurjo kon dik theke othe?|Purbo|Poschim|Utor|Dokkhin|0`;
            parseFileContent(sample);
        }

        function showQuestion() {
            const q = questions[currentIndex];
            questionText.innerText = q.question;
            document.getElementById('question-count').innerText = `Q: ${currentIndex + 1}/${questions.length}`;
            document.getElementById('progress').style.width = `${((currentIndex) / questions.length) * 100}%`;
            optionsGrid.innerHTML = '';
            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "option-btn w-full text-left p-4 rounded-2xl glass border border-white/10 flex items-center justify-between group";
                btn.innerHTML = `<span class="font-medium text-sm md:text-base">${opt}</span>`;
                btn.onclick = () => selectOption(idx, btn);
                optionsGrid.appendChild(btn);
            });
            canAnswer = true;
            nextBtn.classList.add('hidden');
        }

        function selectOption(idx, btn) {
            if(!canAnswer) return;
            canAnswer = false;
            const correctIdx = questions[currentIndex].correct;
            const allBtns = optionsGrid.querySelectorAll('.option-btn');
            if(idx === correctIdx) {
                btn.classList.add('correct');
                score += 10;
                scoreBadge.innerText = `Score: ${score}`;
            } else {
                btn.classList.add('wrong');
                if (allBtns[correctIdx]) allBtns[correctIdx].classList.add('correct');
            }
            if(currentIndex < questions.length - 1) {
                nextBtn.classList.remove('hidden');
                nextBtn.disabled = false;
            } else {
                setTimeout(showResults, 1200);
            }
        }

        nextBtn.onclick = () => { currentIndex++; showQuestion(); };

        // Save Result
        async function showResults() {
            resultModal.classList.remove('hidden');
            document.getElementById('result-student-name').innerText = currentStudent.name;
            document.getElementById('final-score').innerText = score;
            const accuracy = questions.length > 0 ? Math.round((score / (questions.length * 10)) * 100) : 0;
            document.getElementById('accuracy').innerText = `${accuracy}%`;

            if(currentUser) {
                try {
                    const resultsRef = collection(db, 'artifacts', appId, 'public', 'data', 'exam_results');
                    await addDoc(resultsRef, {
                        name: currentStudent.name,
                        phone: currentStudent.phone,
                        score: score,
                        accuracy: accuracy,
                        examTitle: examTitleHeader.innerText,
                        timestamp: Date.now().toString()
                    });
                    document.getElementById('sync-status-text').innerText = "Result synced globally âœ“";
                    document.getElementById('sync-status-text').classList.replace('text-slate-500', 'text-emerald-500');
                } catch (e) {
                    document.getElementById('sync-status-text').innerText = "Sync failed. Local view only.";
                }
            }
        }

        // Merit-based Leaderboard Logic
        window.openLeaderboard = () => {
            document.getElementById('leaderboard-modal').classList.remove('hidden');
            const resultsRef = collection(db, 'artifacts', appId, 'public', 'data', 'exam_results');
            
            // Real-time listener
            onSnapshot(resultsRef, (snapshot) => {
                let allResults = [];
                snapshot.forEach(docSnap => allResults.push(docSnap.data()));
                
                // ðŸ”¥ MERIT SORTING LOGIC: Highest score first. If scores are equal, sort by newest time.
                allResults.sort((a, b) => {
                    const scoreA = parseInt(a.score) || 0;
                    const scoreB = parseInt(b.score) || 0;
                    if (scoreB !== scoreA) {
                        return scoreB - scoreA;
                    }
                    return parseInt(b.timestamp || 0) - parseInt(a.timestamp || 0);
                });

                leaderboardBody.innerHTML = '';
                if(allResults.length === 0) {
                    leaderboardBody.innerHTML = '<tr><td colspan="4" class="p-10 text-center text-slate-500 italic">Merit list is empty.</td></tr>';
                    return;
                }

                allResults.forEach((res, index) => {
                    const date = res.timestamp ? new Date(parseInt(res.timestamp)).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/A';
                    const rank = index + 1;
                    let rankClass = "bg-slate-800 text-slate-400";
                    if (rank === 1) rankClass = "rank-1";
                    if (rank === 2) rankClass = "rank-2";
                    if (rank === 3) rankClass = "rank-3";

                    const tr = document.createElement('tr');
                    tr.className = "border-b border-white/5 hover:bg-white/5 transition-colors";
                    tr.innerHTML = `
                        <td class="p-4 text-center">
                            <div class="mx-auto rank-badge ${rankClass}">${rank}</div>
                        </td>
                        <td class="p-4">
                            <div class="font-bold text-slate-200">${res.name}</div>
                            <div class="text-[9px] text-slate-500 font-mono tracking-widest">${res.phone.substring(0,5)}******</div>
                        </td>
                        <td class="p-4 text-center">
                            <span class="bg-pink-600/10 text-pink-400 px-3 py-1 rounded-lg font-black text-sm">${res.score}</span>
                        </td>
                        <td class="p-4 text-right text-[9px] text-slate-500 font-bold uppercase">${date}</td>
                    `;
                    leaderboardBody.appendChild(tr);
                });
            });
        };

        window.closeLeaderboard = () => document.getElementById('leaderboard-modal').classList.add('hidden');

    </script>
</body>
</html>
