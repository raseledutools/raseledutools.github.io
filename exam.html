<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Center | Professional Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #0f172a; color: #f1f5f9; }
        .bg-overlay { position: fixed; inset: 0; z-index: -1; background-image: linear-gradient(to bottom, rgba(2, 6, 23, 0.8), rgba(2, 6, 23, 0.98)), url('https://images.unsplash.com/photo-1505118380757-91f5f5632de0?q=80&w=2500'); background-size: cover; background-position: center; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .option-btn { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .option-btn:hover:not(:disabled) { transform: translateX(5px); background: rgba(236, 72, 153, 0.1); border-color: #ec4899; }
        .title-gradient { background: linear-gradient(to right, #ffffff, #f9a8d4, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        
        /* Rank Badge */
        .rank-badge { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 10px; font-weight: 800; margin: 0 auto; }
        .rank-1 { background: #fbbf24; color: #78350f; box-shadow: 0 0 10px rgba(251, 191, 36, 0.4); }
        .rank-2 { background: #cbd5e1; color: #334155; }
        .rank-3 { background: #d97706; color: #fff; }

        /* Dashboard Cards */
        .dash-card { transition: all 0.3s ease; }
        .dash-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 15px 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <div class="bg-overlay"></div>

    <!-- Top Header -->
    <header class="fixed top-0 w-full p-4 flex items-center justify-between glass z-40">
        <div class="flex items-center gap-3">
            <a href="index.html" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/10 transition-colors border border-white/10 text-slate-300">
                <i class="fa-solid fa-house"></i>
            </a>
            <button onclick="logout()" class="px-3 py-1.5 rounded-full bg-red-600/20 border border-red-500/30 text-red-400 text-xs font-bold hover:bg-red-600 hover:text-white transition-all hidden" id="logout-btn">
                <i class="fa-solid fa-right-from-bracket mr-1"></i> Change User
            </button>
        </div>
        
        <h1 class="hidden md:block font-bold text-lg tracking-wider text-pink-500">Live Exam Center</h1>
        
        <div id="student-badge" class="hidden items-center gap-2 bg-white/5 border border-white/10 px-4 py-1.5 rounded-full text-xs font-bold text-slate-200 shadow-inner">
            <i class="fa-solid fa-user-graduate text-pink-500"></i>
            <span id="header-student-name">Student</span>
        </div>
    </header>

    <!-- 1. Registration Modal -->
    <div id="registration-modal" class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90 backdrop-blur-xl">
        <div class="max-w-md w-full text-center p-8 glass rounded-[2.5rem] shadow-pink-500/20 shadow-2xl">
            <div class="w-20 h-20 bg-pink-500/20 rounded-full flex items-center justify-center mb-6 mx-auto border border-pink-500/30">
                <i class="fa-solid fa-id-card-clip text-4xl text-pink-500"></i>
            </div>
            <h2 class="text-3xl font-black mb-2 tracking-tighter uppercase">Student Login</h2>
            <p class="text-slate-400 mb-8 text-sm">Exam dashboard-e dhukar jonno details din.</p>
            
            <form id="registration-form" class="space-y-4">
                <input type="text" id="student-name" required autocomplete="off"
                    class="w-full bg-slate-800/80 border border-white/10 rounded-2xl p-4 text-white text-center focus:outline-none focus:border-pink-500 transition-all font-bold placeholder-slate-500" 
                    placeholder="Aapnar Nam Likhun">
                <input type="tel" id="student-phone" required autocomplete="off" pattern="[0-9]{11}"
                    class="w-full bg-slate-800/80 border border-white/10 rounded-2xl p-4 text-white text-center focus:outline-none focus:border-pink-500 transition-all font-bold placeholder-slate-500" 
                    placeholder="Phone Number (11 digit)">
                
                <button type="submit" 
                    class="w-full bg-gradient-to-r from-pink-600 to-purple-600 py-4 rounded-2xl text-white font-black uppercase tracking-widest hover:scale-[1.02] active:scale-95 transition-all shadow-lg shadow-pink-600/20 mt-4">
                    Enter Dashboard
                </button>
            </form>
        </div>
    </div>

    <!-- 2. Main Dashboard Container -->
    <div id="dashboard-container" class="hidden w-full max-w-4xl mt-24 mb-20 animate-[zoomIn_0.4s_ease-out]">
        <div class="text-center mb-10 px-4">
            <h1 class="text-3xl md:text-4xl font-bold title-gradient leading-tight mb-2">Welcome, <span id="dash-name">Student</span>!</h1>
            <p class="text-slate-400 text-sm md:text-base font-medium tracking-wide">Select an option below to proceed.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 px-4">
            
            <!-- Live Exam Card -->
            <button onclick="startLiveMode('exam')" class="dash-card group relative overflow-hidden bg-gradient-to-br from-pink-600 to-purple-700 p-8 rounded-[2rem] text-left border border-white/10 shadow-lg">
                <div class="absolute right-0 top-0 w-32 h-32 bg-white/10 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                <i class="fa-solid fa-pen-to-square text-4xl text-white/80 mb-3 block"></i>
                <h3 class="text-2xl font-black text-white tracking-tight">Today's Live Exam</h3>
                <p id="live-exam-date" class="text-pink-200 text-[11px] font-bold uppercase tracking-[0.2em] mb-3 italic">Loading date...</p>
                <p class="text-white/70 text-sm font-medium">Start the ongoing live examination. Your results will be saved globally.</p>
            </button>

            <!-- Practice Mode -->
            <button onclick="startLiveMode('practice')" class="dash-card group relative overflow-hidden bg-gradient-to-br from-blue-600 to-cyan-700 p-8 rounded-[2rem] text-left border border-white/10 shadow-lg">
                <div class="absolute right-0 top-0 w-32 h-32 bg-white/10 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                <i class="fa-solid fa-book-open-reader text-4xl text-white/80 mb-4 block"></i>
                <h3 class="text-2xl font-black text-white mb-2 tracking-tight">Practice View</h3>
                <p class="text-white/70 text-sm font-medium">Read today's live questions with correct answers highlighted.</p>
            </button>

            <!-- Archive -->
            <button onclick="openArchiveView()" class="dash-card group relative overflow-hidden bg-gradient-to-br from-amber-600 to-orange-700 p-8 rounded-[2rem] text-left border border-white/10 shadow-lg">
                <div class="absolute right-0 top-0 w-32 h-32 bg-white/10 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                <i class="fa-solid fa-box-archive text-4xl text-white/80 mb-4 block"></i>
                <h3 class="text-2xl font-black text-white mb-2 tracking-tight">Exam Archive</h3>
                <p class="text-white/70 text-sm font-medium">View previous question papers for test or practice from cloud.</p>
            </button>

            <!-- Merit List -->
            <button onclick="openLeaderboard()" class="dash-card group relative overflow-hidden bg-gradient-to-br from-emerald-600 to-teal-700 p-8 rounded-[2rem] text-left border border-white/10 shadow-lg">
                <div class="absolute right-0 top-0 w-32 h-32 bg-white/10 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                <i class="fa-solid fa-ranking-star text-4xl text-white/80 mb-4 block"></i>
                <h3 class="text-2xl font-black text-white mb-2 tracking-tight">Merit List</h3>
                <p class="text-white/70 text-sm font-medium">Check the global rankings and scores of all students.</p>
            </button>
        </div>
    </div>

    <!-- 3. Exam Mode Area (20 Questions Per Page) -->
    <div id="exam-main-content" class="hidden w-full max-w-4xl mt-24 mb-20">
        <div class="text-center mb-6 px-4 flex flex-col items-center">
            <button onclick="backToDashboard('exam-main-content')" class="mb-4 px-4 py-1.5 rounded-full bg-white/5 border border-white/10 text-slate-400 text-xs font-bold hover:bg-white/10 transition-all">
                <i class="fa-solid fa-arrow-left mr-1"></i> Quit Exam
            </button>
            <h1 id="exam-title-header" class="text-xl md:text-3xl font-bold title-gradient leading-tight mb-2">Loading...</h1>
            <p id="exam-subtitle-header" class="text-slate-400 text-sm font-medium tracking-wide">Please wait</p>
        </div>

        <main class="glass p-4 md:p-8 rounded-[2rem] shadow-2xl relative">
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 bg-slate-900/50 p-4 rounded-2xl border border-white/5">
                <div id="score-badge" class="bg-pink-600 px-5 py-2 rounded-xl text-sm font-black tracking-widest uppercase shadow-lg shadow-pink-600/20">Score: 0</div>
                <div class="w-full md:w-1/2 bg-slate-800 h-2 rounded-full overflow-hidden">
                    <div id="progress" class="bg-gradient-to-r from-pink-500 to-purple-600 h-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <span id="answered-count" class="text-xs text-slate-400 font-bold uppercase tracking-[0.2em] whitespace-nowrap">0/0 Answered</span>
            </div>

            <div class="flex justify-between items-center mb-6 bg-white/5 p-3 rounded-2xl border border-white/5">
                <button onclick="changePage(-1)" id="prev-btn-top" class="px-5 py-2.5 bg-slate-700/50 hover:bg-slate-600 rounded-xl text-sm font-bold transition-all disabled:opacity-30">
                    <i class="fa-solid fa-angle-left mr-1"></i> Prev
                </button>
                <span id="page-info-top" class="text-pink-400 font-black tracking-[0.2em] text-xs uppercase">Page 1/1</span>
                <button onclick="changePage(1)" id="next-btn-top" class="px-5 py-2.5 bg-pink-600/80 hover:bg-pink-500 rounded-xl text-sm font-bold transition-all text-white">
                    Next <i class="fa-solid fa-angle-right ml-1"></i>
                </button>
                <button onclick="finishExam()" id="submit-btn-top" class="hidden px-5 py-2.5 bg-emerald-600 hover:bg-emerald-500 rounded-xl text-sm font-bold transition-all text-white shadow-lg shadow-emerald-500/30">
                    Submit Exam <i class="fa-solid fa-check ml-1"></i>
                </button>
            </div>

            <div id="exam-questions-list" class="space-y-6"></div>

            <div class="flex justify-between items-center mt-6 bg-white/5 p-3 rounded-2xl border border-white/5">
                <button onclick="changePage(-1)" id="prev-btn-bottom" class="px-5 py-2.5 bg-slate-700/50 hover:bg-slate-600 rounded-xl text-sm font-bold transition-all disabled:opacity-30">
                    <i class="fa-solid fa-angle-left mr-1"></i> Prev
                </button>
                <span id="page-info-bottom" class="text-pink-400 font-black tracking-[0.2em] text-xs uppercase">Page 1/1</span>
                <button onclick="changePage(1)" id="next-btn-bottom" class="px-5 py-2.5 bg-pink-600/80 hover:bg-pink-500 rounded-xl text-sm font-bold transition-all text-white">
                    Next <i class="fa-solid fa-angle-right ml-1"></i>
                </button>
                <button onclick="finishExam()" id="submit-btn-bottom" class="hidden px-5 py-2.5 bg-emerald-600 hover:bg-emerald-500 rounded-xl text-sm font-bold transition-all text-white shadow-lg shadow-emerald-500/30">
                    Submit Exam <i class="fa-solid fa-check ml-1"></i>
                </button>
            </div>

        </main>
    </div>

    <!-- 4. Practice Mode Area -->
    <div id="practice-content" class="hidden w-full max-w-4xl mt-24 mb-20">
        <div class="text-center mb-8 px-4 flex flex-col items-center">
            <button onclick="backToDashboard('practice-content')" class="mb-4 px-4 py-1.5 rounded-full bg-white/5 border border-white/10 text-slate-400 text-xs font-bold hover:bg-white/10 transition-all">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back to Dashboard
            </button>
            <h1 id="practice-title" class="text-xl md:text-3xl font-bold text-blue-400 leading-tight mb-2">Practice View</h1>
            <p id="practice-subtitle" class="text-slate-400 text-sm font-medium tracking-wide">All correct answers are marked in green.</p>
        </div>
        <div id="practice-list" class="space-y-6 px-2"></div>
    </div>

    <!-- 5. Archive Mode Area -->
    <div id="archive-content" class="hidden w-full max-w-4xl mt-24 mb-20">
        <div class="text-center mb-8 px-4 flex flex-col items-center">
            <button onclick="backToDashboard('archive-content')" class="mb-4 px-4 py-1.5 rounded-full bg-white/5 border border-white/10 text-slate-400 text-xs font-bold hover:bg-white/10 transition-all">
                <i class="fa-solid fa-arrow-left mr-1"></i> Back to Dashboard
            </button>
            <h1 class="text-xl md:text-3xl font-bold text-amber-500 leading-tight mb-2">Exam Archives</h1>
            <p class="text-slate-400 text-sm font-medium tracking-wide">Select 'Practice' to read or 'Test' to give the exam.</p>
        </div>
        <div id="archive-list" class="space-y-4 px-2"></div>
    </div>

    <!-- Result Modal (End of Exam) -->
    <div id="result-modal" class="hidden fixed inset-0 z-[150] flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl">
        <div class="max-w-md w-full text-center p-8 glass rounded-[2.5rem] shadow-2xl">
            <div class="w-20 h-20 bg-emerald-500/20 rounded-full flex items-center justify-center mb-6 mx-auto border border-emerald-500/30">
                <i class="fa-solid fa-trophy text-4xl text-emerald-500"></i>
            </div>
            <h2 class="text-3xl font-black mb-1 tracking-tighter uppercase italic">Exam Finished!</h2>
            <p id="result-student-name" class="text-pink-400 font-bold mb-2 text-lg"></p>
            <p id="sync-status-text" class="text-[10px] text-slate-500 uppercase font-bold mb-6 tracking-widest">Saving result to cloud...</p>
            
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                    <span class="text-xs text-slate-500 block uppercase font-bold">Total Score</span>
                    <span id="final-score" class="text-3xl font-black text-white">0</span>
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                    <span class="text-xs text-slate-500 block uppercase font-bold">Accuracy</span>
                    <span id="accuracy" class="text-3xl font-black text-emerald-500">0%</span>
                </div>
            </div>

            <button onclick="backToDashboardFromResult()" class="w-full bg-pink-600 hover:bg-pink-500 text-white font-black py-4 rounded-2xl uppercase tracking-widest transition-all mb-4">Back to Dashboard</button>
            <button onclick="openLeaderboard()" class="w-full bg-white/5 border border-white/10 text-white py-3 rounded-xl text-sm font-bold hover:bg-white/10 transition-all">View Merit List</button>
        </div>
    </div>

    <!-- Leaderboard Modal -->
    <div id="leaderboard-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md">
        <div class="max-w-2xl w-full glass rounded-[2.5rem] shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="p-6 border-b border-white/10 flex justify-between items-center bg-slate-900/50">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-crown text-amber-500"></i> Merit List
                </h3>
                <button onclick="closeLeaderboard()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/10 text-slate-400">
                    <i class="fa-solid fa-xmark text-lg"></i>
                </button>
            </div>
            
            <div class="flex-grow overflow-y-auto p-4 custom-scroll">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="text-[10px] text-slate-500 uppercase font-bold tracking-widest border-b border-white/5">
                            <th class="p-4 w-16 text-center">Rank</th>
                            <th class="p-4">Student Name</th>
                            <th class="p-4 text-center">Score</th>
                            <th class="p-4 text-right">Exam Mode</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <tr><td colspan="4" class="p-10 text-center text-slate-500 italic">Connecting to merit database...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs & Logic -->
    <script type="module">
        const dateElement = document.getElementById('live-exam-date');
        if (dateElement) {
            const options = { weekday: 'long', month: 'short', day: 'numeric', year: 'numeric' };
            dateElement.innerText = new Date().toLocaleDateString('en-US', options);
        }

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ðŸ”¥ Aapnar Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDGd3KAo45UuqmeGFALziz_oKm3htEASHY",
            authDomain: "mywebtools-f8d53.firebaseapp.com",
            projectId: "mywebtools-f8d53",
            storageBucket: "mywebtools-f8d53.firebasestorage.app",
            messagingSenderId: "979594414301",
            appId: "1:979594414301:web:7048c995e56e331a85f334"
        };

        const appId = "rasel-mia-universal-sync";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State Variables
        let questions = [];
        let parsedTitle = "Live Exam";
        let parsedSubtitle = "Test your knowledge";
        
        let currentStudent = { name: '', phone: '' };
        let currentUser = null;
        let archiveCache = {};

        // Pagination Exam Variables
        let currentPage = 0;
        const questionsPerPage = 20;
        let score = 0;
        let userAnswers = {}; 
        let answeredQuestions = new Set(); 

        signInAnonymously(auth).catch(e => console.error("Auth failed", e));
        onAuthStateChanged(auth, user => { if(user) currentUser = user; });

        window.onload = () => {
            const savedData = localStorage.getItem('student_info');
            if (savedData) {
                currentStudent = JSON.parse(savedData);
                activateUserSession();
            } else {
                document.getElementById('registration-modal').classList.remove('hidden');
            }
        };

        function activateUserSession() {
            document.getElementById('header-student-name').innerText = currentStudent.name.split(' ')[0];
            document.getElementById('dash-name').innerText = currentStudent.name.split(' ')[0];
            document.getElementById('student-badge').classList.remove('hidden');
            document.getElementById('student-badge').classList.add('flex');
            document.getElementById('logout-btn').classList.remove('hidden');
            
            document.getElementById('registration-modal').classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('hidden');
        }

        document.getElementById('registration-form').onsubmit = (e) => {
            e.preventDefault();
            const name = document.getElementById('student-name').value.trim();
            const phone = document.getElementById('student-phone').value.trim();
            if(name && phone) {
                currentStudent = { name, phone };
                localStorage.setItem('student_info', JSON.stringify(currentStudent));
                activateUserSession();
            }
        };

        window.logout = () => {
            localStorage.removeItem('student_info');
            location.reload();
        }

        function hideAllViews() {
            document.getElementById('dashboard-container').classList.add('hidden');
            document.getElementById('exam-main-content').classList.add('hidden');
            document.getElementById('practice-content').classList.add('hidden');
            document.getElementById('archive-content').classList.add('hidden');
        }

        window.backToDashboard = (currentViewId) => {
            document.getElementById(currentViewId).classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('hidden');
        };

        window.backToDashboardFromResult = () => {
            document.getElementById('result-modal').classList.add('hidden');
            document.getElementById('exam-main-content').classList.add('hidden');
            document.getElementById('dashboard-container').classList.remove('hidden');
        }

        // ðŸ”¥ Notun Data Fetching Logic (Sorasori Firebase theke)
        async function fetchLiveQuestionsData() {
            try {
                const liveRef = doc(db, 'artifacts', appId, 'public', 'data', 'live_exam', 'current');
                const docSnap = await getDoc(liveRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    parsedTitle = data.title;
                    parsedSubtitle = data.subtitle;
                    
                    const lines = data.questions.trim().split('\n').filter(l => l.trim() !== '');
                    questions = lines.map(line => {
                        const parts = line.split('|');
                        return { question: parts[0], options: [parts[1], parts[2], parts[3], parts[4]], correct: parseInt(parts[5]) };
                    });
                    return true;
                } else {
                    return false; // Kono live exam nei
                }
            } catch (err) {
                console.error(err);
                return false;
            }
        }


        // =============== EXAM MODE ===============
        window.startLiveMode = async (mode) => {
            hideAllViews();
            const success = await fetchLiveQuestionsData();
            if (success && questions.length > 0) {
                if(mode === 'exam') initExamView();
                else initPracticeView();
            } else {
                alert("Opekkhwa korun! Admin ekhono ajker notun exam upload koreni.");
                backToDashboard('exam-main-content');
            }
        };

        function initExamView() {
            hideAllViews();
            document.getElementById('exam-main-content').classList.remove('hidden');
            document.getElementById('exam-title-header').innerText = parsedTitle;
            document.getElementById('exam-subtitle-header').innerText = parsedSubtitle;
            
            currentPage = 0;
            score = 0;
            userAnswers = {};
            answeredQuestions.clear();
            document.getElementById('score-badge').innerText = `Score: 0`;
            
            renderExamPage();
        }

        function renderExamPage() {
            const container = document.getElementById('exam-questions-list');
            container.innerHTML = '';
            
            const start = currentPage * questionsPerPage;
            const end = Math.min(start + questionsPerPage, questions.length);

            for (let i = start; i < end; i++) {
                const q = questions[i];
                const qDiv = document.createElement('div');
                qDiv.className = "mb-6 p-5 md:p-6 bg-slate-900/60 rounded-2xl border border-white/5 shadow-inner relative";
                qDiv.innerHTML = `<h3 class="text-base md:text-lg font-bold mb-4 flex items-start gap-3"><span class="bg-pink-600/20 text-pink-400 px-2.5 py-1 rounded-lg text-xs mt-1 shrink-0">${i + 1}</span> <span>${q.question}</span></h3>`;

                const optionsGrid = document.createElement('div');
                optionsGrid.className = "grid grid-cols-1 md:grid-cols-2 gap-3";

                q.options.forEach((opt, optIdx) => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left p-4 rounded-xl bg-white/5 border border-white/10 transition-all text-sm md:text-base font-medium flex items-center justify-between";
                    
                    if (answeredQuestions.has(i)) {
                        btn.disabled = true;
                        if (optIdx === q.correct) {
                            btn.className = "w-full text-left p-4 rounded-xl bg-emerald-600 border border-emerald-500 text-white font-bold flex justify-between";
                            btn.innerHTML = `<span>${opt}</span><i class="fa-solid fa-check"></i>`;
                        } else if (userAnswers[i] === optIdx) {
                            btn.className = "w-full text-left p-4 rounded-xl bg-red-600 border border-red-500 text-white font-bold flex justify-between";
                            btn.innerHTML = `<span>${opt}</span><i class="fa-solid fa-xmark"></i>`;
                        } else {
                            btn.innerHTML = `<span>${opt}</span>`;
                            btn.classList.add('opacity-50');
                        }
                    } else {
                        btn.classList.add('hover:bg-white/10', 'hover:border-pink-500/50');
                        btn.innerHTML = `<span>${opt}</span>`;
                        btn.onclick = () => handleQuestionAnswer(i, optIdx, optionsGrid, q.correct);
                    }
                    optionsGrid.appendChild(btn);
                });

                qDiv.appendChild(optionsGrid);
                container.appendChild(qDiv);
            }

            updatePaginationUI();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        window.handleQuestionAnswer = (qIndex, optIndex, gridElement, correctIdx) => {
            if (answeredQuestions.has(qIndex)) return;
            answeredQuestions.add(qIndex);
            userAnswers[qIndex] = optIndex;

            const btns = gridElement.querySelectorAll('button');
            btns.forEach((btn, idx) => {
                btn.disabled = true;
                btn.classList.remove('hover:bg-white/10', 'hover:border-pink-500/50');
                if (idx === correctIdx) {
                    btn.className = "w-full text-left p-4 rounded-xl bg-emerald-600 border border-emerald-500 text-white font-bold flex justify-between";
                    btn.innerHTML += `<i class="fa-solid fa-check"></i>`;
                } else if (idx === optIndex) {
                    btn.className = "w-full text-left p-4 rounded-xl bg-red-600 border border-red-500 text-white font-bold flex justify-between";
                    btn.innerHTML += `<i class="fa-solid fa-xmark"></i>`;
                } else {
                    btn.classList.add('opacity-50');
                }
            });

            if (optIndex === correctIdx) {
                score += 10;
                document.getElementById('score-badge').innerText = `Score: ${score}`;
            }
            
            const pct = (answeredQuestions.size / questions.length) * 100;
            document.getElementById('progress').style.width = `${pct}%`;
            document.getElementById('answered-count').innerText = `${answeredQuestions.size}/${questions.length} Answered`;
        }

        function updatePaginationUI() {
            const totalPages = Math.ceil(questions.length / questionsPerPage);
            
            ['top', 'bottom'].forEach(pos => {
                document.getElementById(`page-info-${pos}`).innerText = `Page ${currentPage + 1}/${totalPages || 1}`;
                
                const prevBtn = document.getElementById(`prev-btn-${pos}`);
                prevBtn.disabled = (currentPage === 0);
                prevBtn.classList.toggle('opacity-50', currentPage === 0);

                const nextBtn = document.getElementById(`next-btn-${pos}`);
                const submitBtn = document.getElementById(`submit-btn-${pos}`);

                if (currentPage >= totalPages - 1) {
                    nextBtn.classList.add('hidden');
                    submitBtn.classList.remove('hidden');
                } else {
                    nextBtn.classList.remove('hidden');
                    submitBtn.classList.add('hidden');
                }
            });
        }

        window.changePage = (step) => {
            const totalPages = Math.ceil(questions.length / questionsPerPage);
            const newPage = currentPage + step;
            if (newPage >= 0 && newPage < totalPages) {
                currentPage = newPage;
                renderExamPage();
            }
        }

        window.finishExam = async () => {
            document.getElementById('result-modal').classList.remove('hidden');
            document.getElementById('result-student-name').innerText = currentStudent.name;
            document.getElementById('final-score').innerText = score;
            const accuracy = questions.length > 0 ? Math.round((score / (questions.length * 10)) * 100) : 0;
            document.getElementById('accuracy').innerText = `${accuracy}%`;

            if(currentUser) {
                try {
                    const resultsRef = collection(db, 'artifacts', appId, 'public', 'data', 'exam_results');
                    await addDoc(resultsRef, {
                        name: currentStudent.name,
                        phone: currentStudent.phone,
                        score: score,
                        accuracy: accuracy,
                        examTitle: parsedTitle,
                        timestamp: Date.now().toString()
                    });
                    document.getElementById('sync-status-text').innerText = "Result saved to Global Merit List âœ“";
                    document.getElementById('sync-status-text').classList.replace('text-slate-500', 'text-emerald-500');
                } catch (e) {
                    document.getElementById('sync-status-text').innerText = "Failed to save online.";
                }
            }
        }


        // =============== PRACTICE VIEW ===============
        function initPracticeView() {
            hideAllViews();
            document.getElementById('practice-content').classList.remove('hidden');
            document.getElementById('practice-title').innerText = parsedTitle;
            document.getElementById('practice-subtitle').innerText = parsedSubtitle;
            
            const listContainer = document.getElementById('practice-list');
            let html = '';
            questions.forEach((q, qIndex) => {
                html += `
                <div class="bg-slate-900/50 p-6 rounded-2xl border border-white/5 mb-4 shadow-sm">
                    <h3 class="text-base font-bold mb-4 flex gap-3"><span class="text-blue-400 mt-0.5">${qIndex + 1}.</span> ${q.question}</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                `;
                q.options.forEach((opt, optIdx) => {
                    const isCorrect = (optIdx === q.correct);
                    const styleClass = isCorrect ? 'bg-emerald-600/20 border-emerald-500/50 text-emerald-400 font-bold' : 'bg-white/5 border-white/5 text-slate-500';
                    const icon = isCorrect ? '<i class="fa-solid fa-check-circle"></i>' : '';
                    html += `<div class="p-3 rounded-xl border ${styleClass} flex justify-between items-center text-sm">
                        <span>${opt}</span> ${icon}
                    </div>`;
                });
                html += `</div></div>`;
            });
            listContainer.innerHTML = html;
        }


        // =============== ARCHIVE VIEW ===============
        window.openArchiveView = () => {
            hideAllViews();
            document.getElementById('archive-content').classList.remove('hidden');
            const archiveList = document.getElementById('archive-list');
            
            if(!currentUser) return;

            const archiveRef = collection(db, 'artifacts', appId, 'public', 'data', 'exam_archives');
            
            onSnapshot(archiveRef, (snapshot) => {
                let html = '';
                if(snapshot.empty) {
                    archiveList.innerHTML = `<div class="glass p-10 text-center rounded-[2rem] border-dashed border-2 border-white/10"><p class="text-slate-400 font-medium">No previous question papers found.</p></div>`;
                    return;
                }

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    archiveCache[docSnap.id] = data;

                    const date = data.timestamp ? new Date(parseInt(data.timestamp)).toLocaleDateString() : 'Archive';
                    
                    html += `
                    <div class="bg-slate-900/60 p-6 rounded-2xl border border-white/5 flex flex-col md:flex-row justify-between items-center gap-4 hover:border-pink-500/30 transition-all">
                        <div class="text-center md:text-left w-full">
                            <h3 class="font-bold text-lg text-amber-400 leading-tight">${data.title}</h3>
                            <p class="text-sm text-slate-400 mt-1">${data.subtitle}</p>
                            <span class="text-[10px] text-slate-500 font-bold uppercase tracking-widest bg-white/5 px-2 py-1 rounded-md mt-2 inline-block"><i class="fa-regular fa-calendar mr-1"></i> ${date}</span>
                        </div>
                        
                        <div class="flex gap-2 mt-2 md:mt-0 w-full md:w-auto shrink-0">
                            <button onclick="loadArchiveExam('${docSnap.id}', 'practice')" class="flex-grow md:flex-grow-0 px-5 py-3 rounded-xl bg-blue-600/20 text-blue-400 border border-blue-500/30 hover:bg-blue-600 hover:text-white font-bold text-sm transition-all shadow-lg">
                                <i class="fa-solid fa-book-open-reader mr-1"></i> Practice
                            </button>
                            <button onclick="loadArchiveExam('${docSnap.id}', 'exam')" class="flex-grow md:flex-grow-0 px-5 py-3 rounded-xl bg-pink-600/20 text-pink-400 border border-pink-500/30 hover:bg-pink-600 hover:text-white font-bold text-sm transition-all shadow-lg">
                                <i class="fa-solid fa-pen-to-square mr-1"></i> Test
                            </button>
                        </div>
                    </div>`;
                });
                archiveList.innerHTML = html;
            });
        };

        window.loadArchiveExam = (docId, mode) => {
            const data = archiveCache[docId];
            if(!data) return;

            parsedTitle = data.title;
            parsedSubtitle = data.subtitle;
            
            const lines = data.questions.trim().split('\n').filter(l => l.trim() !== '');
            questions = lines.map(line => {
                const parts = line.split('|');
                return { question: parts[0], options: [parts[1], parts[2], parts[3], parts[4]], correct: parseInt(parts[5]) };
            });

            if(mode === 'practice') {
                initPracticeView();
            } else {
                initExamView();
            }
        };


        // =============== MERIT LIST ===============
        window.openLeaderboard = () => {
            document.getElementById('leaderboard-modal').classList.remove('hidden');
            const leaderboardBody = document.getElementById('leaderboard-body');
            
            const resultsRef = collection(db, 'artifacts', appId, 'public', 'data', 'exam_results');
            onSnapshot(resultsRef, (snapshot) => {
                let allResults = [];
                snapshot.forEach(docSnap => allResults.push(docSnap.data()));
                
                allResults.sort((a, b) => {
                    const scoreA = parseInt(a.score) || 0;
                    const scoreB = parseInt(b.score) || 0;
                    if (scoreB !== scoreA) return scoreB - scoreA;
                    return parseInt(b.timestamp || 0) - parseInt(a.timestamp || 0);
                });

                leaderboardBody.innerHTML = '';
                if(allResults.length === 0) {
                    leaderboardBody.innerHTML = '<tr><td colspan="4" class="p-10 text-center text-slate-500 italic">Merit list is empty.</td></tr>';
                    return;
                }

                allResults.forEach((res, index) => {
                    const rank = index + 1;
                    let rankClass = "bg-slate-800 text-slate-400";
                    if (rank === 1) rankClass = "rank-1";
                    if (rank === 2) rankClass = "rank-2";
                    if (rank === 3) rankClass = "rank-3";

                    const tr = document.createElement('tr');
                    tr.className = "border-b border-white/5 hover:bg-white/5 transition-colors";
                    tr.innerHTML = `
                        <td class="p-4 text-center">
                            <div class="rank-badge ${rankClass}">${rank}</div>
                        </td>
                        <td class="p-4">
                            <div class="font-bold text-slate-200">${res.name}</div>
                            <div class="text-[9px] text-slate-500 font-mono tracking-widest">${res.phone.substring(0,5)}******</div>
                        </td>
                        <td class="p-4 text-center">
                            <span class="bg-pink-600/10 text-pink-400 px-3 py-1 rounded-lg font-black text-sm">${res.score}</span>
                        </td>
                        <td class="p-4 text-right">
                            <span class="text-[10px] bg-white/5 px-2 py-1 rounded text-slate-400 font-bold truncate max-w-[100px] inline-block">${res.examTitle || 'Exam'}</span>
                        </td>
                    `;
                    leaderboardBody.appendChild(tr);
                });
            });
        };

        window.closeLeaderboard = () => document.getElementById('leaderboard-modal').classList.add('hidden');

    </script>
    <script type="module" src="tracker.js"></script>
</body>
</html>

