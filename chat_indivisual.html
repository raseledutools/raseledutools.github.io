<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>RasGram | Secure Messenger</title>
    <meta name="theme-color" content="#111b21">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        :root {
            --wa-bg: #111b21; --wa-panel: #202c33; --wa-green: #00a884;
            --wa-text: #e9edef; --wa-muted: #8696a0; --wa-border: #222d34;
        }

        html, body { 
            font-family: 'Inter', sans-serif; background-color: var(--wa-bg); color: var(--wa-text); 
            overflow: hidden; height: 100vh; width: 100vw; margin: 0; padding: 0;
            position: fixed; top: 0; left: 0; touch-action: none;
        }
        
        /* ðŸ”¥ FIX 1: Beautiful Chat Background without discoloring messages ðŸ”¥ */
        .chat-bg {
            background-color: #0b141a;
            /* Linear gradient acts as a dark overlay over the background image */
            background-image: linear-gradient(rgba(11, 20, 26, 0.85), rgba(11, 20, 26, 0.85)), url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-repeat: repeat;
        }

        body.light-mode { background-color: #f0f2f5 !important; color: #111b21 !important; }
        body.light-mode .bg-\[\#111b21\] { background-color: #f0f2f5 !important; }
        body.light-mode .bg-\[\#202c33\] { background-color: #ffffff !important; }
        body.light-mode .bg-\[\#222d34\] { background-color: #efeae2 !important; }
        body.light-mode .bg-\[\#005c4b\] { background-color: #d9fdd3 !important; }
        body.light-mode .text-white { color: #111b21 !important; }
        body.light-mode .text-\[\#e9edef\] { color: #111b21 !important; }
        body.light-mode .chat-bg { background-color: #efeae2 !important; background-image: linear-gradient(rgba(239, 234, 226, 0.6), rgba(239, 234, 226, 0.6)), url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png') !important; }

        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95) translateY(10px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
        .msg-bubble { animation: popIn 0.2s ease-out forwards; }
        .fade-in-anim { animation: popIn 0.3s ease-out forwards; }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(134, 150, 160, 0.3); border-radius: 10px; }
        
        .contact-active { background-color: #2a3942; border-left: 3px solid var(--wa-green); }
        .msg-selected { background-color: rgba(0, 168, 132, 0.3) !important; transition: all 0.3s ease; box-shadow: inset 0 0 0 2px var(--wa-green); }
        .dropdown-menu { display: none; }
        .dropdown-menu.show { display: block; animation: popIn 0.15s ease-out forwards; }

        audio { height: 40px; outline: none; border-radius: 20px; width: 100%; }
        .audio-slider { -webkit-appearance: none; background: rgba(255,255,255,0.2); height: 4px; border-radius: 5px; outline: none; }
        .audio-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%; background: #fff; cursor: pointer; }

        .loader-spinner { border: 3px solid rgba(255, 255, 255, 0.1); border-top: 3px solid var(--wa-green); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        body.light-mode .loader-spinner { border: 3px solid rgba(0, 0, 0, 0.1); border-top: 3px solid var(--wa-green); }
    </style>
    
   <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
   <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({ appId: "522b3136-c16d-4deb-8423-74dac3d6452e", notifyButton: { enable: true } });
        const userId = localStorage.getItem("pvt_chat_mobile"); if (userId) OneSignal.login(userId);
      });
   </script>
</head>
<body class="flex selection:bg-[#00a884]/30">

    <audio id="notification-sound" src="https://assets.mixkit.co/active_storage/sfx/2854/2854-preview.mp3" preload="auto"></audio>

    <div id="image-lightbox" class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/95 backdrop-blur-md transition-opacity opacity-0" onclick="closeLightbox()">
        <button onclick="closeLightbox()" class="absolute top-4 right-4 md:top-8 md:right-8 w-12 h-12 flex items-center justify-center rounded-full bg-white/10 text-white text-xl hover:bg-[#00a884] z-50 fixed"><i class="fa-solid fa-xmark"></i></button>
        <img id="lightbox-img" src="" class="m-auto max-w-full max-h-full object-contain p-2 md:p-8 transform scale-95 transition-transform duration-300 shadow-2xl rounded-xl cursor-zoom-in origin-center" onclick="event.stopPropagation(); this.classList.toggle('scale-150');">
    </div>

    <div id="join-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-[#111b21]">
        <div class="bg-[#202c33] p-8 rounded-2xl w-full max-w-sm shadow-2xl text-center fade-in-anim border border-[#222d34]">
            <div class="w-20 h-20 bg-[#00a884]/10 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fa-solid fa-shield-halved text-4xl text-[#00a884]"></i></div>
            <h2 class="text-2xl font-bold mb-2 text-white">Secure RasGram</h2>
            <p class="text-[#8696a0] text-sm mb-6 font-medium">Log in or create your account.</p>
            <form id="join-form" class="space-y-4">
                <input type="text" id="reg-name" required autocomplete="off" class="w-full bg-[#111b21] border border-[#222d34] rounded-lg p-3 text-white outline-none focus:border-[#00a884]" placeholder="Your Name">
                <input type="tel" id="reg-mobile" required autocomplete="off" pattern="[0-9]{11}" class="w-full bg-[#111b21] border border-[#222d34] rounded-lg p-3 text-white outline-none focus:border-[#00a884]" placeholder="Mobile Number (11 digits)">
                <input type="password" id="reg-password" required autocomplete="off" minlength="4" class="w-full bg-[#111b21] border border-[#222d34] rounded-lg p-3 text-white outline-none focus:border-[#00a884] tracking-widest text-center text-lg" placeholder="PIN / Password">
                <button type="submit" id="join-btn" class="w-full bg-[#00a884] py-3 rounded-lg text-[#111b21] font-bold uppercase mt-4">Secure Login</button>
            </form>
        </div>
    </div>

    <div id="group-modal" class="hidden fixed inset-0 z-[150] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"><div class="bg-[#202c33] rounded-2xl w-full max-w-md shadow-2xl flex flex-col max-h-[80vh] fade-in-anim"><div class="p-4 border-b border-[#222d34] flex justify-between items-center"><h2 class="text-xl font-bold text-white">New Group</h2><button onclick="closeGroupModal()" class="text-[#8696a0] hover:text-white w-8 h-8 rounded-full"><i class="fa-solid fa-xmark text-xl"></i></button></div><div class="p-4 border-b border-[#222d34]"><input type="text" id="group-name" class="w-full bg-[#111b21] border border-[#222d34] rounded-lg p-3 text-white focus:border-[#00a884]" placeholder="Group Subject"></div><div class="p-2 overflow-y-auto custom-scroll flex-grow" id="group-contact-list"></div><div class="p-4 border-t border-[#222d34]"><button onclick="createGroup()" class="w-full bg-[#00a884] text-[#111b21] font-bold py-3 rounded-lg">Create Group</button></div></div></div>
    <div id="add-lock-modal" class="hidden fixed inset-0 z-[170] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"><div class="bg-[#202c33] rounded-2xl w-full max-w-md shadow-2xl flex flex-col max-h-[80vh] fade-in-anim"><div class="p-4 border-b border-[#222d34] flex justify-between items-center"><h2 class="text-xl font-bold text-white">Select Chats to Lock</h2><button onclick="closeAddLockModal()" class="text-[#8696a0] hover:text-white w-8 h-8 rounded-full"><i class="fa-solid fa-xmark text-xl"></i></button></div><div class="p-2 overflow-y-auto custom-scroll flex-grow" id="unlocked-contact-list"></div><div class="p-4 border-t border-[#222d34]"><button onclick="addSelectedToLock()" class="w-full bg-[#00a884] text-[#111b21] font-bold py-3 rounded-lg">Lock Selected Chats</button></div></div></div>
    <div id="pin-modal" class="hidden fixed inset-0 z-[160] flex items-center justify-center p-4 bg-black/90 backdrop-blur-md"><div class="bg-[#202c33] rounded-2xl p-6 w-full max-w-sm text-center shadow-2xl border border-[#222d34] fade-in-anim"><div class="w-16 h-16 bg-[#00a884]/20 text-[#00a884] rounded-full flex items-center justify-center text-2xl mx-auto mb-4"><i class="fa-solid fa-lock"></i></div><h2 class="text-xl font-bold text-white mb-2" id="pin-title">Enter PIN</h2><input type="password" id="pin-input" class="w-full bg-[#111b21] border border-[#222d34] rounded-lg p-3 text-center text-white focus:border-[#00a884] mb-6 text-2xl tracking-[0.5em] font-bold" maxlength="4" placeholder="â€¢â€¢â€¢â€¢"><div class="flex gap-3"><button onclick="closePinModal()" class="flex-1 bg-transparent text-white py-3 rounded-lg border border-[#222d34]">Cancel</button><button id="pin-action-btn" onclick="handlePinAction()" class="flex-1 bg-[#00a884] text-[#111b21] font-bold py-3 rounded-lg">Unlock</button></div></div></div>
    <div id="settings-modal" class="hidden fixed inset-0 z-[150] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"><div class="bg-[#202c33] border border-[#222d34] p-8 rounded-2xl w-full max-w-sm shadow-2xl text-center relative fade-in-anim"><button onclick="closeSettings()" class="absolute top-4 right-4 w-8 h-8 rounded-full text-[#8696a0] hover:text-white"><i class="fa-solid fa-xmark"></i></button><h2 class="text-xl font-bold mb-6 text-white">Profile</h2><div class="relative w-36 h-36 mx-auto mb-6 group cursor-pointer" onclick="document.getElementById('profile-pic-input').click()"><img id="settings-avatar-preview" src="" class="w-full h-full rounded-full object-cover bg-[#111b21] shadow-lg border border-[#222d34]"><div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 bg-black/50 rounded-full"><i class="fa-solid fa-camera text-3xl text-white"></i></div></div><input type="file" id="profile-pic-input" accept="image/*" class="hidden" onchange="previewProfilePic(event)"><div class="mb-6 text-left border-b border-[#00a884] pb-2"><label class="text-[#00a884] text-sm font-bold mb-1 block">Your Name</label><input type="text" id="settings-name-input" class="w-full bg-transparent p-1 text-white focus:outline-none text-[17px] font-medium" placeholder="Enter your name"></div><button id="save-settings-btn" onclick="saveProfileSettings()" class="w-full bg-[#00a884] py-3 rounded-lg text-[#111b21] font-bold">Save</button></div></div>
    <div id="forward-modal" class="hidden fixed inset-0 z-[350] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm"><div class="bg-[#202c33] rounded-2xl w-full max-w-md shadow-2xl flex flex-col max-h-[80vh] fade-in-anim"><div class="p-4 border-b border-[#222d34] flex justify-between items-center"><h2 class="text-xl font-bold text-white">Forward to...</h2><button onclick="closeForwardModal()" class="text-[#8696a0] hover:text-white w-8 h-8 rounded-full"><i class="fa-solid fa-xmark text-xl"></i></button></div><div class="p-2 overflow-y-auto custom-scroll flex-grow" id="forward-contact-list"></div><div class="p-4 border-t border-[#222d34]"><button onclick="executeForward()" class="w-full bg-[#00a884] text-[#111b21] font-bold py-3 rounded-lg"><i class="fa-solid fa-paper-plane mr-2"></i> Forward</button></div></div></div>

    <div id="app-container" class="hidden absolute top-0 left-0 w-full mx-auto md:py-0 md:px-0" style="height: 100%;">
        <div class="w-full h-full flex bg-[#111b21] overflow-hidden relative">
            
            <div id="sidebar" class="w-full md:w-[400px] flex flex-col border-r border-[#222d34] bg-[#111b21] z-20 flex-shrink-0 absolute md:relative inset-0 md:inset-auto slide-in-anim">
                <header class="p-3 bg-[#111b21] flex items-center justify-between shrink-0 h-[64px]">
                    <div class="flex items-center gap-3">
                        <img id="my-avatar" src="" onclick="openSettings()" class="w-9 h-9 rounded-full object-cover cursor-pointer hover:opacity-80 transition-opacity bg-[#202c33]">
                        <h1 class="text-white text-[21px] font-bold tracking-wide cursor-default">Ras<span class="text-[#00a884]">Gram</span></h1>
                    </div>
                    <div class="flex items-center gap-4 text-[#aebac1] text-[18px]">
                        <button title="Camera" class="hover:text-white transition-colors"><i class="fa-solid fa-camera"></i></button>
                        <div class="relative">
                            <button onclick="toggleSidebarMenu(event)" class="px-2 hover:text-white transition-colors"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                            <div id="sidebar-dropdown" class="dropdown-menu absolute top-full right-0 mt-2 w-56 bg-[#233138] rounded-md shadow-xl py-2 z-50 border border-[#222d34]">
                                <button onclick="openGroupModal()" class="w-full text-left px-5 py-3 text-[16px] text-[#d1d7db] hover:bg-[#111b21]"><i class="fa-solid fa-users w-5 text-center text-[#8696a0]"></i> New Group</button>
                                <button onclick="openSettings()" class="w-full text-left px-5 py-3 text-[16px] text-[#d1d7db] hover:bg-[#111b21]"><i class="fa-solid fa-gear w-5 text-center text-[#8696a0]"></i> Settings</button>
                                <button onclick="toggleTheme()" class="w-full text-left px-5 py-3 text-[16px] text-[#d1d7db] hover:bg-[#111b21] border-t border-[#222d34]"><i id="theme-icon" class="fa-solid fa-sun w-5 text-center text-[#8696a0]"></i> <span id="theme-text">Light Mode</span></button>
                                <button onclick="toggleActiveStatus()" class="w-full text-left px-5 py-3 text-[16px] text-[#d1d7db] hover:bg-[#111b21] border-t border-[#222d34]"><i id="status-icon" class="fa-solid fa-eye-slash w-5 text-center text-[#8696a0]"></i> <span id="status-toggle-text">Active Status</span></button>
                                <button onclick="openLockedChats()" class="w-full text-left px-5 py-3 text-[16px] text-[#d1d7db] hover:bg-[#111b21] border-t border-[#222d34]"><i class="fa-solid fa-lock w-5 text-center text-[#00a884]"></i> Locked chats</button>
                                <button onclick="logoutPvtChat()" class="w-full text-left px-5 py-3 text-[16px] text-[#f15c6d] hover:bg-[#111b21] border-t border-[#222d34]"><i class="fa-solid fa-right-from-bracket w-5 text-center"></i> Log out</button>
                            </div>
                        </div>
                    </div>
                </header>

                <div class="px-2 pb-2 border-b border-[#222d34] bg-[#111b21] shrink-0">
                    <div class="bg-[#202c33] rounded-full flex items-center px-4 py-1.5 focus-within:bg-[#111b21] border border-transparent focus-within:border-[#00a884]/50 transition-colors">
                        <i class="fa-solid fa-magnifying-glass text-[#8696a0]"></i>
                        <input type="text" id="search-input" placeholder="Search chats" class="bg-transparent border-none outline-none text-white w-full ml-4 font-medium py-1">
                    </div>
                </div>

                <div id="locked-indicator" class="hidden px-4 py-3.5 border-b border-[#222d34] flex items-center gap-4 cursor-pointer hover:bg-[#202c33]" onclick="openLockedChats()">
                    <div class="w-11 h-11 rounded-full bg-[#00a884]/10 text-[#00a884] flex items-center justify-center text-lg"><i class="fa-solid fa-lock"></i></div>
                    <span class="text-white font-semibold text-[17px]">Locked chats</span>
                </div>

                <div id="locked-header-bar" class="hidden px-4 py-3.5 bg-[#202c33] border-b border-[#222d34] flex items-center justify-between shadow-sm z-10">
                    <div class="flex items-center gap-3 cursor-pointer text-[#00a884] font-medium hover:text-white" onclick="closeLockedChats()"><i class="fa-solid fa-arrow-left"></i><span>Locked Chats</span></div>
                    <button onclick="openAddLockModal()" class="w-9 h-9 rounded-full bg-[#00a884]/20 text-[#00a884] flex items-center justify-center text-lg"><i class="fa-solid fa-plus"></i></button>
                </div>

                <div id="contacts-list" class="flex-grow overflow-y-auto custom-scroll relative bg-[#111b21]" style="touch-action: pan-y;">
                    <div id="contacts-container">
                        <div class="text-center text-[#8696a0] p-8">
                            <div class="loader-spinner"></div>
                            <p class="text-sm mt-3 font-medium">Loading chats...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chat-area" class="w-full hidden flex-col relative h-full bg-[#222d34]">
                
                <div id="empty-chat-state" class="absolute inset-0 z-40 flex flex-col items-center justify-center bg-[#222d34] border-l border-[#222d34] fade-in-anim">
                    <div class="w-32 h-32 bg-[#202c33] rounded-full flex items-center justify-center mb-8 shadow-xl"><i class="fa-solid fa-shield-halved text-[4.5rem] text-[#00a884]"></i></div>
                    <h2 class="text-4xl font-light text-white mb-4">RasGram Web</h2>
                    <p class="text-[#8696a0] text-[16px] max-w-md text-center px-4 font-medium leading-relaxed">Send and receive messages securely.<br>End-to-end encrypted.</p>
                </div>

                <div id="selection-header" class="hidden absolute top-0 left-0 w-full h-[64px] bg-[#202c33] z-50 flex items-center justify-between px-4 shadow-md border-l border-[#222d34]">
                    <div class="flex items-center gap-4 text-white">
                        <button onclick="clearSelection()" class="text-[#8696a0] hover:text-white text-xl"><i class="fa-solid fa-arrow-left"></i></button>
                        <span id="select-count" class="font-bold text-lg">1</span>
                    </div>
                    <div class="flex items-center gap-5 text-[#8696a0] text-xl">
                        <button onclick="openForwardModal()" class="hover:text-white" title="Forward"><i class="fa-solid fa-share"></i></button>
                        <button onclick="deleteSelectedMsgs()" class="hover:text-[#f15c6d]" title="Delete"><i class="fa-solid fa-trash-can"></i></button>
                    </div>
                </div>

                <header class="p-2 md:p-3 bg-[#202c33] flex items-center justify-between shrink-0 h-[64px] relative z-30 border-l border-[#222d34]">
                    <div class="flex items-center gap-4">
                        <button onclick="closeChatMobile()" class="md:hidden w-10 h-10 flex items-center justify-center rounded-full text-[#aebac1] hover:bg-[#111b21] shrink-0 text-xl"><i class="fa-solid fa-arrow-left"></i></button>
                        <div class="flex items-center gap-4 cursor-pointer">
                            <img id="active-chat-avatar" src="" class="w-10 h-10 rounded-full object-cover bg-[#111b21]">
                            <div class="flex flex-col justify-center">
                                <h2 id="active-chat-name" class="font-bold text-white text-[17.5px] leading-tight">Contact</h2>
                                <p id="active-chat-status" class="text-[13px] text-[#00a884] font-medium mt-0.5 empty:hidden"></p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-5 text-[#aebac1] pr-2 text-[18px]">
                        <button onclick="startCall('video')" class="hover:text-white"><i class="fa-solid fa-video"></i></button>
                        <button onclick="startCall('audio')" class="hover:text-white"><i class="fa-solid fa-phone"></i></button>
                        <div class="w-[1px] h-6 bg-[#374045] mx-1 hidden md:block"></div>
                        <div class="relative">
                            <button onclick="toggleChatMenu(event)" class="px-2 hover:text-white"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                            <div id="chat-dropdown" class="dropdown-menu absolute top-full right-0 mt-2 bg-[#233138] border border-[#222d34] rounded-md shadow-xl py-2 w-52 z-50">
                                <button onclick="toggleLockCurrentChat(event)" id="lock-chat-btn" class="w-full text-left px-5 py-3 text-[16px] text-[#d1d7db] hover:bg-[#111b21]">Lock chat</button>
                                <button onclick="clearEntireChat()" class="w-full text-left px-5 py-3 text-[16px] text-[#f15c6d] hover:bg-[#111b21] flex items-center gap-3"><i class="fa-solid fa-trash-can w-5"></i> Clear chat</button>
                            </div>
                        </div>
                    </div>
                </header>

                <main id="messages-box" class="flex-grow chat-bg overflow-y-auto p-4 md:p-6 flex flex-col gap-1 custom-scroll relative z-20" onclick="closeAllMenus()"></main>

                <footer class="bg-[#202c33] px-3 py-2 flex flex-col shrink-0 z-30 relative">
                    <div id="file-preview-container" class="hidden w-full px-2 mb-2"><div class="bg-[#111b21] border border-[#222d34] rounded-xl p-3 flex items-center justify-between"><div class="flex items-center gap-4 overflow-hidden"><div id="preview-icon-wrapper" class="w-14 h-14 rounded-lg bg-[#202c33] text-[#00a884] flex items-center justify-center shrink-0 border border-[#222d34] overflow-hidden relative"><i id="preview-icon" class="fa-solid fa-file text-2xl"></i><img id="preview-img" src="" class="hidden w-full h-full object-cover absolute inset-0"></div><div class="overflow-hidden"><p id="file-preview-name" class="text-[15px] font-medium text-white truncate w-48 md:w-72">filename</p><p id="file-preview-size" class="text-[13px] text-[#8696a0] mt-0.5">0 MB</p></div></div><button type="button" onclick="clearFile()" class="text-[#8696a0] hover:text-[#f15c6d] w-12 h-12 flex items-center justify-center rounded-full bg-[#202c33]"><i class="fa-solid fa-xmark text-xl"></i></button></div></div>
                    <div id="recording-ui" class="hidden flex items-center justify-between bg-[#111b21] rounded-lg p-2 mb-2 border border-[#f15c6d]/30"><div class="flex items-center gap-3 text-[#f15c6d] pl-4 font-bold animate-pulse"><i class="fa-solid fa-microphone-lines text-xl"></i> Recording...</div><div class="flex gap-3"><button type="button" onclick="cancelRecording()" class="w-11 h-11 rounded-full text-[#8696a0] bg-[#202c33]"><i class="fa-solid fa-trash-can"></i></button><button type="button" onclick="stopAndSendRecording()" class="w-11 h-11 rounded-full bg-[#00a884] text-[#111b21]"><i class="fa-solid fa-paper-plane"></i></button></div></div>
                    <div id="reply-preview-container" class="hidden bg-[#2a3942] mx-2 mb-2 p-2 rounded-lg border-l-4 border-[#00a884] flex justify-between items-center shadow-md"><div class="overflow-hidden pr-2"><p class="text-[#00a884] text-xs font-bold mb-0.5"><i class="fa-solid fa-reply mr-1"></i>Replying</p><p id="reply-preview-text" class="text-[#e9edef] text-sm truncate w-64 md:w-96 whitespace-nowrap"></p></div><button onclick="cancelReply()" type="button" class="text-[#8696a0] hover:text-[#f15c6d] w-8 h-8 rounded-full flex items-center justify-center transition-colors bg-[#202c33]"><i class="fa-solid fa-xmark"></i></button></div>

                    <form id="chat-form" class="flex items-end gap-2 w-full relative min-h-[48px]">
                        <button type="button" onclick="document.getElementById('file-input').click()" class="w-11 h-11 shrink-0 text-[#8696a0] hover:text-white flex items-center justify-center mb-0.5"><i class="fa-solid fa-paperclip text-[22px]"></i></button>
                        <input type="file" id="file-input" class="hidden">
                        <div class="flex-grow bg-[#2a3942] rounded-xl flex items-center px-4 py-2 transition-all shadow-inner"><textarea id="msg-input" rows="1" placeholder="Type a message" class="w-full bg-transparent text-white focus:outline-none resize-none max-h-32 custom-scroll text-[16px] placeholder-[#8696a0]" style="min-height: 24px; padding-top: 4px;"></textarea></div>
                        <button type="button" id="mic-btn" onclick="startRecording()" class="w-11 h-11 shrink-0 text-[#8696a0] hover:text-white flex items-center justify-center mb-0.5"><i class="fa-solid fa-microphone text-[22px]"></i></button>
                        <button type="submit" id="send-btn" class="hidden w-11 h-11 shrink-0 text-[#8696a0] hover:text-[#00a884] flex items-center justify-center mb-0.5"><i class="fa-solid fa-paper-plane text-[22px] ml-1"></i></button>
                    </form>
                </footer>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, deleteDoc, updateDoc, onSnapshot, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Dexie Local DB
        const localDB = new Dexie("RasGramDB");
        localDB.version(2).stores({ chatHistory: 'chatId, messages', outbox: '++id, chatId, text, senderMobile, timestamp, timeString, fileUrl, fileName, fileType, reaction, read, isPending, replyToText' });

        // Security
        const SECRET_SALT = "RasGram_E2EE_Pro_Key_2026";
        function hashPassword(password) { return CryptoJS.SHA256(password).toString(); }
        function encryptText(text, chatId) { if (!text) return text; return CryptoJS.AES.encrypt(text, chatId + SECRET_SALT).toString(); }
        function decryptText(cipherText, chatId) { if (!cipherText) return cipherText; try { const bytes = CryptoJS.AES.decrypt(cipherText, chatId + SECRET_SALT); const original = bytes.toString(CryptoJS.enc.Utf8); return original || cipherText; } catch (e) { return cipherText; } }

        // States
        let isDataLoading = true;
        let selectedMsgs = new Set(); let pressTimer; let currentReplyContext = null;
        let myName = localStorage.getItem('pvt_chat_name') || ''; let myMobile = localStorage.getItem('pvt_chat_mobile') || ''; let myAvatarUrl = localStorage.getItem('pvt_chat_avatar') || ''; let myPassword = localStorage.getItem('pvt_chat_password') || ''; 
        let isStatusVisible = localStorage.getItem('status_visible') !== 'false';
        let activeContactMobile = null; let allUsers = []; let latestMessages = {}; let chatListeners = {};  
        let lockedContacts = JSON.parse(localStorage.getItem('locked_contacts') || '[]'); let userPin = localStorage.getItem('nexus_pin') || null; let isViewingLocked = false;
        let currentChatUnsubscribe = null; let userStatusUnsubscribe = null; let activeTrackingInterval = null; let selectedFile = null; let typingTimeout = null; let isTyping = false; 
        let mediaRecorder; let audioChunks = []; let isRecording = false; let settingsSelectedFile = null;

        // Firebase Config
        const firebaseConfig = { apiKey: "AIzaSyDGd3KAo45UuqmeGFALziz_oKm3htEASHY", authDomain: "mywebtools-f8d53.firebaseapp.com", projectId: "mywebtools-f8d53", storageBucket: "mywebtools-f8d53.firebasestorage.app", messagingSenderId: "979594414301", appId: "1:979594414301:web:7048c995e56e331a85f334" };
        const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/de2w78yxh/auto/upload"; const CLOUDINARY_UPLOAD_PRESET = "ml_default"; const SYNC_APP_ID = "rasel-mia-universal-sync";
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);

        // Utilities
        function getAvatarUrl(name, customUrl) { return customUrl ? customUrl : `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=8696a0&color=fff&bold=true`; }
        function formatTime(seconds) { if(!seconds || isNaN(seconds)) return "0:00"; const m = Math.floor(seconds / 60); const s = Math.floor(seconds % 60); return `${m}:${s < 10 ? '0' : ''}${s}`; }
        function escapeHTML(str) { return str.replace(/[&<>'"]/g, tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag] || tag)); }

        // App Initialization Logic
        if (myName && myMobile && myPassword) {
            document.getElementById('join-modal').style.display = 'none'; // Prevent flicker
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('flex');
            startApp(); 
        } else {
            document.getElementById('join-modal').classList.remove('hidden');
        }

        // ðŸ”¥ FIX 3: Password Database Hash Logic ðŸ”¥
        document.getElementById('join-form').onsubmit = async (e) => {
            e.preventDefault(); 
            const n = document.getElementById('reg-name').value.trim(); 
            const m = document.getElementById('reg-mobile').value.trim(); 
            const p = document.getElementById('reg-password').value.trim(); 
            const joinBtn = document.getElementById('join-btn');
            
            const hashedPassword = hashPassword(p);
            
            if (n && m.length === 11 && p.length >= 4) {
                const originalText = joinBtn.innerHTML; 
                joinBtn.disabled = true; joinBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Loading...';
                
                try {
                    await signInAnonymously(auth); 
                    const userRef = doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users', m); 
                    const userSnap = await getDoc(userRef);
                    
                    if (userSnap.exists()) { 
                        const dbData = userSnap.data(); 
                        
                        if (!dbData.password) { 
                            await updateDoc(userRef, { password: hashedPassword, name: n }); 
                            myName = n;
                        } 
                        // Check if password matches EITHER the Hash OR the Plaintext in DB
                        else if (dbData.password !== hashedPassword && dbData.password !== p) { 
                            alert("à¦­à§à¦² à¦ªà¦¾à¦¸à¦“à§Ÿà¦¾à¦°à§à¦¡! à¦¦à§Ÿà¦¾ à¦•à¦°à§‡ à¦¸à¦ à¦¿à¦• à¦ªà¦¿à¦¨ à¦¦à¦¿à¦¨à¥¤"); 
                            joinBtn.disabled = false; joinBtn.innerHTML = originalText; 
                            return; 
                        } 
                        else {
                            // Automatically SECURE the plaintext password in DB
                            if (dbData.password === p) {
                                await updateDoc(userRef, { password: hashedPassword });
                            }
                            myName = dbData.name || n;
                            if(dbData.avatarUrl) myAvatarUrl = dbData.avatarUrl;
                        }
                    } else { 
                        await setDoc(userRef, { name: n, mobile: m, password: hashedPassword, lastActive: Date.now(), typingTo: null, avatarUrl: '', statusVisible: true }); 
                        myName = n;
                    }
                    
                    myMobile = m; myPassword = hashedPassword; 
                    localStorage.setItem('pvt_chat_name', myName); localStorage.setItem('pvt_chat_mobile', myMobile); localStorage.setItem('pvt_chat_password', myPassword); 
                    if(myAvatarUrl) localStorage.setItem('pvt_chat_avatar', myAvatarUrl);
                    
                    document.getElementById('join-modal').classList.add('hidden'); 
                    document.getElementById('app-container').classList.remove('hidden'); document.getElementById('app-container').classList.add('flex');
                    startApp();
                } catch (err) { alert("Connection error!"); joinBtn.disabled = false; joinBtn.innerHTML = originalText; }
            } else alert("à¦¸à¦ à¦¿à¦• à¦¤à¦¥à§à¦¯ à¦¦à¦¿à¦¨à¥¤");
        };

        async function startApp() {
            document.getElementById('my-avatar').src = getAvatarUrl(myName, myAvatarUrl);
            
            const cachedUsers = localStorage.getItem('cached_users'); 
            if (cachedUsers) { allUsers = JSON.parse(cachedUsers); isDataLoading = false; }
            const cachedMsgs = localStorage.getItem('cached_latest_msgs'); 
            if (cachedMsgs) latestMessages = JSON.parse(cachedMsgs);
            
            if(allUsers.length > 0) renderContacts();

            try {
                await signInAnonymously(auth);
                const updateMyStatus = async () => { await setDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users', myMobile), { name: myName, mobile: myMobile, lastActive: Date.now(), statusVisible: isStatusVisible }, { merge: true }); };
                updateMyStatus(); activeTrackingInterval = setInterval(updateMyStatus, 60000); 
                listenForUsers();
            } catch (err) {}
        }

        function listenForUsers() {
            onSnapshot(collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users'), (snapshot) => {
                allUsers = []; 
                snapshot.forEach(doc => { const data = doc.data(); if (data.mobile !== myMobile) { allUsers.push(data); setupLastMessageListener(data.mobile); } });
                
                isDataLoading = false; // Data successfully fetched, stop spinner!
                localStorage.setItem('cached_users', JSON.stringify(allUsers)); 
                renderContacts();
            });
        }

        function setupLastMessageListener(contactMobile) {
            if (chatListeners[contactMobile]) return; const chatId = generateChatId(myMobile, contactMobile);
            chatListeners[contactMobile] = onSnapshot(query(collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${chatId}`), orderBy('timestamp', 'desc'), limit(1)), (snapshot) => {
                if (!snapshot.empty) {
                    const newLatest = snapshot.docs[0].data(); const oldLatest = latestMessages[contactMobile];
                    latestMessages[contactMobile] = newLatest;
                } else latestMessages[contactMobile] = null;
                localStorage.setItem('cached_latest_msgs', JSON.stringify(latestMessages)); 
                renderContacts();
            });
        }

        // ðŸ”¥ FIX 2: Correct Spinner Removal Logic ðŸ”¥
        const searchInput = document.getElementById('search-input');
        const contactsContainer = document.getElementById('contacts-container');
        
        function renderContacts() {
            if (isDataLoading) {
                contactsContainer.innerHTML = `<div class="text-center text-[#8696a0] p-8"><div class="loader-spinner"></div><p class="text-sm mt-3 font-medium">Loading chats...</p></div>`;
                return;
            }

            const term = searchInput.value.toLowerCase();
            let displayUsers = allUsers.filter(u => isViewingLocked ? lockedContacts.includes(u.mobile) : !lockedContacts.includes(u.mobile));
            displayUsers = displayUsers.filter(u => u.name.toLowerCase().includes(term) || u.mobile.includes(term));
            displayUsers.sort((a, b) => { return (latestMessages[b.mobile]?.timestamp || parseInt(b.lastActive) || 0) - (latestMessages[a.mobile]?.timestamp || parseInt(a.lastActive) || 0); });

            if (displayUsers.length === 0) {
                contactsContainer.innerHTML = `<p class="text-center text-[#8696a0] text-[16px] mt-10 p-6">No chats found.</p>`;
                return;
            }
            
            let tempHTML = '';
            displayUsers.forEach(user => {
                const isActive = activeContactMobile === user.mobile; const activeClass = isActive ? 'contact-active' : 'hover:bg-[#202c33]';
                const latestMsg = latestMessages[user.mobile]; let msgPreview = "Tap to chat..."; let timeString = ""; let isUnread = false; let previewClass = "text-[#8696a0]";

                if (latestMsg) {
                    const isMe = latestMsg.senderMobile === myMobile; let tickClass = latestMsg.read ? "text-[#53bdeb]" : "text-[#8696a0]"; const prefix = isMe ? `<i class='fa-solid fa-check-double text-[12px] mr-1 ${tickClass}'></i> ` : "";
                    if(latestMsg.isCallLog) { msgPreview = `<i class='fa-solid fa-phone mr-1'></i> Call`; }
                    else if (latestMsg.text) msgPreview = prefix + escapeHTML(decryptText(latestMsg.text, generateChatId(myMobile, user.mobile)));
                    else if (latestMsg.fileUrl) msgPreview = prefix + "<i class='fa-solid fa-file mr-1'></i> Attachment";
                    timeString = latestMsg.timeString || ""; if (!isMe && latestMsg.timestamp > parseInt(localStorage.getItem(`read_${user.mobile}`) || '0') && !latestMsg.read) { isUnread = true; previewClass = "text-white font-medium"; }
                }

                let unreadBadge = isUnread ? `<span class="bg-[#00a884] text-[#111b21] text-[11px] font-bold px-2 py-0.5 rounded-full ml-2">New</span>` : ``;
                if(user.typingTo === myMobile) { msgPreview = "<span class='text-[#00a884] font-medium text-[14px]'>typing...</span>"; previewClass = ""; unreadBadge = ""; }

                const userAvatar = getAvatarUrl(user.name, user.avatarUrl);
                tempHTML += `
                <div class="flex items-center cursor-pointer transition-colors p-3.5 border-b border-[#222d34] ${activeClass} group relative" onclick="openPrivateChat('${user.name}', '${user.mobile}', '${userAvatar}')">
                    <img src="${userAvatar}" class="w-12 h-12 rounded-full object-cover bg-[#111b21] shrink-0 mr-4">
                    <div class="flex-grow flex flex-col justify-center overflow-hidden">
                        <div class="flex justify-between items-center mb-1"><h3 class="text-[17.5px] font-bold text-white truncate">${user.name}</h3><span class="text-[12px] ${isUnread ? 'text-[#00a884] font-medium' : 'text-[#8696a0]'} shrink-0">${timeString}</span></div>
                        <div class="flex justify-between items-center gap-2"><p class="text-[14px] ${previewClass} truncate w-full">${msgPreview}</p>${unreadBadge}</div>
                    </div>
                </div>`;
            });
            contactsContainer.innerHTML = tempHTML;
        }
        searchInput.addEventListener('input', renderContacts);

        window.openPrivateChat = async (contactName, contactMobile, contactAvatarUrl) => {
            activeContactMobile = contactMobile; localStorage.setItem(`read_${contactMobile}`, Date.now()); clearSelection(); cancelReply();
            document.getElementById('active-chat-name').innerText = contactName; document.getElementById('active-chat-avatar').src = contactAvatarUrl; document.getElementById('empty-chat-state').classList.add('hidden');
            
            const chatArea = document.getElementById('chat-area');
            if (window.innerWidth < 768) { document.getElementById('sidebar').classList.add('hidden'); chatArea.classList.remove('hidden'); chatArea.classList.add('flex'); } 
            else { chatArea.classList.remove('hidden'); chatArea.classList.add('flex'); }

            renderContacts(); 
            const msgBox = document.getElementById('messages-box');
            const chatId = generateChatId(myMobile, contactMobile);
            
            let msgs = []; const cachedRecord = await localDB.chatHistory.get(chatId);
            if(cachedRecord && cachedRecord.messages) { msgBox.innerHTML = ''; cachedRecord.messages.forEach(mData => msgBox.appendChild(createMessageElement(mData.id, mData, contactName))); msgBox.scrollTop = msgBox.scrollHeight; }

            if(userStatusUnsubscribe) userStatusUnsubscribe();
            userStatusUnsubscribe = onSnapshot(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users', contactMobile), (docSnap) => {
                const statusElem = document.getElementById('active-chat-status');
                if(docSnap.exists()){
                    const uData = docSnap.data(); if(uData.typingTo === myMobile) { statusElem.innerText = 'typing...'; statusElem.classList.remove('hidden'); } else { const isOnline = (Date.now() - uData.lastActive) < 120000; statusElem.innerText = isOnline ? 'Online' : ''; if(!isOnline) statusElem.classList.add('hidden'); else statusElem.classList.remove('hidden'); }
                }
            });

            if (currentChatUnsubscribe) currentChatUnsubscribe();
            let isFirstLoad = true;
            currentChatUnsubscribe = onSnapshot(query(collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${chatId}`), orderBy('timestamp', 'asc')), (snapshot) => {
                let cacheArray = []; 
                if(isFirstLoad && !cachedRecord) { msgBox.innerHTML = ''; } isFirstLoad = false;
                snapshot.docChanges().forEach(change => {
                    const mData = change.doc.data(); mData.id = change.doc.id;
                    if (!mData.read && mData.senderMobile !== myMobile) updateDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${chatId}`, change.doc.id), { read: true });
                    const oldNode = document.getElementById(`msg-${change.doc.id}`);
                    if(change.type === "added" && !oldNode) msgBox.appendChild(createMessageElement(change.doc.id, mData, contactName));
                    else if(change.type === "modified" && oldNode) oldNode.replaceWith(createMessageElement(change.doc.id, mData, contactName));
                    else if(change.type === "removed" && oldNode) oldNode.remove();
                });
                snapshot.docs.forEach(doc => { let d = doc.data(); d.id = doc.id; cacheArray.push(d); }); localDB.chatHistory.put({ chatId: chatId, messages: cacheArray });
                localStorage.setItem(`read_${activeContactMobile}`, Date.now()); renderContacts(); setTimeout(() => msgBox.scrollTop = msgBox.scrollHeight, 100);
            });
        };

        const chatForm = document.getElementById('chat-form');
        const msgInput = document.getElementById('msg-input');
        chatForm.onsubmit = async (e) => {
            e.preventDefault(); const text = msgInput.value.trim(); if ((!text && !selectedFile) || !activeContactMobile) return;
            const sendBtn = document.getElementById('send-btn'); sendBtn.disabled = true; sendBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-[22px] text-[#00a884]"></i>';
            setDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', 'chat_users', myMobile), { typingTo: null }, { merge: true });
            
            const chatId = generateChatId(myMobile, activeContactMobile);
            const encText = encryptText(text, chatId);
            const encReplyText = currentReplyContext ? encryptText(currentReplyContext, chatId) : null;
            const msgData = { text: encText, replyToText: encReplyText, senderMobile: myMobile, timestamp: Date.now(), timeString: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), fileUrl: null, fileName: null, fileType: null, reaction: null, read: false };

            try {
                if (selectedFile) { const uploadResult = await uploadFileWithProgress(selectedFile); if(uploadResult.secure_url) { msgData.fileUrl = uploadResult.secure_url; msgData.fileName = selectedFile.name; msgData.fileType = selectedFile.type || 'audio/mp3'; } }
                if (navigator.onLine) await addDoc(collection(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${chatId}`), msgData); 
                else { msgData.chatId = chatId; msgData.isPending = true; await localDB.outbox.add(msgData); const tempId = 'temp_' + Date.now(); msgData.id = tempId; document.getElementById('messages-box').appendChild(createMessageElement(tempId, msgData, "")); }
                msgInput.value = ''; cancelReply(); localStorage.setItem(`read_${activeContactMobile}`, Date.now());
            } catch (error) {} finally { sendBtn.innerHTML = '<i class="fa-solid fa-paper-plane text-[22px] ml-1"></i>'; sendBtn.disabled = false; }
        };

        function createMessageElement(docId, data, contactName) {
            const chatId = generateChatId(myMobile, activeContactMobile);
            let originalText = data.text ? decryptText(data.text, chatId) : '';
            let replyText = data.replyToText ? decryptText(data.replyToText, chatId) : null;

            const msgDiv = document.createElement('div'); msgDiv.id = `msg-${docId}`;
            if(data.isCallLog) { msgDiv.className = `pvt-msg flex justify-center w-full my-2 relative z-10`; msgDiv.innerHTML = `<div class="bg-[#182229] border border-[#222d34] text-[#e9edef] px-4 py-1.5 rounded-xl text-[14px] flex items-center gap-2 shadow-sm font-medium"><i class="fa-solid fa-phone text-[#8696a0]"></i> Call</div>`; return msgDiv; }
            
            const isMe = data.senderMobile === myMobile; const bubbleClasses = isMe ? 'bg-[#005c4b] self-end rounded-tr-none' : 'bg-[#202c33] self-start rounded-tl-none'; 
            msgDiv.className = `pvt-msg flex flex-col max-w-[85%] md:max-w-[65%] ${bubbleClasses} px-2 pt-1.5 pb-1 rounded-xl mb-1.5 relative cursor-pointer select-none transition-colors z-10`; 
            
            msgDiv.addEventListener('mousedown', () => { pressTimer = setTimeout(() => toggleSelect(docId), 500); });
            msgDiv.addEventListener('mouseup', () => clearTimeout(pressTimer));
            msgDiv.addEventListener('touchstart', () => { pressTimer = setTimeout(() => toggleSelect(docId), 500); });
            msgDiv.addEventListener('touchend', () => clearTimeout(pressTimer));
            msgDiv.onclick = (e) => { if(selectedMsgs.size > 0) { e.stopPropagation(); toggleSelect(docId); } else { toggleReactionMenu(docId, e); } };

            let content = '';
            if (data.fileUrl) {
                if (data.fileType && data.fileType.startsWith('image/')) content = `<img src="${data.fileUrl}" class="rounded-lg mb-1 mt-1 max-h-72 w-full object-cover cursor-pointer" onclick="openLightbox('${data.fileUrl}', event)">`;
                else content = `<a href="${data.fileUrl}" target="_blank" class="bg-black/20 p-3 rounded-lg flex items-center gap-2 text-sm mt-1 text-white border border-transparent"><i class="fa-solid fa-file"></i> Attachment</a>`;
            }

            let replyHtml = replyText ? `<div class="bg-black/20 p-2 rounded mb-1 text-sm border-l-4 border-[#00a884] opacity-80 truncate"><span class="text-[#00a884] font-bold text-xs">Replied</span><br>${escapeHTML(replyText)}</div>` : '';
            let finalHtmlText = originalText ? `<p class="text-[16px] text-white whitespace-pre-wrap leading-snug px-1 mt-1">${escapeHTML(originalText)}</p>` : '';
            
            let popupMenu = `<div id="react-menu-${docId}" class="reaction-menu-popup hidden absolute ${isMe ? 'right-0' : 'left-0'} -top-14 bg-[#233138] border border-[#222d34] rounded-full flex items-center gap-2 px-3 py-1.5 shadow-xl z-[60] min-w-max"><button onclick="initiateReply('${originalText ? escapeHTML(originalText).replace(/'/g, "\\'") : 'Attachment'}', event)" class="hover:scale-125 transition-all text-[#00a884] text-xl"><i class="fa-solid fa-reply"></i></button>${isMe ? `<div class="w-[1px] h-6 bg-[#374045] mx-1"></div><button onclick="deleteMsg('${docId}', event)" class="hover:scale-125 transition-all text-[#f15c6d] text-xl"><i class="fa-solid fa-trash"></i></button>` : ''}</div>`;
            
            let tickColor = data.read ? "text-[#53bdeb]" : "text-[#8696a0]"; let ticksHtml = isMe ? `<i class="fa-solid fa-check-double text-[12px] ${tickColor} ml-1"></i>` : '';
            msgDiv.innerHTML = `${popupMenu}${replyHtml}${content}<div class="relative"><span style="display:inline-block; max-width: calc(100% - 65px); vertical-align:top;">${finalHtmlText}</span><div class="inline-flex items-center justify-end absolute bottom-0 right-0 px-1"><span class="text-[11px] text-[#8696a0]">${data.timeString}</span>${ticksHtml}</div></div>`; return msgDiv;
        }

        // Add essential missing global functions simply
        window.closeChatMobile = () => { document.getElementById('chat-area').classList.add('hidden'); document.getElementById('sidebar').classList.remove('hidden'); activeContactMobile=null; renderContacts(); }
        window.closeAllMenus = () => document.querySelectorAll('.dropdown-menu').forEach(e => e.classList.remove('show'));
        window.toggleReactionMenu = (id,e) => { e.stopPropagation(); closeAllMenus(); document.getElementById(`react-menu-${id}`).classList.remove('hidden'); }
        window.initiateReply = (text, e) => { e.stopPropagation(); currentReplyContext = text; document.getElementById('reply-preview-text').innerText = text; document.getElementById('reply-preview-container').classList.remove('hidden'); document.getElementById('msg-input').focus(); closeAllMenus(); }
        window.cancelReply = () => { currentReplyContext = null; document.getElementById('reply-preview-container').classList.add('hidden'); }
        window.deleteMsg = (id, e) => { e.stopPropagation(); deleteDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${generateChatId(myMobile, activeContactMobile)}`, id)); closeAllMenus(); }
        function toggleSelect(id) { const el=document.getElementById(`msg-${id}`); if(selectedMsgs.has(id)){selectedMsgs.delete(id); el.classList.remove('msg-selected');}else{selectedMsgs.add(id); el.classList.add('msg-selected');} document.getElementById('selection-header').classList.toggle('hidden', selectedMsgs.size===0); document.getElementById('select-count').innerText=selectedMsgs.size; }
        window.clearSelection=()=>{ selectedMsgs.forEach(id=>document.getElementById(`msg-${id}`)?.classList.remove('msg-selected')); selectedMsgs.clear(); document.getElementById('selection-header').classList.add('hidden'); }
        window.deleteSelectedMsgs=()=>{ selectedMsgs.forEach(id=>deleteDoc(doc(db, 'artifacts', SYNC_APP_ID, 'public', 'data', `pvt_msg_${generateChatId(myMobile, activeContactMobile)}`, id))); clearSelection(); }
        window.openSettings=()=>document.getElementById('settings-modal').classList.remove('hidden'); window.closeSettings=()=>document.getElementById('settings-modal').classList.add('hidden');
        window.logoutPvtChat=()=>{ localStorage.clear(); location.reload(); }
        function uploadFileWithProgress(file) { return new Promise((resolve) => { const formData=new FormData(); formData.append('file',file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET); fetch(CLOUDINARY_URL,{method:'POST',body:formData}).then(r=>r.json()).then(resolve); }); }

    </script>
</body>
</html>
