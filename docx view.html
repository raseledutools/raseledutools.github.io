<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RasBook - Real Experience</title>
    <style>
        /* --- CSS: Ultra Professional Facebook UI --- */
        :root { --fb-blue: #1877F2; --bg-gray: #c9ccd1; --card-bg: #ffffff; --text-main: #050505; --text-muted: #65676B; --border-color: #ced0d4; --hover-bg: #f2f2f2; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg-gray); display: flex; justify-content: center; }
        .app-container { width: 100%; max-width: 500px; min-height: 100vh; background-color: var(--bg-gray); position: relative; }
        
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 12px 24px; border-radius: 8px; font-size: 14px; opacity: 0; transition: 0.3s; z-index: 2000; pointer-events: none; max-width: 90%; text-align: center; }
        .toast.show { opacity: 1; }

        /* Login Screen */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: var(--card-bg); padding: 20px; text-align: center; }
        .logo-text-login { font-size: 55px; font-weight: bold; margin-bottom: 5px; color: var(--fb-blue); }
        .tagline { color: var(--text-main); font-size: 18px; margin-bottom: 30px; }
        .input-field { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; background: #f5f6f7; outline: none; margin-bottom: 12px; }
        .btn-primary { width: 100%; padding: 14px; background: var(--fb-blue); color: white; border: none; border-radius: 6px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .divider { width: 100%; height: 1px; background: var(--border-color); margin: 20px 0; }
        
        /* App Header */
        #main-app { display: none; flex-direction: column; padding-top: 105px; }
        .top-bar { position: fixed; top: 0; width: 100%; max-width: 500px; background: var(--fb-blue); z-index: 100; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; }
        .header h1 { font-size: 28px; font-weight: 800; letter-spacing: -1px; }
        .logo-ras { color: #ffffff; }
        .logo-book { color: #42b72a; }
        .header-icons { display: flex; gap: 10px; }
        .icon-btn { background: rgba(255,255,255,0.2); color: white; border: none; width: 38px; height: 38px; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; text-decoration: none; }
        
        .nav-tabs { display: flex; justify-content: space-between; background: #fff; padding: 5px 15px; }
        .tab { flex: 1; text-align: center; padding: 10px 0; font-size: 22px; color: var(--text-muted); cursor: pointer; border-bottom: 3px solid transparent; }
        .tab.active { color: var(--fb-blue); border-bottom: 3px solid var(--fb-blue); }

        /* Profile Settings Modal */
        #profile-settings-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .settings-card { background: #fff; width: 90%; max-width: 400px; padding: 20px; border-radius: 12px; text-align: center; }
        .settings-card h2 { margin-bottom: 15px; color: var(--text-main); }
        .settings-avatar-preview { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; border: 2px solid var(--fb-blue); }
        .save-profile-btn { background: var(--fb-blue); color: #fff; padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 15px; width: 100%; }
        .close-settings-btn { background: #ddd; color: #333; padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; width: 100%; }

        /* Create Post */
        .create-post { background: var(--card-bg); padding: 12px 15px; margin-bottom: 8px; }
        .post-input-area { display: flex; align-items: center; gap: 10px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; cursor: pointer; }
        .post-input { flex: 1; border: none; outline: none; font-size: 16px; padding: 10px 15px; background: #f0f2f5; border-radius: 20px; }
        .preview-container { position: relative; margin-top: 15px; display: none; }
        #preview-media { width: 100%; max-height: 300px; object-fit: cover; border-radius: 8px; }
        .remove-img-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; }
        .post-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        .file-upload { color: #45bd62; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .post-btn { background: var(--fb-blue); color: white; border: none; padding: 8px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; }

        /* Stories Section */
        .stories { display: flex; gap: 10px; padding: 15px; background: var(--card-bg); margin-bottom: 8px; overflow-x: auto; scrollbar-width: none; }
        .stories::-webkit-scrollbar { display: none; }
        .story-card { min-width: 100px; height: 170px; border-radius: 12px; background: #ddd; position: relative; overflow: hidden; background-size: cover; background-position: center; border: 1px solid #eee; flex-shrink: 0; cursor: pointer; }
        .story-avatar { position: absolute; top: 10px; left: 10px; width: 35px; height: 35px; border-radius: 50%; border: 3px solid var(--fb-blue); z-index: 2; object-fit: cover; }
        .story-name { position: absolute; bottom: 10px; left: 10px; color: white; font-weight: bold; font-size: 12px; text-shadow: 1px 1px 3px rgba(0,0,0,0.8); z-index: 2; }
        .story-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.6)); }

        /* News Feed & Post Card */
        .feed { display: flex; flex-direction: column; gap: 8px; padding-bottom: 20px; }
        .post-card { background: var(--card-bg); }
        .post-header { display: flex; align-items: center; gap: 10px; padding: 12px 15px; position: relative; }
        .author-info { flex: 1; }
        .post-author { font-weight: bold; font-size: 15px; color: var(--text-main); }
        .post-time { font-size: 13px; color: var(--text-muted); }
        
        .more-options { position: relative; }
        .more-btn { background: none; border: none; font-size: 20px; color: var(--text-muted); cursor: pointer; padding: 5px; }
        .dropdown-menu { display: none; position: absolute; right: 0; top: 30px; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; z-index: 10; width: 150px; }
        .dropdown-menu.show { display: block; }
        .delete-btn { width: 100%; padding: 12px; text-align: left; background: none; border: none; color: #dc3545; font-weight: bold; cursor: pointer; font-size: 15px; display: flex; align-items: center; gap: 8px; }

        .post-text { padding: 0 15px 10px; font-size: 15px; line-height: 1.5; color: var(--text-main); word-wrap: break-word; }
        .post-media { width: 100%; max-height: 500px; object-fit: cover; display: block; background: #000; }
        .post-stats { padding: 10px 15px; color: var(--text-muted); font-size: 14px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .post-footer { display: flex; justify-content: space-between; padding: 4px 15px; }
        .action-btn { flex: 1; background: none; border: none; color: var(--text-muted); font-weight: 600; font-size: 14px; padding: 8px 0; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; transition: 0.2s; }
        .action-btn.liked { color: var(--fb-blue); }

        /* Comments Section */
        .comments-section { display: none; padding: 10px 15px; border-top: 1px solid #eee; background: #fff; }
        .comments-section.show { display: block; }
        .comment-item { display: flex; gap: 8px; margin-bottom: 12px; }
        .comment-bubble { background: #f0f2f5; padding: 8px 12px; border-radius: 18px; max-width: 85%; }
        .comment-author { font-weight: bold; font-size: 13px; color: var(--text-main); margin-bottom: 2px; }
        .comment-text { font-size: 14px; color: var(--text-main); word-wrap: break-word; }
        .add-comment-box { display: flex; gap: 8px; align-items: center; margin-top: 10px; }
        .comment-input { flex: 1; background: #f0f2f5; border: none; border-radius: 20px; padding: 10px 15px; outline: none; font-size: 14px; }
        .send-comment-btn { background: none; border: none; color: var(--fb-blue); font-weight: bold; cursor: pointer; font-size: 20px; padding: 5px; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="toast" class="toast"></div>

    <div id="login-screen">
        <div class="logo-text-login"><span style="color:#1877F2">Ras</span><span style="color:#42b72a">Book</span></div>
        <p class="tagline">Connect with friends and the world around you.</p>
        <input type="email" id="email" class="input-field" placeholder="Mobile number or email">
        <input type="password" id="password" class="input-field" placeholder="Password">
        <button id="login-btn" class="btn-primary">Log In</button>
        <div class="divider"></div>
        <button id="register-btn" class="btn-primary" style="background: #42b72a; width: 80%;">Create New Account</button>
    </div>

    <div id="main-app">
        <div class="top-bar">
            <div class="header">
                <h1><span class="logo-ras">Ras</span><span class="logo-book">Book</span></h1>
                <div class="header-icons">
                    <button class="icon-btn">üîç</button>
                    <a href="chat_indivisual.html" class="icon-btn">üí¨</a>
                </div>
            </div>
            <div class="nav-tabs">
                <span class="tab active">üè†</span>
                <span class="tab">üì∫</span>
                <span class="tab">üè™</span>
                <span class="tab">üîî</span>
                <span class="tab" id="menu-tab">‚ò∞</span>
            </div>
        </div>

        <div id="profile-settings-modal">
            <div class="settings-card">
                <h2>Edit Profile</h2>
                <img src="https://via.placeholder.com/80" id="settings-avatar-preview" class="settings-avatar-preview">
                <input type="file" id="settings-avatar-upload" accept="image/*" style="display: none;">
                <br>
                <label for="settings-avatar-upload" style="color: var(--fb-blue); font-weight: bold; cursor: pointer;">Change Photo</label>
                <br><br>
                <input type="text" id="settings-name-input" class="input-field" placeholder="Your Display Name">
                <button id="save-profile-btn" class="save-profile-btn">Save Changes</button>
                <button id="close-settings-btn" class="close-settings-btn">Cancel</button>
                <button id="logout-btn" class="close-settings-btn" style="background: #dc3545; color: white; margin-top: 20px;">Logout</button>
            </div>
        </div>

        <div class="stories" id="stories-container">
            <div class="story-card" id="add-story-btn">
                <img src="" id="my-story-avatar" class="story-avatar">
                <div class="story-overlay"></div>
                <div class="story-name">Create Story</div>
            </div>
            <div class="story-card" style="background-image: url('https://images.unsplash.com/photo-1472214103451-9374bd1c798e?w=200');">
                <img src="https://ui-avatars.com/api/?name=Arif&background=random" class="story-avatar">
                <div class="story-overlay"></div>
                <div class="story-name">Arif Ahmed</div>
            </div>
            <div class="story-card" style="background-image: url('https://images.unsplash.com/photo-1506748686214-e9df14d4d9d0?w=200');">
                <img src="https://ui-avatars.com/api/?name=Sakib&background=random" class="story-avatar">
                <div class="story-overlay"></div>
                <div class="story-name">Sakib Hasan</div>
            </div>
        </div>

        <div class="create-post">
            <div class="post-input-area">
                <img src="" class="avatar" id="current-user-avatar" title="Click to Edit Profile">
                <input type="text" id="post-text" class="post-input" placeholder="What's on your mind?">
            </div>
            <div class="preview-container" id="preview-container">
                <button class="remove-img-btn" id="remove-img-btn">‚úï</button>
                <img id="preview-media" src="" style="display:none;">
                <video id="preview-video" class="post-media" controls style="display:none;"></video>
            </div>
            <div class="post-actions">
                <label class="file-upload">üì∏ <span>Photo/Video</span><input type="file" id="post-image" accept="image/*,video/*" style="display: none;"></label>
                <button id="submit-post-btn" class="post-btn">Post</button>
            </div>
        </div>

        <div class="feed" id="feed-container"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, deleteDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDvQjNIgVvKk0qa0WZX25etZH73UmHqtIg",
      authDomain: "rasbook-5159d.firebaseapp.com",
      databaseURL: "https://rasbook-5159d-default-rtdb.firebaseio.com",
      projectId: "rasbook-5159d",
      storageBucket: "rasbook-5159d.firebasestorage.app",
      messagingSenderId: "983241676717",
      appId: "1:983241676717:web:bb35a559bd9935c8517324",
      measurementId: "G-0GZLGZBGDX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let selectedFile = null;
    let fileType = null; // 'image' or 'video'
    let toastTimeout;
    
    // UI Helpers
    const showToast = (msg, duration = 4000) => {
        const t = document.getElementById('toast');
        clearTimeout(toastTimeout);
        t.innerText = msg; t.classList.add('show');
        toastTimeout = setTimeout(() => t.classList.remove('show'), duration);
    };

    const timeAgo = (date) => {
        if (!date) return "Just now";
        const seconds = Math.floor((new Date() - date.toDate()) / 1000);
        let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + "y";
        interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + "d";
        interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + "h";
        interval = seconds / 60; if (interval > 1) return Math.floor(interval) + "m";
        return "Just now";
    };

    const getAvatar = (user) => {
        return user.photoURL ? user.photoURL : `https://ui-avatars.com/api/?name=${user.displayName || user.email}&background=1877F2&color=fff`;
    };

    const getDisplayName = (user) => {
        return user.displayName ? user.displayName : user.email.split('@')[0];
    };

    // --- Authentication & Profile Setup ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            updateGlobalUI();
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            loadPosts();
        } else {
            currentUser = null;
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
        }
    });

    const updateGlobalUI = () => {
        const avatarUrl = getAvatar(currentUser);
        document.getElementById('current-user-avatar').src = avatarUrl;
        document.getElementById('my-story-avatar').src = avatarUrl;
        document.getElementById('settings-avatar-preview').src = avatarUrl;
        document.getElementById('settings-name-input').value = getDisplayName(currentUser);
    };

    document.getElementById('login-btn').addEventListener('click', async () => {
        try { 
            await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); 
        } catch (e) { showToast("Login Error!"); }
    });

    document.getElementById('register-btn').addEventListener('click', async () => {
        try { 
            await createUserWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value); 
            showToast("Account created!"); 
        } catch (e) { showToast("Register Error!"); }
    });

    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

    // --- Profile Settings System ---
    const settingsModal = document.getElementById('profile-settings-modal');
    
    // Open settings by clicking on Avatar or Menu (‚ò∞)
    document.getElementById('current-user-avatar').addEventListener('click', () => settingsModal.style.display = 'flex');
    document.getElementById('menu-tab').addEventListener('click', () => settingsModal.style.display = 'flex');
    document.getElementById('close-settings-btn').addEventListener('click', () => settingsModal.style.display = 'none');

    let settingsNewAvatarFile = null;
    document.getElementById('settings-avatar-upload').addEventListener('change', (e) => {
        settingsNewAvatarFile = e.target.files[0];
        if (settingsNewAvatarFile) {
            document.getElementById('settings-avatar-preview').src = URL.createObjectURL(settingsNewAvatarFile);
        }
    });

    document.getElementById('save-profile-btn').addEventListener('click', async (e) => {
        const newName = document.getElementById('settings-name-input').value.trim();
        e.target.innerText = "Saving...";
        e.target.disabled = true;

        try {
            let newPhotoUrl = currentUser.photoURL;
            if (settingsNewAvatarFile) {
                newPhotoUrl = await uploadToCloudinary(settingsNewAvatarFile);
            }
            await updateProfile(currentUser, { displayName: newName, photoURL: newPhotoUrl });
            updateGlobalUI();
            showToast("Profile Updated!");
            settingsModal.style.display = 'none';
        } catch (err) {
            showToast("Failed to update profile.");
        }
        e.target.innerText = "Save Changes";
        e.target.disabled = false;
    });

    // --- Media Upload (Cloudinary Auto Handles Photo & Video) ---
    document.getElementById('post-image').addEventListener('change', (e) => {
        selectedFile = e.target.files[0];
        if (selectedFile) {
            fileType = selectedFile.type.startsWith('video') ? 'video' : 'image';
            document.getElementById('preview-container').style.display = 'block';
            
            if (fileType === 'video') {
                document.getElementById('preview-media').style.display = 'none';
                document.getElementById('preview-video').style.display = 'block';
                document.getElementById('preview-video').src = URL.createObjectURL(selectedFile);
            } else {
                document.getElementById('preview-video').style.display = 'none';
                document.getElementById('preview-media').style.display = 'block';
                document.getElementById('preview-media').src = URL.createObjectURL(selectedFile);
            }
        }
    });
    
    document.getElementById('remove-img-btn').addEventListener('click', () => {
        selectedFile = null; fileType = null;
        document.getElementById('post-image').value = '';
        document.getElementById('preview-container').style.display = 'none';
        document.getElementById('preview-media').src = '';
        document.getElementById('preview-video').src = '';
    });

    const uploadToCloudinary = async (file) => {
        const fd = new FormData(); 
        fd.append('file', file); 
        fd.append('upload_preset', 'ml_default'); 
        fd.append('cloud_name', 'de2w78yxh');
        
        const res = await fetch("https://api.cloudinary.com/v1_1/de2w78yxh/auto/upload", { method: "POST", body: fd });
        const data = await res.json();
        return data.secure_url;
    };

    // --- Create Post (Photo/Video/Text) ---
    document.getElementById('submit-post-btn').addEventListener('click', async (e) => {
        const text = document.getElementById('post-text').value.trim();
        if (!text && !selectedFile) return showToast("Post cannot be empty!");
        
        const btn = e.target;
        btn.disabled = true; btn.innerText = "Posting...";
        
        try {
            let mediaUrl = null; 
            if (selectedFile) mediaUrl = await uploadToCloudinary(selectedFile);

            await addDoc(collection(db, "posts"), {
                userId: currentUser.uid, 
                userName: getDisplayName(currentUser),
                userAvatar: getAvatar(currentUser),
                text: text, 
                mediaUrl: mediaUrl, 
                mediaType: fileType, // 'image' or 'video'
                likes: [], comments: [], 
                createdAt: serverTimestamp()
            });
            
            document.getElementById('post-text').value = ''; 
            document.getElementById('remove-img-btn').click();
            showToast("Published!");
        } catch (err) { showToast("Error posting"); } 
        finally { btn.disabled = false; btn.innerText = "Post"; }
    });

    // --- Render Feed ---
    const loadPosts = () => {
        const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
        onSnapshot(q, (snapshot) => {
            const feedContainer = document.getElementById('feed-container');
            feedContainer.innerHTML = ''; 
            
            snapshot.forEach((docSnap) => {
                const post = docSnap.data();
                const postId = docSnap.id;
                const postLikes = post.likes || [];
                const postComments = post.comments || [];
                const isLiked = postLikes.includes(currentUser.uid);
                
                // Comments Rendering
                let commentsHtml = '';
                postComments.forEach(c => {
                    commentsHtml += `
                        <div class="comment-item">
                            <img src="${c.userAvatar}" class="avatar" style="width:30px; height:30px;">
                            <div class="comment-bubble">
                                <div class="comment-author">${c.userName}</div>
                                <div class="comment-text">${c.text}</div>
                            </div>
                        </div>
                    `;
                });

                // Media Rendering (Image or Video)
                let mediaHtml = '';
                if (post.mediaUrl) {
                    if (post.mediaType === 'video') {
                        mediaHtml = `<video src="${post.mediaUrl}" class="post-media" controls preload="metadata"></video>`;
                    } else {
                        mediaHtml = `<img src="${post.mediaUrl}" class="post-media">`;
                    }
                }

                const postEl = document.createElement('div');
                postEl.className = 'post-card';
                postEl.dataset.id = postId;
                
                const menuHtml = post.userId === currentUser.uid ? `
                    <div class="more-options">
                        <button class="more-btn">‚Ä¢‚Ä¢‚Ä¢</button>
                        <div class="dropdown-menu"><button class="delete-btn">üóëÔ∏è Delete</button></div>
                    </div>
                ` : '';

                postEl.innerHTML = `
                    <div class="post-header">
                        <img src="${post.userAvatar || getAvatar({displayName: post.userName})}" class="avatar">
                        <div class="author-info">
                            <div class="post-author">${post.userName}</div>
                            <div class="post-time">${timeAgo(post.createdAt)} ‚Ä¢ üåé</div>
                        </div>
                        ${menuHtml}
                    </div>
                    ${post.text ? `<div class="post-text">${post.text}</div>` : ''}
                    ${mediaHtml}
                    <div class="post-stats">
                        <span>üëç ${postLikes.length > 0 ? postLikes.length : ''} </span>
                        <span>${postComments.length} Comments</span>
                    </div>
                    <div class="post-footer">
                        <button class="action-btn like-btn ${isLiked ? 'liked' : ''}">${isLiked ? 'üëç Liked' : 'üëç Like'}</button>
                        <button class="action-btn comment-btn">üí¨ Comment</button>
                        <button class="action-btn share-btn">üîÑ Share</button>
                    </div>
                    
                    <div class="comments-section">
                        <div class="comments-list">${commentsHtml}</div>
                        <div class="add-comment-box">
                            <img src="${getAvatar(currentUser)}" class="avatar" style="width:32px; height:32px;">
                            <input type="text" class="comment-input" placeholder="Write a comment...">
                            <button class="send-comment-btn">‚û§</button>
                        </div>
                    </div>
                `;
                feedContainer.appendChild(postEl);
            });
        });
    };

    // --- Interactions System ---
    document.addEventListener('click', async (e) => {
        const target = e.target;
        const postCard = target.closest('.post-card');
        
        if (!target.classList.contains('more-btn')) {
            document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
        }

        if (!postCard) return;
        const postId = postCard.dataset.id;
        const postRef = doc(db, "posts", postId);

        // Delete Menu
        if (target.classList.contains('more-btn')) {
            postCard.querySelector('.dropdown-menu').classList.toggle('show');
        }
        if (target.classList.contains('delete-btn')) {
            if (confirm("Delete this post?")) await deleteDoc(postRef);
        }

        // Like Post
        if (target.classList.contains('like-btn') || target.closest('.like-btn')) {
            const btn = target.closest('.like-btn') || target;
            if (btn.classList.contains('liked')) {
                await updateDoc(postRef, { likes: arrayRemove(currentUser.uid) });
            } else {
                await updateDoc(postRef, { likes: arrayUnion(currentUser.uid) });
            }
        }

        // Share System (Native Web Share API)
        if (target.classList.contains('share-btn') || target.closest('.share-btn')) {
            if (navigator.share) {
                navigator.share({
                    title: 'RasBook Post',
                    text: 'Check out this post on RasBook!',
                    url: window.location.href
                }).catch(err => console.log("Share cancelled"));
            } else {
                showToast("Link copied to clipboard!");
            }
        }

        // Comments System
        if (target.classList.contains('comment-btn') || target.closest('.comment-btn')) {
            const sec = postCard.querySelector('.comments-section');
            sec.classList.toggle('show');
            if(sec.classList.contains('show')) postCard.querySelector('.comment-input').focus();
        }

        if (target.classList.contains('send-comment-btn')) {
            const inputField = postCard.querySelector('.comment-input');
            const commentText = inputField.value.trim();
            if (!commentText) return;
            
            await updateDoc(postRef, { 
                comments: arrayUnion({
                    userId: currentUser.uid,
                    userName: getDisplayName(currentUser),
                    userAvatar: getAvatar(currentUser),
                    text: commentText,
                    timestamp: new Date().toISOString()
                }) 
            });
            inputField.value = '';
        }
    });

</script>

</body>
</html>
