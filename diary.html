<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Diary</title>
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Using unpkg for pdf-lib to ensure correct version -->
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,700;1,400&family=Open+Sans:wght@400;600;700&family=Dancing+Script:wght@700&family=Patrick+Hand&family=Montserrat:wght@400;600;800&family=Hind+Siliguri:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --header-red: #d32f2f;
            --sidebar-bg: #2d323e;
            --sidebar-hover: #3a4150;
            --sidebar-active: #2389d7;
            --paper-shadow: 0 4px 15px rgba(0,0,0,0.15);
            --bg-color: #e6cfa3;
            --bg-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            --text-color: #1a237e;
            --paper-bg: #ffffff;
            --meta-color: #666;
            --border-color: #eee;
            --toast-bg: #333;
            --toast-color: #fff;
        }

        /* --- THEMES --- */
        body.dark-theme {
            --header-red: #1a1a1a; --sidebar-bg: #000000; --sidebar-hover: #333;
            --bg-color: #121212; --bg-image: none; --text-color: #aeb9e6;
            --paper-bg: #1e1e1e; --paper-shadow: 0 4px 15px rgba(0,0,0,0.5);
            --meta-color: #aaa; --border-color: #444;
            --toast-bg: #fff; --toast-color: #000;
        }
        
        body.notebook-theme .paper {
            background-color: #fdfdfd;
            background-image: linear-gradient(90deg, transparent 79px, #ff9999 79px, #ff9999 81px, transparent 81px), repeating-linear-gradient(transparent 0px, transparent 29px, #9ec2e6 29px, #9ec2e6 30px);
            background-size: 100% 100%, 100% 30px; padding-left: 90px; padding-right: 40px; line-height: 30px; 
        }
        body.notebook-theme .entry-body { font-family: 'Patrick Hand', cursive !important; line-height: 30px !important; font-size: 20px; }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Open Sans', sans-serif;
            height: 100vh; display: flex; overflow: hidden;
            background-color: var(--bg-color); background-image: var(--bg-image);
            color: var(--text-color); transition: background 0.3s, color 0.3s;
        }

        /* --- AUTH SCREEN (LOGIN SYSTEM) --- */
        #authScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50;
            background-image: url('https://www.transparenttextures.com/patterns/wood-pattern.png');
            z-index: 9999; display: flex; justify-content: center; align-items: center;
            flex-direction: column; color: white;
        }
        
        .auth-card {
            background: white; padding: 40px; border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center;
            width: 350px; color: #333;
        }
        .auth-card h2 { margin-bottom: 20px; font-family: 'Lora', serif; color: #d32f2f; }
        .auth-card p { margin-bottom: 20px; color: #666; font-size: 14px; }
        .auth-input {
            width: 100%; padding: 12px; margin-bottom: 15px;
            border: 1px solid #ddd; border-radius: 4px; font-size: 16px;
        }
        .auth-btn {
            width: 100%; padding: 12px; background: #2389d7; color: white;
            border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer;
            transition: background 0.2s;
        }
        .auth-btn:hover { background: #1b74b8; }
        .auth-error { color: #e74c3c; font-size: 13px; margin-top: 10px; min-height: 20px; }

        /* --- MAIN APP (Hidden by default) --- */
        #appInterface { display: none; width: 100%; height: 100%; display: flex; }

        /* --- SIDEBAR --- */
        .sidebar {
            width: 250px; background-color: var(--sidebar-bg); color: #b0b3b8;
            display: flex; flex-direction: column; border-right: 1px solid #1a1d24;
            z-index: 100; transition: width 0.3s ease; overflow: hidden; white-space: nowrap;
        }
        body.hide-sidebar .sidebar { width: 0; border-right: none; }

        .journal-header {
            padding: 15px; color: white; font-weight: 700; border-bottom: 1px solid #3a4150;
            display: flex; justify-content: space-between; align-items: center; font-size: 14px; letter-spacing: 1px;
        }
        .streak-box {
            background: rgba(255,87,34,0.1); color: #ff5722; padding: 12px;
            text-align: center; font-weight: bold; font-size: 12px;
            border-bottom: 1px solid #3a4150;
        }
        .search-box { padding: 12px; border-bottom: 1px solid #3a4150; }
        .search-input { width: 100%; background: rgba(255,255,255,0.1); border: none; border-radius: 4px; padding: 8px 12px; color: white; outline: none; }
        .new-entry-btn { background-color: var(--sidebar-active); color: white; padding: 12px 15px; margin: 0; cursor: pointer; display: flex; align-items: center; font-weight: 600; font-size: 13px; transition: background 0.2s; }
        .new-entry-btn:hover { background-color: #1b74b8; }
        
        .sidebar-menu { border-bottom: 1px solid #3a4150; overflow-y: auto; flex: 1; }
        .menu-item { padding: 12px 15px; color: #d1d2d4; font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: space-between; transition: background 0.2s; }
        .menu-item:hover { background-color: var(--sidebar-hover); }
        .menu-item.active { background-color: #3a4150; color: white; border-left: 4px solid var(--sidebar-active); }
        .menu-item i { width: 22px; margin-right: 10px; }
        .menu-label { display: flex; align-items: center; }
        .badge { background: rgba(255,255,255,0.15); padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: bold; transition: all 0.3s; }
        .menu-item.active .badge { background: white; color: var(--sidebar-bg); }
        .logout-btn { color: #e74c3c; margin-top: 5px; border-top: 1px solid #3a4150; padding: 15px; }
        .logout-btn:hover { background: rgba(231, 76, 60, 0.1); }

        .entry-list { flex: 1; overflow-y: auto; background: rgba(0,0,0,0.2); }
        .saved-entry { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; position: relative; transition: background 0.2s; }
        .saved-entry:hover { background-color: var(--sidebar-hover); }
        .saved-entry.active { background-color: rgba(35, 137, 215, 0.15); border-left: 3px solid #2389d7; }
        .saved-entry h4 { color: white; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-bottom: 4px; padding-right: 20px; }
        .saved-entry p { font-size: 11px; color: #888; }
        .saved-entry .delete-entry-icon {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            color: #888; font-size: 14px; display: none; padding: 8px;
            cursor: pointer; z-index: 10;
        }
        .saved-entry:hover .delete-entry-icon { display: block; }
        .saved-entry .delete-entry-icon:hover { color: #e74c3c; transform: translateY(-50%) scale(1.1); }

        .empty-state { padding: 40px 20px; text-align: center; color: #777; font-style: italic; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .empty-state i { font-size: 24px; opacity: 0.5; }
        
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; overflow: hidden; }
        .header { height: 55px; background-color: var(--header-red); display: flex; align-items: center; justify-content: space-between; padding: 0 20px; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
        .header .fa-bars { cursor: pointer; padding: 10px; font-size: 18px; }
        .logo { font-family: 'Brush Script MT', cursive; font-size: 28px; }

        .paper-area { flex: 1; display: flex; justify-content: center; overflow-y: auto; padding: 30px 20px; }
        .paper { width: 100%; max-width: 900px; min-height: 900px; background: var(--paper-bg); box-shadow: var(--paper-shadow); padding: 50px 60px; border-radius: 4px; display: flex; flex-direction: column; position: relative; }

        .save-bar { position: absolute; top: 15px; right: 20px; font-size: 12px; color: var(--meta-color); display: flex; gap: 15px; align-items: center; }
        .action-link { cursor: pointer; display: flex; align-items: center; gap: 5px; opacity: 0.7; transition: opacity 0.2s; }
        .action-link:hover { opacity: 1; color: var(--sidebar-active); }

        .date-banner { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 25px; border-radius: 8px; margin-bottom: 25px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #datePicker { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .date-left { display: flex; flex-direction: column; }
        .date-day { font-size: 12px; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
        .date-full { font-size: 20px; font-weight: bold; }

        .editor-container { display: flex; flex: 1; gap: 25px; }
        .text-area-wrapper { flex: 1; display: flex; flex-direction: column; }
        
        /* Media Sidebar Styling */
        .image-sidebar-wrapper { width: 160px; border-left: 1px solid var(--border-color); padding-left: 20px; display: flex; flex-direction: column; }
        .image-sidebar-title { font-weight: 600; margin-bottom: 15px; color: var(--text-color); font-size: 13px; display: flex; align-items: center; gap: 5px; }
        #imageGalleryBox { width: 100%; overflow-y: auto; flex: 1; padding-right: 5px; }
        
        .add-image-btn {
            width: 100%; padding: 10px; margin-bottom: 15px;
            background: rgba(35, 137, 215, 0.1); color: #2389d7;
            border: 1px dashed #2389d7; border-radius: 6px;
            text-align: center; cursor: pointer; font-size: 12px; font-weight: 600;
            transition: all 0.2s; display: flex; justify-content: center; align-items: center; gap: 5px;
        }
        .add-image-btn:hover { background: rgba(35, 137, 215, 0.2); }

        .entry-title { width: 100%; border: none; background: transparent; font-family: 'Lora', serif; font-size: 34px; color: var(--text-color); outline: none; margin: 10px 0 15px 0; font-weight: 700; }
        .entry-title::placeholder { color: #ccc; }
        
        .entry-body { width: 100%; flex: 1; border: none; outline: none; background: transparent; font-family: 'Lora', serif; font-size: 18px; line-height: 1.8; color: var(--text-color); min-height: 500px; white-space: pre-wrap; }
        .entry-body[placeholder]:empty:before { content: attr(placeholder); color: #ccc; cursor: text; }

        .meta-row { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .folder-select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; color: var(--text-color); background: transparent; outline: none; }
        .word-count { font-size: 12px; color: var(--meta-color); font-family: monospace; }

        .toolbar { display: flex; align-items: center; gap: 15px; color: var(--meta-color); font-size: 14px; }
        .toolbar i { cursor: pointer; transition: color 0.2s; position: relative; }
        .toolbar i:hover { color: var(--sidebar-active); }
        .img-preview-box { margin-bottom: 15px; position: relative; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; }
        .img-preview-box:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .img-preview-box img { width: 100%; display: block; }
        .img-delete { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; width: 20px; height: 20px; font-size: 12px; line-height: 20px; text-align: center; border-radius: 50%; cursor: pointer; z-index: 5; transition: background 0.2s; }
        .img-delete:hover { background: #e74c3c; }

        /* Popups & Modals */
        .popup-menu { position: absolute; top: 30px; left: 50%; transform: translateX(-50%); background: white; border: 1px solid #eee; padding: 8px; display: none; z-index: 50; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-radius: 4px; white-space: nowrap; }
        .toolbar i:hover .popup-menu { display: flex; gap: 8px; }
        .tool-btn { padding: 2px 6px; border-radius: 3px; cursor: pointer; }
        .tool-btn:hover { background: #f0f0f0; }
        
        /* New PDF Overlay Style */
        #pdf-export-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: auto;
        }
        
        #pdf-content-container {
            width: 794px; /* A4 width */
            background: white;
            padding: 0;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        
        .loading-text {
            color: white;
            font-size: 24px;
            margin-bottom: 20px;
            font-family: 'Open Sans', sans-serif;
            text-align: center;
        }
        
        /* Modal General */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px); animation: fadeIn 0.2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .modal-box { background: white; width: 500px; max-width: 90%; border-radius: 8px; box-shadow: 0 15px 30px rgba(0,0,0,0.2); transform: scale(0.95); animation: scaleIn 0.2s forwards; }
        @keyframes scaleIn { to { transform: scale(1); } }
        
        .modal-header { background: #3498db; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; border-radius: 8px 8px 0 0; }
        .modal-close { cursor: pointer; font-size: 24px; line-height: 1; opacity: 0.8; }
        .modal-close:hover { opacity: 1; }
        .modal-body { padding: 25px; }
        .modal-footer { padding: 15px 25px; background: #f9f9f9; text-align: right; border-radius: 0 0 8px 8px; border-top: 1px solid #eee; }
        
        .form-input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; outline: none; transition: border 0.2s; }
        .form-input:focus { border-color: #3498db; }
        .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; color: white; background: #3498db; transition: background 0.2s; }
        .btn:hover { background: #2980b9; }

        /* Toast Notification */
        #toastContainer { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: var(--toast-bg); color: var(--toast-color); padding: 12px 20px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 14px; display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s, fadeOut 0.3s 2.7s forwards; min-width: 250px; }
        .toast.success { border-left: 4px solid #2ecc71; }
        .toast.error { border-left: 4px solid #e74c3c; }
        .toast.info { border-left: 4px solid #3498db; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(10px); } }

        /* Image Preview Modal */
        #imagePreviewModal .modal-box { width: auto; max-width: 95%; max-height: 95vh; background: transparent; box-shadow: none; display: flex; justify-content: center; align-items: center; }
        #imagePreviewModal img { max-width: 100%; max-height: 90vh; border-radius: 4px; box-shadow: 0 5px 25px rgba(0,0,0,0.5); }
        #imagePreviewModal .modal-header { display: none; } 
        .close-preview-btn { position: absolute; top: 15px; right: 15px; color: white; font-size: 30px; cursor: pointer; background: rgba(0,0,0,0.5); width: 45px; height: 45px; border-radius: 50%; text-align: center; line-height: 45px; transition: background 0.2s; }
        .close-preview-btn:hover { background: rgba(0,0,0,0.8); }

        /* Schedule specific */
        .schedule-grid { display: flex; gap: 20px; }
        .sched-row { display: flex; margin-bottom: 8px; align-items: center; }
        .sched-time { font-size: 12px; width: 65px; color: #555; font-weight: 600; }
        .sched-input { flex: 1; border: 1px solid #ddd; background: #fff0f5; padding: 5px 8px; border-radius: 4px; font-size: 13px; }
        .sched-check { margin-right: 8px; }
        
        /* Ramadan Table specific */
        .ramadan-table { width: 100%; border-collapse: collapse; font-family: 'Hind Siliguri', 'Open Sans', sans-serif; min-width: 100%; font-size: 14px; }
        .ramadan-table th, .ramadan-table td { border: 1px solid #e0e0e0; text-align: center; padding: 8px; }
        .ramadan-table th { background-color: #f8f9fa; color: #2c3e50; font-weight: 700; }
        .ramadan-table td:first-child, .ramadan-table th:first-child { 
            position: sticky; left: 0; background-color: #f0f4f8; z-index: 10; text-align: left; padding-left: 15px; min-width: 220px; font-weight: 600; box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }
        .ramadan-header { background: #2c3e50; color: white; padding: 15px; text-align: center; font-family: 'Hind Siliguri', sans-serif; font-size: 26px; margin-bottom: 20px; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .ramadan-checkbox { width: 18px; height: 18px; cursor: pointer; accent-color: #27ae60; }
        .progress-cell { font-weight: bold; color: #2389d7; background-color: #eaf6ff; }
        .progress-row-header { background-color: #d1ecf1 !important; color: #0c5460; }

        /* Calendar Table Specific */
        .calendar-table { width: 100%; border-collapse: collapse; font-family: 'Hind Siliguri', sans-serif; }
        .calendar-table th, .calendar-table td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 14px; }
        .calendar-table th { background-color: #f8f9fa; font-weight: bold; color: #333; }
        .calendar-row-1 { background-color: #fff9c4; } /* Yellow */
        .calendar-row-10 { background-color: #c8e6c9; } /* Green */
        .calendar-row-20 { background-color: #bbdefb; } /* Blue */
        .calendar-row-30 { background-color: #ffccbc; } /* Red */
        
        /* Canvas */
        #drawingCanvas { border: 1px solid #ccc; background: white; cursor: crosshair; border-radius: 4px; box-shadow: inset 0 0 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

    <!-- AUTHENTICATION SCREEN -->
    <div id="authScreen">
        <!-- Signup Form -->
        <div id="signupForm" class="auth-card" style="display:none;">
            <i class="fas fa-book-journal-whills fa-3x" style="color: #d32f2f; margin-bottom: 15px;"></i>
            <h2>Create Your Diary</h2>
            <p>Set a password to secure your memories.</p>
            <input type="text" id="signupName" class="auth-input" placeholder="Your Name (e.g. Rasel)">
            <input type="password" id="signupPass" class="auth-input" placeholder="Create Password">
            <button class="auth-btn" onclick="performSignup()">Start Writing</button>
            <div class="auth-error" id="signupError"></div>
        </div>

        <!-- Login Form -->
        <div id="loginForm" class="auth-card" style="display:none;">
            <i class="fas fa-lock fa-3x" style="color: #2389d7; margin-bottom: 15px;"></i>
            <h2>Welcome Back!</h2>
            <p>Please enter your password to unlock.</p>
            <h3 id="welcomeName" style="margin-bottom:20px; color:#555; font-weight:600;"></h3>
            <input type="password" id="loginPass" class="auth-input" placeholder="Password">
            <button class="auth-btn" onclick="performLogin()">Unlock Diary</button>
            <div class="auth-error" id="loginError"></div>
        </div>
    </div>

    <!-- MAIN APP INTERFACE -->
    <div id="appInterface" style="display:none;">
        
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="journal-header">
                <span id="uiJournalName">MY JOURNAL</span>
                <i class="fas fa-cog settings-icon" onclick="openSettings()" title="Settings" style="cursor:pointer; opacity:0.8;"></i>
            </div>
            
            <div class="streak-box" title="Writing Streak">
                <i class="fas fa-fire streak-fire"></i> <span id="streakCount">0</span> Day Streak
            </div>

            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="Search entries..." oninput="filterEntries()">
            </div>

            <div class="new-entry-btn" onclick="createNewEntry()">
                <i class="fas fa-plus-circle" style="margin-right:8px;"></i> New Entry
            </div>

            <div class="sidebar-menu">
                <div class="menu-item active" id="menu-all" onclick="filterFolder('all')">
                    <span class="menu-label"><i class="fas fa-list"></i> All Entries</span>
                    <span class="badge" id="count-all">0</span>
                </div>
                <div class="menu-item" id="menu-work" onclick="filterFolder('Work')">
                    <span class="menu-label"><i class="fas fa-briefcase" style="color:#f39c12"></i> Work</span>
                    <span class="badge" id="count-work">0</span>
                </div>
                <div class="menu-item" id="menu-personal" onclick="filterFolder('Personal')">
                    <span class="menu-label"><i class="fas fa-user" style="color:#2ecc71"></i> Personal</span>
                    <span class="badge" id="count-personal">0</span>
                </div>
                <div class="menu-item" id="menu-secret" onclick="filterFolder('Secret')">
                    <span class="menu-label"><i class="fas fa-user-secret" style="color:#9b59b6"></i> Secret</span>
                    <span class="badge" id="count-secret">0</span>
                </div>
                
                <div class="menu-item schedule-btn" onclick="openSchedule()" style="color:#e67e22"><span class="menu-label"><i class="fas fa-calendar-check"></i> Schedule</span></div>
                <!-- RAMADAN CHECKLIST BUTTON -->
                <div class="menu-item" onclick="openRamadanChecklist()" style="color:#00a8ff"><span class="menu-label"><i class="fas fa-mosque"></i> Ramadan Plan</span></div>
                <!-- RAMADAN CALENDAR BUTTON -->
                <div class="menu-item" onclick="openRamadanCalendar()" style="color:#27ae60"><span class="menu-label"><i class="far fa-calendar-alt"></i> Ramadan Calendar</span></div>
                
                <div class="menu-item pdf-btn" onclick="exportPDF()"><span class="menu-label"><i class="fas fa-file-pdf"></i> PDF Export</span></div>
                <div class="menu-item restore-btn" onclick="document.getElementById('importFile').click()"><span class="menu-label"><i class="fas fa-upload"></i> Restore Data</span></div>
                
                <div class="menu-item dark-mode-btn" onclick="toggleDarkMode()"><span class="menu-label"><i class="fas fa-moon" id="darkModeIcon"></i> <span id="darkModeText">Dark Mode</span></span></div>
                <div class="menu-item notebook-btn" onclick="toggleNotebookTheme()" style="color:#2ecc71"><span class="menu-label"><i class="fas fa-book-open"></i> <span id="notebookText">Notebook</span></span></div>
                
                <!-- LOGOUT BUTTON -->
                <div class="menu-item logout-btn" onclick="logout()">
                    <span class="menu-label"><i class="fas fa-sign-out-alt"></i> Logout</span>
                </div>
            </div>

            <div class="entry-list" id="entryList"></div>
            <div class="sidebar-footer" style="padding:10px; font-size:10px; text-align:center; opacity:0.5;">Ver 2.0 Pro</div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="header">
                <div><i class="fas fa-bars" onclick="toggleSidebar()"></i></div>
                <div class="logo" id="uiBrandName">Rasel</div>
                <div style="font-size: 12px; display:flex; align-items:center; gap:5px;">
                    <i class="fas fa-user-circle"></i> <span id="uiOwnerName">USER</span>
                </div>
            </div>

            <div class="paper-area">
                <div class="paper">
                    <div class="blue-icon"><i class="fas fa-pen-nib"></i></div>

                    <div class="save-bar">
                        <span class="action-link" onclick="savePortableHtml()"><i class="fas fa-file-export"></i> Save Backup</span>
                        <span class="status-msg" id="saveStatus">Synced</span>
                    </div>

                    <div class="date-banner" onclick="document.getElementById('datePicker').showPicker()">
                        <div class="date-left">
                            <span class="date-day" id="bannerDay">DAY</span>
                            <span class="date-full" id="bannerDate">Date</span>
                        </div>
                        <i class="far fa-calendar-alt date-icon" style="font-size:24px; opacity:0.8;"></i>
                        <input type="date" id="datePicker" onchange="changeDate(this)">
                    </div>

                    <input type="text" id="entryTitle" class="entry-title" placeholder="Entry Title..." oninput="handleInput()">
                    
                    <div class="meta-row">
                        <select id="folderSelect" class="folder-select" onchange="handleInput()">
                            <option value="General">üìÇ General</option>
                            <option value="Work">üíº Work</option>
                            <option value="Personal">üè† Personal</option>
                            <option value="Secret">üîí Secret</option>
                        </select>
                        
                        <div class="word-count" id="wordCount">0 words</div>

                        <div class="toolbar">
                            <i class="far fa-smile" title="Mood">
                                <div class="popup-menu">
                                    <span class="tool-btn" onclick="setMood('üòä')">üòä</span>
                                    <span class="tool-btn" onclick="setMood('üòî')">üòî</span>
                                    <span class="tool-btn" onclick="setMood('üò°')">üò°</span>
                                    <span class="tool-btn" onclick="setMood('üòé')">üòé</span>
                                    <span class="tool-btn" onclick="setMood('ü§î')">ü§î</span>
                                </div>
                            </i>
                            <span id="currentMoodDisplay" style="margin-right:5px; font-size:16px;"></span>
                            <i class="fas fa-microphone" title="Record Audio" onclick="toggleRecording()" id="micBtn"></i>
                            <i class="fas fa-paint-brush" title="Draw" onclick="openDrawing()"></i>
                            <i class="fas fa-tag" title="Tag" onclick="addTagPrompt()"></i>
                            <span id="tagsDisplay" class="tags-display" style="font-size:11px; color:#2389d7;"></span>
                            <i class="fas fa-image" title="Insert Image" onclick="document.getElementById('imageUpload').click()"></i>
                            <i class="fas fa-font" title="Format">
                                <div class="popup-menu">
                                    <span class="tool-btn" onclick="formatDoc('bold')"><b>B</b></span>
                                    <span class="tool-btn" onclick="formatDoc('italic')"><i>I</i></span>
                                    <span class="tool-btn" onclick="formatDoc('underline')"><u>U</u></span>
                                </div>
                            </i>
                        </div>
                    </div>

                    <div class="editor-container">
                        <div class="text-area-wrapper">
                            <div id="audioContainer"></div>
                            <div id="entryBody" class="entry-body" contenteditable="true" placeholder="Start writing your thoughts..." oninput="handleInput()"></div>
                        </div>
                        <div class="image-sidebar-wrapper" ondragover="event.preventDefault()" ondrop="dropImage(event)">
                            <div class="image-sidebar-title"><i class="fas fa-images"></i> Attachments</div>
                            <div class="add-image-btn" onclick="document.getElementById('imageUpload').click()">
                                <i class="fas fa-plus"></i> Add Image
                            </div>
                            <div id="imageGalleryBox"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div id="toastContainer"></div>

    <!-- NEW PDF EXPORT OVERLAY -->
    <div id="pdf-export-overlay">
        <div class="loading-text"><i class="fas fa-spinner fa-spin"></i> Generating Protected PDF... Please Wait</div>
        <div id="pdf-content-container"></div>
    </div>

    <!-- Modals & Hidden Inputs -->
    <input type="file" id="imageUpload" accept="image/*" style="display: none;" onchange="insertImage(this)">
    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(this)">

    <!-- SCHEDULE MODAL -->
    <div id="scheduleModal" class="modal-overlay">
        <div class="modal-box" style="width:850px;">
            <div class="modal-header"><span><i class="fas fa-calendar-day"></i> Daily Schedule</span><span class="modal-close" onclick="closeSchedule()">&times;</span></div>
            <div class="modal-body">
                <div style="margin-bottom:20px; font-weight:bold; border-bottom:1px solid #eee; padding-bottom:10px;">
                    Date: <input type="text" id="schedDate" style="border:none; font-weight:bold; color:#3498db; outline:none;" readonly>
                </div>
                <div class="schedule-grid">
                    <div style="flex:1; border-right:1px solid #eee; padding-right:15px;">
                        <h4 style="background:#e3f2fd; padding:8px; text-align:center; border-radius:4px; margin-bottom:15px; color:#1976d2;">Hourly Tasks</h4>
                        <div id="timeSlotsContainer"></div>
                    </div>
                    <div style="flex:1; padding-left:15px;">
                        <h4 style="background:#fff3e0; padding:8px; text-align:center; border-radius:4px; margin-bottom:15px; color:#f57c00;">Top Priorities</h4>
                        <div id="todoContainer"></div>
                        <h4 style="background:#f3e5f5; padding:8px; text-align:center; border-radius:4px; margin-top:20px; margin-bottom:10px; color:#7b1fa2;">Memo / Notes</h4>
                        <textarea class="notes-area" style="width:100%; height:120px; background:#fafafa; border:1px solid #ddd; padding:10px; border-radius:4px; resize:none;"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="saveScheduleData()">Save Schedule</button></div>
        </div>
    </div>

    <!-- RAMADAN CHECKLIST MODAL -->
    <div id="ramadanModal" class="modal-overlay">
        <div class="modal-box" style="width:95%; max-width:1200px; height:90vh; display:flex; flex-direction:column;">
             <div class="modal-header"><span><i class="fas fa-moon"></i> Ramadan Checklist</span><span class="modal-close" onclick="closeRamadanChecklist()">&times;</span></div>
             <div class="modal-body" style="overflow:auto; flex:1; background-color:#f8f9fa;">
                <div class="ramadan-header">‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶¶‡¶æ‡¶∞‡ßÅ‡¶≤ ‡¶ï‡¶ø‡¶∞‡¶æ'‡¶Ü‡¶§ - ‡¶∞‡¶æ‡¶Æ‡¶æ‡¶¶‡¶æ‡¶® ‡¶ö‡ßá‡¶ï‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</div>
                <div id="ramadanTableContainer"></div>
             </div>
             <div class="modal-footer"><button class="btn btn-primary" onclick="saveRamadanData()">Save Progress</button></div>
        </div>
    </div>
    
    <!-- RAMADAN CALENDAR MODAL -->
    <div id="ramadanCalendarModal" class="modal-overlay">
        <div class="modal-box" style="width:700px; max-width:95%; height:90vh; display:flex; flex-direction:column;">
             <div class="modal-header"><span><i class="far fa-calendar-alt"></i> ‡¶∏‡¶æ‡¶π‡¶∞‡ßÄ-‡¶á‡¶´‡¶§‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º‡¶∏‡ßÇ‡¶ö‡¶ø (‡¶¢‡¶æ‡¶ï‡¶æ ‡¶ú‡ßá‡¶≤‡¶æ ‡ß®‡ß¶‡ß®‡ß¨)</span><span class="modal-close" onclick="closeRamadanCalendar()">&times;</span></div>
             <div class="modal-body" style="overflow:auto; flex:1; background-color:#fff;">
                <div style="text-align:center; margin-bottom:15px; font-weight:bold; font-family:'Hind Siliguri', sans-serif;">‡¶™‡¶¨‡¶ø‡¶§‡ßç‡¶∞ ‡¶Æ‡¶æ‡¶π‡ßá ‡¶∞‡¶Æ‡¶Ø‡¶æ‡¶® ‡ßß‡ß™‡ß™‡ß≠ ‡¶π‡¶ø‡¶ú‡¶∞‡ßÄ, ‡ß®‡ß¶‡ß®‡ß¨ ‡¶ñ‡ßç‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶¨‡ßç‡¶¶</div>
                <div id="ramadanCalendarTableContainer"></div>
             </div>
             <div class="modal-footer"><button class="btn" style="background:#888;" onclick="closeRamadanCalendar()">Close</button></div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header"><span><i class="fas fa-cog"></i> Settings</span><span class="modal-close" onclick="closeSettings()">&times;</span></div>
            <div class="modal-body">
                <div class="form-group"><label style="font-weight:600; font-size:13px; color:#555;">Journal Name</label><input type="text" id="setJournalName" class="form-input"></div>
                <div class="form-group"><label style="font-weight:600; font-size:13px; color:#555;">Owner Name</label><input type="text" id="setOwnerName" class="form-input"></div>
                <div class="form-group">
                    <label style="font-weight:600; font-size:13px; color:#555;">Change Password</label>
                    <input type="password" id="setPass" class="form-input" placeholder="New Password">
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="saveSettings()">Save Changes</button></div>
        </div>
    </div>

    <!-- DRAWING MODAL -->
    <div id="drawingModal" class="modal-overlay">
        <div class="modal-box" style="width:600px;">
            <div class="modal-header"><span><i class="fas fa-paint-brush"></i> Canvas</span><span class="modal-close" onclick="closeDrawing()">&times;</span></div>
            <div class="modal-body">
                <canvas id="drawingCanvas" width="500" height="300"></canvas>
                <div style="margin-top:10px; display:flex; align-items:center; gap:10px;">
                    <button class="btn" style="background:#e74c3c;" onclick="clearCanvas()">Clear</button>
                    <label>Color: <input type="color" id="penColor" value="#000000" style="cursor:pointer;"></label>
                </div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="saveDrawing()">Insert Drawing</button></div>
        </div>
    </div>

    <!-- IMAGE PREVIEW MODAL -->
    <div id="imagePreviewModal" class="modal-overlay" onclick="closeImagePreview(event)">
        <div class="close-preview-btn" onclick="closeImagePreview(event, true)">&times;</div>
        <div class="modal-box" style="background:transparent; box-shadow:none; padding:0;">
            <img id="previewImageElem" src="" alt="Preview">
        </div>
    </div>

    <script>
        /*__BAKED_DATA_START__*/ window.bakedData = null; /*__BAKED_DATA_END__*/

        // --- GLOBAL STATE ---
        let appSettings = { 
            journalName: 'MY JOURNAL', 
            brandName: 'penzu', 
            ownerName: 'RASEL', 
            darkMode: false, 
            notebookMode: false, 
            password: '',
            isSetupDone: false 
        };
        let entries = [];
        let currentId = null;
        let currentMood = "";
        let currentTags = [];
        let currentDateStr = "";
        let mediaRecorder;
        let audioChunks = [];
        let currentFilter = 'all'; // Global tracking of current folder

        // --- INIT ---
        window.onload = function() {
            // Load Settings from LocalStorage
            const savedSettings = localStorage.getItem('myDiarySettings');
            if (savedSettings) {
                appSettings = JSON.parse(savedSettings);
            }

            // Check Authentication Status
            checkAuth();
        };

        // --- AUTHENTICATION LOGIC ---
        function checkAuth() {
            const authScreen = document.getElementById('authScreen');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const appInterface = document.getElementById('appInterface');

            if (!appSettings.isSetupDone) {
                // First time user
                authScreen.style.display = 'flex';
                signupForm.style.display = 'block';
                loginForm.style.display = 'none';
                appInterface.style.display = 'none';
            } else {
                // Returning user
                if (localStorage.getItem('isLoggedIn') === 'true') {
                    // Already logged in this session
                    authScreen.style.display = 'none';
                    appInterface.style.display = 'flex';
                    initApp();
                } else {
                    // Needs login
                    authScreen.style.display = 'flex';
                    signupForm.style.display = 'none';
                    loginForm.style.display = 'block';
                    appInterface.style.display = 'none';
                    document.getElementById('welcomeName').innerText = `Hi, ${appSettings.ownerName}`;
                }
            }
        }

        function performSignup() {
            const name = document.getElementById('signupName').value;
            const pass = document.getElementById('signupPass').value;
            
            if(name && pass) {
                appSettings.ownerName = name;
                appSettings.password = pass;
                appSettings.isSetupDone = true;
                localStorage.setItem('myDiarySettings', JSON.stringify(appSettings));
                
                // Login immediately without reload
                localStorage.setItem('isLoggedIn', 'true');
                
                // Hide Auth, Show App
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('appInterface').style.display = 'flex';
                
                // Init App
                initApp();
                showToast(`Welcome ${name}! Your diary is ready.`, 'success');
            } else {
                document.getElementById('signupError').innerText = "Please fill in all fields.";
            }
        }

        function performLogin() {
            const pass = document.getElementById('loginPass').value;
            if(pass === appSettings.password) {
                localStorage.setItem('isLoggedIn', 'true');
                checkAuth(); // Re-run check to show app
            } else {
                document.getElementById('loginError').innerText = "Incorrect Password!";
            }
        }

        function logout() {
            localStorage.removeItem('isLoggedIn');
            location.reload(); // Go back to login screen
        }

        // --- APP INITIALIZATION ---
        function initApp() {
            // Apply Visual Settings
            applySettings();
            if(appSettings.darkMode) document.body.classList.add('dark-theme');
            if(appSettings.notebookMode) document.body.classList.add('notebook-theme');

            updateDateDisplay(new Date());
            
            // Load Entries
            if (window.bakedData && Array.isArray(window.bakedData) && window.bakedData.length > 0) {
                entries = window.bakedData;
                localStorage.setItem('myDiaryEntries', JSON.stringify(entries));
            } else {
                const savedData = localStorage.getItem('myDiaryEntries');
                if (savedData) entries = JSON.parse(savedData);
            }
            
            calculateStreak();
            updateSidebarCounts(); // Initial counts
            renderSidebar();

            // Auto-open today's entry if exists, otherwise start new
            const todayStr = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const todayEntry = entries.find(e => e.date === todayStr);

            if (todayEntry) {
                loadEntry(todayEntry.id);
            } else {
                createNewEntry();
            }

            initSchedule();
            initRamadan();
        }

        // --- STREAK CALC ---
        function calculateStreak() {
            const dates = entries.map(e => new Date(e.date).toDateString());
            let streak = 0;
            let checkDate = new Date();
            if(dates.includes(checkDate.toDateString())) streak++;
            for(let i=1; i<365; i++) {
                checkDate.setDate(checkDate.getDate() - 1);
                if(dates.includes(checkDate.toDateString())) streak++; else break;
            }
            document.getElementById('streakCount').innerText = streak;
        }

        function updateSidebarCounts() {
            const counts = { all: entries.length, work: 0, personal: 0, secret: 0 };
            entries.forEach(e => {
                if(e.folder === 'Work') counts.work++;
                if(e.folder === 'Personal') counts.personal++;
                if(e.folder === 'Secret') counts.secret++;
            });
            document.getElementById('count-all').innerText = counts.all;
            document.getElementById('count-work').innerText = counts.work;
            document.getElementById('count-personal').innerText = counts.personal;
            document.getElementById('count-secret').innerText = counts.secret;
        }

        // --- CORE FUNCTIONALITY ---
        function toggleSidebar() { document.body.classList.toggle('hide-sidebar'); }
        
        function handleInput() {
            const title = document.getElementById('entryTitle').value;
            const body = document.getElementById('entryBody').innerHTML;
            const folder = document.getElementById('folderSelect').value;
            const audios = Array.from(document.querySelectorAll('#audioContainer audio')).map(a => a.src);
            const wordCount = body.trim().split(/\s+/).filter(w => w.length > 0).length;
            document.getElementById('wordCount').innerText = `${wordCount} words`;
            
            if (!currentId) {
                currentId = Date.now();
                entries.unshift({ id: currentId, title, body, date: currentDateStr, images: [], mood: currentMood, tags: currentTags, folder, audios });
            } else {
                const index = entries.findIndex(e => e.id === currentId);
                if (index !== -1) {
                    entries[index].title = title;
                    entries[index].body = body;
                    entries[index].folder = folder;
                    entries[index].audios = audios;
                    // Sort by last modified - move to top
                    const item = entries.splice(index, 1)[0];
                    entries.unshift(item);
                }
            }
            saveData();
        }

        function saveData() {
            localStorage.setItem('myDiaryEntries', JSON.stringify(entries));
            document.getElementById('saveStatus').innerText = "Saved";
            setTimeout(() => document.getElementById('saveStatus').innerText = "Synced", 2000);
            updateSidebarCounts();
            renderSidebar();
        }

        // MAKE DELETE ENTRY GLOBAL TO ENSURE IT WORKS FROM HTML
        window.deleteEntry = function(e, id) {
            e.stopPropagation(); // Prevent loading the entry
            if(confirm("Are you sure you want to delete this entry?")) {
                const index = entries.findIndex(ent => ent.id === id);
                if(index > -1) {
                    entries.splice(index, 1);
                    localStorage.setItem('myDiaryEntries', JSON.stringify(entries));
                    updateSidebarCounts();
                    
                    if(currentId === id) {
                        createNewEntry(); // If deleted currently open one
                    } else {
                        renderSidebar(); // Re-render sidebar to reflect changes
                    }
                    showToast("Entry deleted successfully", "success");
                }
            }
        };

        function renderSidebar() { filterFolder(currentFilter, true); }
        
        function filterFolder(folder, skipSecurity) {
            // Security Check for Secret Folder
            if(folder === 'Secret' && !skipSecurity) {
                const pass = prompt("Enter password to access Secret folder:");
                if(pass !== appSettings.password) {
                    showToast("Access Denied! Wrong password.", "error");
                    return; // Stop if password wrong
                }
            }

            currentFilter = folder; // Update global state
            const list = document.getElementById('entryList');
            list.innerHTML = '';
            
            // Update Active Menu State
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
            let activeId = 'menu-all';
            if(folder === 'Work') activeId = 'menu-work';
            if(folder === 'Personal') activeId = 'menu-personal';
            if(folder === 'Secret') activeId = 'menu-secret';
            const activeEl = document.getElementById(activeId);
            if(activeEl) activeEl.classList.add('active');

            let hasEntries = false;
            entries.forEach(entry => {
                if(folder === 'all' || entry.folder === folder) {
                    hasEntries = true;
                    const div = document.createElement('div');
                    div.className = `saved-entry ${entry.id === currentId ? 'active' : ''}`;
                    div.onclick = () => loadEntry(entry.id);
                    const tagHtml = entry.folder ? `<span style="font-size:10px; opacity:0.7; border:1px solid #777; padding:1px 4px; border-radius:3px; margin-right:5px;">${entry.folder}</span>` : '';
                    div.innerHTML = `
                        <h4>${entry.title || '(Untitled)'}</h4>
                        <p>${tagHtml}${entry.date}</p>
                        <i class="fas fa-trash delete-entry-icon" onclick="window.deleteEntry(event, ${entry.id})" title="Delete"></i>
                    `;
                    list.appendChild(div);
                }
            });

            if(!hasEntries) {
                list.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-folder-open"></i>
                        <span>No entries in ${folder} folder.</span>
                    </div>`;
            }
        }

        function loadEntry(id) {
            currentId = id;
            const entry = entries.find(e => e.id === id);
            if (entry) {
                document.getElementById('entryTitle').value = entry.title;
                document.getElementById('entryBody').innerHTML = entry.body;
                document.getElementById('folderSelect').value = entry.folder || 'General';
                
                const audioBox = document.getElementById('audioContainer');
                audioBox.innerHTML = '';
                if(entry.audios) {
                    entry.audios.forEach(src => {
                        const div = document.createElement('div');
                        div.className = 'audio-player';
                        div.innerHTML = `<audio controls src="${src}"></audio><i class="fas fa-trash" onclick="this.parentElement.remove(); handleInput()" style="cursor:pointer; color:red;"></i>`;
                        audioBox.appendChild(div);
                    });
                }

                currentDateStr = entry.date;
                updateDateDisplay(new Date(currentDateStr));
                
                const gallery = document.getElementById('imageGalleryBox');
                gallery.innerHTML = '';
                if(entry.images) entry.images.forEach((img, i) => addImageToSidebarDOM(img, i));

                renderSidebar();
                document.getElementById('saveStatus').innerText = "Loaded";
                // Calculate words
                const wordCount = entry.body.trim().split(/\s+/).filter(w => w.length > 0).length;
                document.getElementById('wordCount').innerText = `${wordCount} words`;
            }
        }

        function createNewEntry() {
            currentId = null;
            document.getElementById('entryTitle').value = "";
            document.getElementById('entryBody').innerHTML = "";
            document.getElementById('audioContainer').innerHTML = "";
            document.getElementById('imageGalleryBox').innerHTML = "";
            document.getElementById('wordCount').innerText = "0 words";
            
            // Smart Context: Set folder based on current filter
            if (currentFilter !== 'all') {
                document.getElementById('folderSelect').value = currentFilter;
            } else {
                document.getElementById('folderSelect').value = 'General';
            }

            updateDateDisplay(new Date());
            renderSidebar();
        }

        function updateDateDisplay(dateObj) {
            const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('bannerDay').innerText = dateObj.toLocaleDateString('en-US', {weekday:'long'});
            document.getElementById('bannerDate').innerText = dateStr;
            currentDateStr = dateStr;
            const yyyy = dateObj.getFullYear();
            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
            const dd = String(dateObj.getDate()).padStart(2, '0');
            document.getElementById('datePicker').value = `${yyyy}-${mm}-${dd}`;
        }
        function changeDate(input) {
            if (!input.value) return;
            const parts = input.value.split('-');
            updateDateDisplay(new Date(parts[0], parts[1]-1, parts[2]));
            handleInput();
        }

        // --- MEDIA & TOOLS ---
        async function toggleRecording() {
            const btn = document.getElementById('micBtn');
            if(btn.style.color === 'red') {
                mediaRecorder.stop();
                btn.style.color = '';
            } else {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    btn.style.color = 'red';
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = () => {
                        const blob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = () => {
                            const container = document.getElementById('audioContainer');
                            const div = document.createElement('div');
                            div.className = 'audio-player';
                            div.innerHTML = `<audio controls src="${reader.result}"></audio><i class="fas fa-trash" onclick="this.parentElement.remove(); handleInput()" style="cursor:pointer; color:red;"></i>`;
                            container.appendChild(div);
                            handleInput();
                        };
                    };
                } catch(e) { showToast("Microphone access denied!", "error"); }
            }
        }

        function openDrawing() {
            document.getElementById('drawingModal').style.display = 'flex';
            const canvas = document.getElementById('drawingCanvas');
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "white"; ctx.fillRect(0,0,canvas.width, canvas.height);
            let painting = false;
            
            function start(e) { painting = true; draw(e); }
            function end() { painting = false; ctx.beginPath(); }
            function draw(e) {
                if(!painting) return;
                ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = document.getElementById('penColor').value;
                const rect = canvas.getBoundingClientRect();
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                ctx.stroke(); ctx.beginPath(); ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            }
            canvas.onmousedown = start; canvas.onmouseup = end; canvas.onmousemove = draw;
        }
        function closeDrawing() { document.getElementById('drawingModal').style.display = 'none'; }
        function clearCanvas() { const c = document.getElementById('drawingCanvas'); const x = c.getContext('2d'); x.clearRect(0,0,c.width,c.height); x.fillStyle="white"; x.fillRect(0,0,c.width,c.height); }
        function saveDrawing() {
            const dataUrl = document.getElementById('drawingCanvas').toDataURL();
            const img = document.createElement('img'); img.src = dataUrl; img.style.maxWidth = "100%"; img.style.border = "1px solid #ccc";
            document.getElementById('entryBody').appendChild(img);
            document.getElementById('entryBody').appendChild(document.createElement('br'));
            handleInput(); closeDrawing();
        }

        function insertImage(input) {
            if(!input.files || !input.files[0]) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                if(!currentId) handleInput();
                const entry = entries.find(e => e.id === currentId);
                if(!entry.images) entry.images = [];
                entry.images.push(e.target.result);
                addImageToSidebarDOM(e.target.result, entry.images.length-1);
                handleInput();
                input.value = ''; // Reset input so same file can be selected again if needed
            };
            reader.readAsDataURL(input.files[0]);
        }
        
        function dropImage(e) {
            e.preventDefault();
            if(e.dataTransfer.files && e.dataTransfer.files[0]) {
                 const reader = new FileReader();
                 reader.onload = function(evt) {
                    if(!currentId) handleInput();
                    const entry = entries.find(e => e.id === currentId);
                    if(!entry.images) entry.images = [];
                    entry.images.push(evt.target.result);
                    addImageToSidebarDOM(evt.target.result, entry.images.length-1);
                    handleInput();
                 };
                 reader.readAsDataURL(e.dataTransfer.files[0]);
            }
        }

        function addImageToSidebarDOM(src, i) {
            const div = document.createElement('div');
            div.className = 'img-preview-box';
            div.onclick = () => openImagePreview(src);
            div.innerHTML = `<img src="${src}"><div class="img-delete" onclick="event.stopPropagation(); removeImage(${i})">x</div>`;
            document.getElementById('imageGalleryBox').appendChild(div);
        }
        function removeImage(i) {
            const entry = entries.find(e => e.id === currentId);
            entry.images.splice(i, 1);
            loadEntry(currentId);
            handleInput();
        }
        
        function openImagePreview(src) {
            document.getElementById('previewImageElem').src = src;
            document.getElementById('imagePreviewModal').style.display = 'flex';
        }
        
        function closeImagePreview(e, force) {
            if (force || e.target.id === 'imagePreviewModal') {
                document.getElementById('imagePreviewModal').style.display = 'none';
            }
        }

        // --- SCHEDULE ---
        function initSchedule() {
            const times = ["08:00 AM", "09:00 AM", "10:00 AM", "11:00 AM", "12:00 PM", "01:00 PM", "02:00 PM", "03:00 PM", "04:00 PM", "05:00 PM", "06:00 PM"];
            let html = '';
            times.forEach(t => {
                html += `<div class="sched-row"><span class="sched-time">${t}</span><input type="checkbox" class="sched-check"><input class="sched-input"></div>`;
            });
            document.getElementById('timeSlotsContainer').innerHTML = html;
            let todoHtml = '';
            for(let i=0; i<5; i++) { todoHtml += `<div class="sched-row"><input type="checkbox" class="sched-check"><input class="sched-input" placeholder="Task ${i+1}"></div>`; }
            document.getElementById('todoContainer').innerHTML = todoHtml;
        }
        function openSchedule() {
            const now = new Date();
            document.getElementById('schedDate').value = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const savedSched = JSON.parse(localStorage.getItem('myDiarySchedule') || '{}');
            const inputs = document.querySelectorAll('.sched-input');
            if(savedSched.inputs) inputs.forEach((inp, i) => inp.value = savedSched.inputs[i] || '');
            const checks = document.querySelectorAll('.sched-check');
            if(savedSched.checks) checks.forEach((chk, i) => chk.checked = savedSched.checks[i] || false);
            document.querySelector('.notes-area').value = savedSched.notes || '';
            document.getElementById('scheduleModal').style.display = 'flex';
        }
        function closeSchedule() { document.getElementById('scheduleModal').style.display = 'none'; }
        function saveScheduleData() {
            const data = {
                inputs: Array.from(document.querySelectorAll('.sched-input')).map(i => i.value),
                checks: Array.from(document.querySelectorAll('.sched-check')).map(i => i.checked),
                notes: document.querySelector('.notes-area').value
            };
            localStorage.setItem('myDiarySchedule', JSON.stringify(data));
            showToast("Schedule Saved!", "success");
            closeSchedule();
        }

        // --- RAMADAN CALENDAR DATA ---
        const ramadanCalendarData = [
            { day: 1, date: "‡ßß‡ßØ ‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø", sehri: "‡ß´:‡ßß‡ß®", fajr: "‡ß´:‡ßß‡ß´", iftar: "‡ß´:‡ß´‡ßÆ" },
            { day: 2, date: "‡ß®‡ß¶ ‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø", sehri: "‡ß´:‡ßß‡ßß", fajr: "‡ß´:‡ßß‡ß™", iftar: "‡ß´:‡ß´‡ßÆ" },
            { day: 3, date: "‡ß®‡ßß ‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø", sehri: "‡ß´:‡ßß‡ßß", fajr: "‡ß´:‡ßß‡ß™", iftar: "‡ß´:‡ß´‡ßØ" },
            { day: 4, date: "‡ß®‡ß® ‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø", sehri: "‡ß´:‡ßß‡ß¶", fajr: "‡ß´:‡ßß‡ß©", iftar: "‡ß´:‡ß´‡ßØ" },
            { day: 5, date: "‡ß®‡ß© ‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø", sehri: "‡ß´:‡ß¶‡ßØ", fajr: "‡ß´:‡ßß‡ß®", iftar: "‡ß¨:‡ß¶‡ß¶" },
            { day: 6, date: "‡ß®‡ß™ ‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø", sehri: "‡ß´:‡ß¶‡ßÆ", fajr: "‡ß´:‡ßß‡ßß", iftar: "‡ß¨:‡ß¶‡ß¶" },
            { day: 7, date: "‡ß®‡ß´ ‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø", sehri: "‡ß´:‡ß¶‡ßÆ", fajr: "‡ß´:‡ßß‡ßß", iftar: "‡ß¨:‡ß¶‡ßß" },
            { day: 8, date: "‡ß®‡ß¨ ‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø", sehri: "‡ß´:‡ß¶‡ß≠", fajr: "‡ß´:‡ßß‡ß¶", iftar: "‡ß¨:‡ß¶‡ßß" },
            { day: 9, date: "‡ß®‡ß≠ ‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø", sehri: "‡ß´:‡ß¶‡ß¨", fajr: "‡ß´:‡ß¶‡ßØ", iftar: "‡ß¨:‡ß¶‡ß®" },
            { day: 10, date: "‡ß®‡ßÆ ‡¶´‡ßá‡¶¨‡ßç‡¶∞‡ßÅ‡¶Ø‡¶º‡¶æ‡¶∞‡¶ø", sehri: "‡ß´:‡ß¶‡ß´", fajr: "‡ß´:‡ß¶‡ßÆ", iftar: "‡ß¨:‡ß¶‡ß®" },
            { day: 11, date: "‡ß¶‡ßß ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß´:‡ß¶‡ß™", fajr: "‡ß´:‡ß¶‡ßÆ", iftar: "‡ß¨:‡ß¶‡ß©" },
            { day: 12, date: "‡ß¶‡ß® ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß´:‡ß¶‡ß™", fajr: "‡ß´:‡ß¶‡ß≠", iftar: "‡ß¨:‡ß¶‡ß©" },
            { day: 13, date: "‡ß¶‡ß© ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß´:‡ß¶‡ß©", fajr: "‡ß´:‡ß¶‡ß¨", iftar: "‡ß¨:‡ß¶‡ß™" },
            { day: 14, date: "‡ß¶‡ß™ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß´:‡ß¶‡ß®", fajr: "‡ß´:‡ß¶‡ß´", iftar: "‡ß¨:‡ß¶‡ß™" },
            { day: 15, date: "‡ß¶‡ß´ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß´:‡ß¶‡ßß", fajr: "‡ß´:‡ß¶‡ß™", iftar: "‡ß¨:‡ß¶‡ß´" },
            { day: 16, date: "‡ß¶‡ß¨ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß´:‡ß¶‡ß¶", fajr: "‡ß´:‡ß¶‡ß©", iftar: "‡ß¨:‡ß¶‡ß´" },
            { day: 17, date: "‡ß¶‡ß≠ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß™:‡ß´‡ßØ", fajr: "‡ß´:‡ß¶‡ß®", iftar: "‡ß¨:‡ß¶‡ß¨" },
            { day: 18, date: "‡ß¶‡ßÆ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß™:‡ß´‡ßÆ", fajr: "‡ß´:‡ß¶‡ßß", iftar: "‡ß¨:‡ß¶‡ß¨" },
            { day: 19, date: "‡ß¶‡ßØ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß™:‡ß´‡ß≠", fajr: "‡ß´:‡ß¶‡ß¶", iftar: "‡ß¨:‡ß¶‡ß≠" },
            { day: 20, date: "‡ßß‡ß¶ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß™:‡ß´‡ß≠", fajr: "‡ß™:‡ß´‡ßØ", iftar: "‡ß¨:‡ß¶‡ß≠" },
            { day: 21, date: "‡ßß‡ßß ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß™:‡ß´‡ß¨", fajr: "‡ß™:‡ß´‡ßÆ", iftar: "‡ß¨:‡ß¶‡ß≠" },
            { day: 22, date: "‡ßß‡ß® ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß™:‡ß´‡ß´", fajr: "‡ß™:‡ß´‡ß≠", iftar: "‡ß¨:‡ß¶‡ßÆ" },
            { day: 23, date: "‡ßß‡ß© ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß™:‡ß´‡ß™", fajr: "‡ß™:‡ß´‡ß≠", iftar: "‡ß¨:‡ß¶‡ßÆ" },
            { day: 24, date: "‡ßß‡ß™ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß™:‡ß´‡ß©", fajr: "‡ß™:‡ß´‡ß¨", iftar: "‡ß¨:‡ß¶‡ßØ" },
            { day: 25, date: "‡ßß‡ß´ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß™:‡ß´‡ß®", fajr: "‡ß™:‡ß´‡ß´", iftar: "‡ß¨:‡ß¶‡ßØ" },
            { day: 26, date: "‡ßß‡ß¨ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß™:‡ß´‡ßß", fajr: "‡ß™:‡ß´‡ß™", iftar: "‡ß¨:‡ßß‡ß¶" },
            { day: 27, date: "‡ßß‡ß≠ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß™:‡ß´‡ß¶", fajr: "‡ß™:‡ß´‡ß©", iftar: "‡ß¨:‡ßß‡ß¶" },
            { day: 28, date: "‡ßß‡ßÆ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß™:‡ß™‡ßØ", fajr: "‡ß™:‡ß´‡ß®", iftar: "‡ß¨:‡ßß‡ß¶" },
            { day: 29, date: "‡ßß‡ßØ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß™:‡ß™‡ßÆ", fajr: "‡ß™:‡ß´‡ß¶", iftar: "‡ß¨:‡ßß‡ßß" },
            { day: 30, date: "‡ß®‡ß¶ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ö", sehri: "‡ß™:‡ß™‡ß≠", fajr: "‡ß™:‡ß™‡ßØ", iftar: "‡ß¨:‡ßß‡ßß" }
        ];

        function openRamadanCalendar() {
            const modal = document.getElementById('ramadanCalendarModal');
            const container = document.getElementById('ramadanCalendarTableContainer');
            modal.style.display = 'flex';
            
            let html = '<table class="calendar-table">';
            html += '<thead><tr><th>‡¶∞‡¶Æ‡¶Ø‡¶æ‡¶®</th><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶∏‡¶æ‡¶π‡¶∞‡ßÄ‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶∏‡¶Æ‡¶Ø‡¶º</th><th>‡¶´‡¶ú‡¶∞‡ßá‡¶∞ ‡¶Ü‡¶Ø‡¶æ‡¶®</th><th>‡¶á‡¶´‡¶§‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º</th></tr></thead><tbody>';
            
            ramadanCalendarData.forEach(row => {
                let rowClass = '';
                if(row.day === 1) rowClass = 'calendar-row-1';
                else if(row.day === 10) rowClass = 'calendar-row-10';
                else if(row.day === 20) rowClass = 'calendar-row-20';
                else if(row.day === 30) rowClass = 'calendar-row-30';
                
                html += `<tr class="${rowClass}">
                    <td>${toBanglaDigit(row.day)}</td>
                    <td>${row.date}</td>
                    <td>${row.sehri}</td>
                    <td>${row.fajr}</td>
                    <td>${row.iftar}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            html += '<div style="margin-top:10px; font-size:12px; font-weight:bold; color:#555;">‚òÖ‡ßß‡¶≤‡¶æ ‡¶∞‡¶Æ‡¶Ø‡¶æ‡¶® ‡¶ö‡¶æ‡¶Å‡¶¶ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶≠‡¶∞‡¶∂‡ßÄ‡¶≤‡•§</div>';
            
            container.innerHTML = html;
        }

        function closeRamadanCalendar() {
            document.getElementById('ramadanCalendarModal').style.display = 'none';
        }

        // --- RAMADAN CHECKLIST ---
        const ramadanTasks = [
            "‡ß´ ‡¶ì‡¶Ø‡¶º‡¶æ‡¶ï‡ßç‡¶§ ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú, ‡¶Æ‡¶ø‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶ï",
            "‡¶á‡¶∂‡¶∞‡¶æ‡¶ï‡ßá‡¶∞, ‡¶ö‡¶æ‡¶∂‡¶§‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú",
            "‡¶§‡¶æ‡¶∞‡¶æ‡¶¨‡¶ø‡¶π, ‡¶¨‡¶ø‡¶§‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú",
            "‡¶§‡¶æ‡¶π‡¶æ‡¶ú‡ßç‡¶ú‡ßÅ‡¶¶, ‡¶∏‡ßá‡¶π‡¶∞‡¶ø",
            "‡¶∏‡¶ï‡¶æ‡¶≤‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶∏‡¶®‡ßÅ‡¶® ‡¶Ü‡¶Æ‡¶≤",
            "‡¶∏‡¶®‡ßç‡¶ß‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶Æ‡¶æ‡¶∏‡¶®‡ßÅ‡¶® ‡¶Ü‡¶Æ‡¶≤",
            "‡¶ú‡¶æ‡¶π‡¶æ‡¶®‡ßç‡¶®‡¶æ‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡¶æ‡¶Å‡¶ö‡¶æ‡¶∞ ‡¶¶‡ßã‡¶Ø‡¶º‡¶æ",
            "‡¶á‡¶´‡¶§‡¶æ‡¶∞, ‡¶¶‡ßã‡¶Ø‡¶º‡¶æ",
            "‡¶¶‡¶æ‡¶®-‡¶∏‡¶æ‡¶¶‡¶æ‡¶ï‡¶æ‡¶π ‡¶ï‡¶∞‡ßá‡¶õ‡¶ø",
            "‡¶®‡¶ú‡¶∞‡ßá‡¶∞ ‡¶π‡ßá‡¶´‡¶æ‡¶ú‡¶§ ‡¶ï‡¶∞‡ßá‡¶õ‡¶ø",
            "‡¶Ø‡¶ø‡¶ï‡¶ø‡¶∞, ‡¶á‡¶∏‡ßç‡¶§‡ßá‡¶ó‡¶´‡¶æ‡¶∞, ‡¶¶‡ßÅ‡¶∞‡ßÇ‡¶¶ ‡¶™‡¶°‡¶º‡ßá‡¶õ‡¶ø",
            "‡ß© ‡¶Ü‡¶Ø‡¶º‡¶æ‡¶§ ‡¶Æ‡ßÅ‡¶ñ‡¶∏‡ßç‡¶§ ‡¶ï‡¶∞‡ßá‡¶õ‡¶ø",
            "‡ßß ‡¶™‡¶æ‡¶∞‡¶æ ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶™‡¶°‡¶º‡ßá‡¶õ‡¶ø",
            "‡ß®‡ß¶ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶¶‡ßç‡¶¨‡ßÄ‡¶®‡¶ø ‡¶ï‡¶ø‡¶§‡¶æ‡¶¨ ‡¶™‡¶°‡¶º‡ßá‡¶õ‡¶ø",
            "‡¶∏‡¶ï‡¶≤ ‡¶π‡¶æ‡¶∞‡¶æ‡¶Æ ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶ø‡¶ú‡ßá‡¶ï‡ßá ‡¶¨‡¶ø‡¶∞‡¶§ ‡¶∞‡ßá‡¶ñ‡ßá‡¶õ‡¶ø",
            "‡¶Ö‡¶π‡ßá‡¶§‡ßÅ‡¶ï ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶®‡¶∑‡ßç‡¶ü ‡¶ï‡¶∞‡¶ø‡¶®‡¶ø"
        ];
        
        const jumuahTasks = [
            "‡¶∏‡ßÇ‡¶∞‡¶æ ‡¶ï‡¶æ‡¶π‡¶æ‡¶´",
            "‡¶¶‡ßÅ‡¶∞‡ßÇ‡¶¶",
            "‡¶á‡¶∏‡ßç‡¶§‡ßá‡¶ó‡¶´‡¶æ‡¶∞, ‡¶¶‡ßã‡¶Ø‡¶º‡¶æ"
        ];

        function initRamadan() {
            // Nothing needed on init except maybe preload data
        }

        function openRamadanChecklist() {
            const modal = document.getElementById('ramadanModal');
            const container = document.getElementById('ramadanTableContainer');
            modal.style.display = 'flex';
            
            // Generate Table HTML
            let html = '<table class="ramadan-table">';
            
            // Header Row (Days 1-30)
            html += '<thead><tr><th style="min-width:250px;">‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶Ü‡¶Æ‡¶≤</th>';
            for(let i=1; i<=30; i++) {
                html += `<th>${toBanglaDigit(i)}</th>`;
            }
            html += '</tr></thead><tbody>';
            
            // Load saved data
            const savedData = JSON.parse(localStorage.getItem('ramadanData') || '{}');

            // Daily Tasks Rows
            ramadanTasks.forEach((task, index) => {
                html += `<tr><td>${task}</td>`;
                for(let d=1; d<=30; d++) {
                    const key = `d-${index}-${d}`;
                    const checked = savedData[key] ? 'checked' : '';
                    html += `<td><input type="checkbox" class="ramadan-checkbox" id="${key}" ${checked} onchange="updateDailyProgress(${d})"></td>`;
                }
                html += '</tr>';
            });

            // Progress Row (Dynamic Calculation)
            html += '<tr class="progress-row-header"><td class="progress-cell">‡¶´‡¶≤‡¶æ‡¶´‡¶≤ (%)</td>';
            for(let d=1; d<=30; d++) {
                // Calculate initial progress
                let completed = 0;
                ramadanTasks.forEach((_, tIndex) => {
                   if(savedData[`d-${tIndex}-${d}`]) completed++;
                });
                let pct = Math.round((completed / ramadanTasks.length) * 100);
                html += `<td class="progress-cell" id="prog-d-${d}">${pct}%</td>`;
            }
            html += '</tr>';


            // Jumuah Header
            html += '<tr><th style="text-align:left; background:#e8f4f8;">‡¶ú‡ßÅ‡¶Æ\'‡¶Ü‡¶∞ ‡¶Ü‡¶Æ‡¶≤</th>';
            for(let i=1; i<=4; i++) html += `<th>${toBanglaDigit(i)}</th>`; // Only 4 Fridays typically
            html += '<td colspan="26" style="background:#f9f9f9;"></td></tr>';

            // Jumuah Tasks
            jumuahTasks.forEach((task, index) => {
                html += `<tr><td>${task}</td>`;
                for(let f=1; f<=4; f++) {
                    const key = `j-${index}-${f}`;
                    const checked = savedData[key] ? 'checked' : '';
                    html += `<td><input type="checkbox" class="ramadan-checkbox" id="${key}" ${checked}></td>`;
                }
                html += '<td colspan="26" style="background:#f9f9f9;"></td></tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function updateDailyProgress(day) {
             let completed = 0;
             ramadanTasks.forEach((_, tIndex) => {
                 const el = document.getElementById(`d-${tIndex}-${day}`);
                 if(el && el.checked) completed++;
             });
             let pct = Math.round((completed / ramadanTasks.length) * 100);
             const progCell = document.getElementById(`prog-d-${day}`);
             if(progCell) {
                 progCell.innerText = `${pct}%`;
                 // Optional color coding
                 if(pct >= 80) progCell.style.color = '#27ae60'; // Green
                 else if(pct >= 50) progCell.style.color = '#d35400'; // Orange
                 else progCell.style.color = '#c0392b'; // Red
             }
        }

        function closeRamadanChecklist() {
            document.getElementById('ramadanModal').style.display = 'none';
        }

        function saveRamadanData() {
            const checkboxes = document.querySelectorAll('.ramadan-checkbox');
            const data = {};
            checkboxes.forEach(cb => {
                if(cb.checked) data[cb.id] = true;
            });
            localStorage.setItem('ramadanData', JSON.stringify(data));
            showToast("Ramadan Progress Saved! (‡¶Æ‡¶æ‡¶∂‡¶æ‡¶Ü‡¶≤‡ßç‡¶≤‡¶æ‡¶π)", "success");
            closeRamadanChecklist();
        }
        
        function toBanglaDigit(n) {
            const banglaDigits = ['‡ß¶','‡ßß','‡ß®','‡ß©','‡ß™','‡ß´','‡ß¨','‡ß≠','‡ßÆ','‡ßØ'];
            return n.toString().split('').map(c => banglaDigits[c] || c).join('');
        }

        // --- SETTINGS ---
        function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; document.getElementById('setJournalName').value = appSettings.journalName; document.getElementById('setOwnerName').value = appSettings.ownerName; document.getElementById('setPass').value = appSettings.password; }
        function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
        function saveSettings() {
            appSettings.journalName = document.getElementById('setJournalName').value;
            appSettings.ownerName = document.getElementById('setOwnerName').value;
            appSettings.password = document.getElementById('setPass').value;
            localStorage.setItem('myDiarySettings', JSON.stringify(appSettings));
            applySettings(); closeSettings();
            showToast("Settings Updated", "info");
        }
        function applySettings() {
            document.getElementById('uiJournalName').innerText = appSettings.journalName;
            document.getElementById('uiOwnerName').innerText = appSettings.ownerName;
        }
        function toggleDarkMode() {
            document.body.classList.toggle('dark-theme');
            appSettings.darkMode = document.body.classList.contains('dark-theme');
            const icon = document.getElementById('darkModeIcon');
            const text = document.getElementById('darkModeText');
            if(appSettings.darkMode) { icon.className = "fas fa-sun"; text.innerText = "Light Mode"; }
            else { icon.className = "fas fa-moon"; text.innerText = "Dark Mode"; }
            localStorage.setItem('myDiarySettings', JSON.stringify(appSettings));
        }
        function toggleNotebookTheme() {
            document.body.classList.toggle('notebook-theme');
            appSettings.notebookMode = document.body.classList.contains('notebook-theme');
            document.getElementById('notebookText').innerText = appSettings.notebookMode ? "Normal" : "Notebook";
            localStorage.setItem('myDiarySettings', JSON.stringify(appSettings));
        }

        // --- TOAST SYSTEM ---
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = 'info-circle';
            if(type === 'success') icon = 'check-circle';
            if(type === 'error') icon = 'exclamation-circle';
            
            toast.innerHTML = `<i class="fas fa-${icon}"></i> <span>${message}</span>`;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // --- UTILS ---
        function formatDoc(cmd, val) { document.execCommand(cmd, false, val); }
        function setMood(m) { currentMood = m; document.getElementById('currentMoodDisplay').innerText = m; handleInput(); }
        function addTagPrompt() { const t = prompt("Tag:"); if(t) { currentTags.push(t); document.getElementById('tagsDisplay').innerText = currentTags.join(', '); handleInput(); } }
        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(Array.isArray(data)) {
                        if(confirm("This will replace all current entries. Are you sure?")) {
                            entries = data; localStorage.setItem('myDiaryEntries', JSON.stringify(entries)); renderSidebar(); location.reload();
                        }
                    } else showToast("Invalid file format", "error");
                } catch(err) { showToast("Error reading file", "error"); }
            };
            reader.readAsText(file);
        }
        function savePortableHtml() {
            const html = "<!DOCTYPE html>\n" + document.documentElement.outerHTML.replace('window.bakedData = null', `window.bakedData = ${JSON.stringify(entries)}`);
            const blob = new Blob([html], {type: "text/html"});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Diary_Backup_${new Date().toISOString().slice(0,10)}.html`; a.click();
            showToast("Backup saved successfully", "success");
        }
        function saveToDrive() { savePortableHtml(); setTimeout(()=> window.open('https://drive.google.com'), 1000); }
        
        // UPDATED PDF EXPORT FUNCTION
        function exportPDF() {
            if(entries.length === 0) {
                showToast("No entries to export!", "error");
                return;
            }

            const overlay = document.getElementById('pdf-export-overlay');
            const container = document.getElementById('pdf-content-container');
            
            // Show the overlay
            overlay.style.display = 'flex';
            container.innerHTML = ''; // Clear previous

            // PDF Configuration
            const opt = {
                margin:       0,
                filename:     `Diary_Export_${new Date().toISOString().slice(0,10)}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 3, useCORS: true, scrollY: 0 },
                jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            // 1. ADD COVER PAGE
            const coverHtml = `
                <div style="
                    width: 100%; 
                    min-height: 1050px; 
                    background-color: #2c3e50; 
                    display: flex; 
                    flex-direction: column; 
                    align-items: center; 
                    justify-content: center; 
                    color: #f1c40f; 
                    font-family: 'Lora', serif; 
                    page-break-after: always; 
                    border: 20px solid #1a252f; 
                    box-sizing: border-box;
                ">
                    <div style="border: 2px solid #f1c40f; padding: 60px; text-align: center; max-width: 80%;">
                        <h1 style="font-size: 70px; margin: 0; text-transform: uppercase; letter-spacing: 5px; line-height: 1.2;">${appSettings.journalName}</h1>
                        <p style="font-size: 24px; margin-top: 20px; font-style: italic; color: #bdc3c7;">Private & Confidential</p>
                        
                        <div style="margin-top: 60px; border-top: 1px solid #f1c40f; width: 150px; margin-left: auto; margin-right: auto;"></div>
                        
                        <h3 style="font-size: 28px; margin-top: 40px; font-weight: normal; color: #ecf0f1;">Property of</h3>
                        <h2 style="font-size: 48px; margin: 15px 0; font-weight: bold; color: #fff;">${appSettings.ownerName}</h2>
                        
                        <div style="margin-top: 80px; font-size: 16px; color: #95a5a6;">Est. ${new Date().getFullYear()}</div>
                    </div>
                </div>
            `;
            container.innerHTML += coverHtml;

            // 2. ADD ENTRY PAGES
            entries.forEach(e => {
                // Parse date for fancy header
                const d = new Date(e.date);
                const day = d.getDate();
                const month = d.toLocaleString('default', { month: 'long' }).toUpperCase(); // Full month name
                const year = d.getFullYear();
                const weekday = d.toLocaleDateString('default', { weekday: 'long' });

                const pageHtml = `
                    <div style="
                        width: 100%; 
                        min-height: 1050px; 
                        background-color: #fdfcf0; 
                        padding: 50px; 
                        box-sizing: border-box; 
                        position: relative; 
                        font-family: 'Patrick Hand', cursive, sans-serif; 
                        color: #333;
                        page-break-after: always;
                        overflow: hidden;
                    ">
                        <!-- Date Header Fancy -->
                        <div style="
                            display: flex; 
                            justify-content: space-between; 
                            align-items: center; 
                            border-bottom: 3px double #8b4513; 
                            padding-bottom: 15px; 
                            margin-bottom: 30px;
                        ">
                            <div style="flex: 1; padding-right: 20px;">
                                <h1 style="font-family: 'Montserrat', sans-serif; font-size: 36px; color: #2c3e50; margin: 0; line-height: 1.3;">${e.title || 'Untitled Entry'}</h1>
                                <div style="font-size: 22px; color: #7f8c8d; margin-top: 8px; font-style: italic;">${weekday}</div>
                            </div>
                            
                            <div style="
                                text-align: center; 
                                border: 2px solid #2c3e50; 
                                padding: 15px 25px; 
                                border-radius: 10px; 
                                background: #fff;
                                min-width: 120px;
                                box-shadow: 4px 4px 0px rgba(0,0,0,0.15);
                            ">
                                <div style="font-size: 52px; font-weight: 800; color: #e74c3c; line-height: 1;">${day}</div>
                                <div style="font-size: 18px; text-transform: uppercase; font-weight: bold; color: #2c3e50; margin-top: 5px;">${month}</div>
                                <div style="font-size: 22px; font-weight: 600; color: #555; margin-top: 2px;">${year}</div>
                            </div>
                        </div>

                        <!-- Content Body with Lines -->
                        <div style="
                            font-size: 22px; 
                            line-height: 35px; 
                            /* Using linear-gradient with background-size for robust lines */
                            background-color: transparent;
                            background-image: linear-gradient(to bottom, transparent 34px, #94aab7 35px);
                            background-size: 100% 35px;
                            min-height: 800px;
                            color: #2c3e50;
                            padding-top: 0px; /* Changed from 6px to 0px to move text up */
                            margin-top: -4px; /* Added negative margin to pull it up slightly more */
                        ">
                            ${e.body}
                        </div>
                        
                        <!-- Footer -->
                        <div style="
                            position: absolute; 
                            bottom: 25px; 
                            left: 0; 
                            width: 100%; 
                            text-align: center; 
                            font-size: 14px; 
                            color: #aaa;
                            font-family: 'Lora', serif;
                        ">
                            ~ ${appSettings.journalName} ~
                        </div>
                    </div>
                `;
                
                container.innerHTML += pageHtml;
            });

            // Small delay to ensure rendering (fonts/icons)
            setTimeout(() => {
                html2pdf().set(opt).from(container).outputPdf('arraybuffer').then(async (pdfBuffer) => {
                    try {
                        // Safety Check: Ensure PDFLib is loaded
                        if (typeof PDFLib === 'undefined') {
                            throw new Error("PDF Library not loaded properly.");
                        }

                        const pdfDoc = await PDFLib.PDFDocument.load(pdfBuffer);
                        
                        const password = appSettings.password; 
                        
                        // Check if encrypt function is available
                        if (password) {
                            if (typeof pdfDoc.encrypt === 'function') {
                                pdfDoc.encrypt({
                                    userPassword: password,
                                    ownerPassword: password,
                                    permissions: {
                                        printing: 'highResolution',
                                        modifying: false,
                                        copying: false,
                                        annotating: false,
                                        fillingForms: false,
                                        contentAccessibility: false,
                                        documentAssembly: false,
                                    },
                                });
                            } else {
                                console.warn("Encrypt function missing in PDFLib");
                                showToast("Warning: Encryption not supported by current browser resource.", "info");
                            }
                        }

                        const pdfBytes = await pdfDoc.save();
                        
                        const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(blob);
                        link.download = `Diary_Export_${new Date().toISOString().slice(0,10)}_Protected.pdf`;
                        link.click();

                        overlay.style.display = 'none'; // Hide after save
                        showToast("Protected PDF Exported Successfully!", "success");

                    } catch (error) {
                        console.error("Encryption failed:", error);
                        // Fallback: Try downloading without password if encryption fails
                        try {
                             const blob = new Blob([pdfBuffer], { type: 'application/pdf' });
                             const link = document.createElement('a');
                             link.href = URL.createObjectURL(blob);
                             link.download = `Diary_Export_${new Date().toISOString().slice(0,10)}_Unprotected.pdf`;
                             link.click();
                             showToast("Saved without password (Encryption Error)", "info");
                        } catch(e) {
                             showToast("PDF Failed to Save", "error");
                        }
                        overlay.style.display = 'none';
                    }
                }).catch(err => {
                    console.error(err);
                    overlay.style.display = 'none';
                    showToast("PDF Generation Failed. Please try again.", "error");
                });
            }, 1000); // 1 second delay
        }

        // UPDATE FILTER ENTRIES TO INCLUDE DELETE BUTTON
        function filterEntries() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const list = document.getElementById('entryList');
            list.innerHTML = '';
            
            entries.forEach(entry => {
                if((entry.title||'').toLowerCase().includes(query) || (entry.body||'').toLowerCase().includes(query)) {
                    const div = document.createElement('div');
                    div.className = `saved-entry ${entry.id === currentId ? 'active' : ''}`;
                    div.onclick = () => loadEntry(entry.id);
                    const tagHtml = entry.folder ? `<span style="font-size:10px; opacity:0.7; border:1px solid #777; padding:1px 4px; border-radius:3px; margin-right:5px;">${entry.folder}</span>` : '';
                    div.innerHTML = `
                        <h4>${entry.title || '(No Title)'}</h4>
                        <p>${tagHtml}${entry.date}</p>
                        <i class="fas fa-trash delete-entry-icon" onclick="window.deleteEntry(event, ${entry.id})" title="Delete"></i>
                    `;
                    list.appendChild(div);
                }
            });
        }
    </script>
</body>
</html>